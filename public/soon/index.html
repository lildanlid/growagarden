<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grow a Garden Tracker | Live Stock & Weather</title>
  <meta name="description" content="Live tracker for Grow a Garden." />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* (kept your existing styles; truncated for brevity in this answer) */
    :root{--dark-bg:#2E5953;--dark-text:#F2D8C9;--accent-terracotta:#D98361}
    html.dark body{background:var(--dark-bg);color:var(--dark-text)}
    body{font-family:Nunito, sans-serif}
    .shop-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1.5rem}
    .item-card{border-radius:12px;padding:16px;background:rgba(255,255,255,0.03)}
    .item-card.out-of-stock{opacity:0.6;filter:grayscale(80%)}
    .image-placeholder{width:96px;height:96px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.03);border-radius:8px;color:rgba(255,255,255,0.6);font-size:0.85rem}
    .watch-button.active .star-icon{color:#facc15}
  </style>
</head>
<body>
  <div id="weather-bg-container"></div>
  <div id="loading-overlay" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:50">
    <div style="text-align:center;color:#ddd">
      <div style="width:80px;height:80px;margin:0 auto;border-radius:50%;background:#a16207"></div>
      <div style="margin-top:12px">Planting the seeds of data...</div>
    </div>
  </div>

  <div style="max-width:1100px;margin:32px auto;padding:0 16px">
    <header style="display:flex;justify-content:space-between;align-items:center">
      <h1 class="font-header" style="font-size:28px">🌱 Grow a Garden Tracker</h1>
      <div style="display:flex;gap:8px">
        <button id="notification-bell" title="Notifications">🔔</button>
        <button id="theme-switcher" title="Toggle theme">🌓</button>
      </div>
    </header>

    <section id="market-street" style="margin-top:20px">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        <input id="search-bar" placeholder="Search for items..." style="flex:1;padding:8px;border-radius:999px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.04)" />
        <div style="display:flex;border-radius:999px;padding:4px;background:rgba(255,255,255,0.03)">
          <button id="display-instock" class="display-toggle active" style="padding:8px 12px;border-radius:999px">In Stock</button>
          <button id="display-catalog" class="display-toggle" style="padding:8px 12px;border-radius:999px">Full Catalog</button>
        </div>
      </div>
      <div id="shops-navigation" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px"></div>
    </section>

    <main id="shops-container" class="shop-grid"></main>

    <section id="dashboard" style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-top:24px">
      <div id="watchlist" class="section-container"></div>
      <div id="rare-item-spotlight" class="section-container"></div>
    </section>

    <footer style="margin-top:24px;text-align:center;color:rgba(255,255,255,0.6)">
      <div id="connection-status">Fetching data...</div>
    </footer>
  </div>

<script>
/* -------------------------
   All images use stock-apis only:
   http://stock-apis.vercel.app/i/growagarden/{lowercase_id_with_underscores}
   No JoshLei image usage.
   ------------------------- */

const SEEDS = ["Carrot","Strawberry","Blueberry","Tomato","Daffodil","Watermelon","Pumpkin","Apple","Bamboo","Coconut","Cactus","Dragon Fruit","Mango","Grape","Mushroom","Pepper","Cacao","Beanstalk","Ember lily","Sugar Apple","Burning Bud","Giant Pinecone","Elder Strawberry","Romanesco"];
const GEARS = ["Watering Can","Trowel","Recall Wrench","Basic Sprinkler","Advanced Sprinkler","Medium Toy","Medium Treat","Godly Sprinkler","Magnifying Glass","Master Sprinkler","Cleaning Spray","Cleansing Pet Shard","Favorite Tool","Harvest Tool","Friendship Pot","Grandmaster Sprinkler","Levelup Lolipop"];
const EGGS = ["Common Egg","Uncommon Egg","Rare Egg","Legendary Egg","Mythical Egg","Bug Egg"];

const STOCK_URL = 'https://stock-apis.vercel.app/api/growagarden/stocks';
const WEATHER_URL = 'https://api.joshlei.com/v2/growagarden/weather'; // weather still comes from joshlei
const STOCK_APIS_IMAGE_BASE = 'http://stock-apis.vercel.app/i/growagarden';

let currentStockData = {};
let watchlist = JSON.parse(localStorage.getItem('growagarden_watchlist') || '[]');
let activeFilter = 'all';
let showAllItems = false;
let searchTerm = '';
const iconResolveCache = {};

const $ = id => document.getElementById(id);

function safeHostIdFromDisplayName(displayName) {
  if (!displayName) return '';
  return displayName.replace(/\s+/g,'_'); // preserve original capitalization here; we'll lowercase when building URL
}
function hostIdLower(displayNameOrId) {
  if (!displayNameOrId) return '';
  return String(displayNameOrId).replace(/\s+/g,'_').toLowerCase();
}
function timeRemaining(unixEnd){
  if(!unixEnd) return '—';
  const diff = unixEnd - Math.floor(Date.now()/1000);
  if(diff<=0) return 'Restocked!';
  const h = Math.floor(diff/3600).toString().padStart(2,'0');
  const m = Math.floor((diff%3600)/60).toString().padStart(2,'0');
  const s = Math.floor(diff%60).toString().padStart(2,'0');
  return `${h}:${m}:${s}`;
}

async function fetchWithTimeout(url, opts={}, timeout=15000, asBlob=false){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeout);
  try{
    const res = await fetch(url, { signal: controller.signal, ...opts });
    clearTimeout(t);
    if(!res.ok) throw new Error('HTTP '+res.status);
    return asBlob ? await res.blob() : await res.json();
  }catch(e){ clearTimeout(t); return null; }
}

/* quick image existence probe: try HEAD, fallback to Image() */
async function urlExists(url){
  try{
    // HEAD can fail due to CORS on some servers; still attempt it first
    const head = await fetch(url, { method: 'HEAD' });
    if(head && head.ok) return true;
  }catch(e){}
  return new Promise(resolve=>{
    const img = new Image();
    let done=false;
    img.crossOrigin = 'anonymous';
    img.onload = ()=>{ if(!done){ done=true; resolve(true); } };
    img.onerror = ()=>{ if(!done){ done=true; resolve(false); } };
    img.src = url;
    setTimeout(()=>{ if(!done){ done=true; resolve(false); } }, 2500);
  });
}

/* Normalize incoming stock payload; purposely ignore any 'icon' field for image source */
function normalizeStockPayload(raw){
  if(!raw || typeof raw !== 'object') return {};
  const find = (...cands) => {
    for(const c of cands) if(Object.prototype.hasOwnProperty.call(raw,c)) return raw[c];
    const keys = Object.keys(raw);
    for(const c of cands){
      const needle = c.toLowerCase().replace(/\s+/g,'');
      const found = keys.find(k=>k.toLowerCase().replace(/\s+/g,'')===needle);
      if(found) return raw[found];
    }
    return null;
  };
  const out = {};
  out.seed_stock = find('seed_stock','Seeds Stock','Seeds','seeds') || [];
  out.gear_stock = find('gear_stock','Gear Stock','Gear','gears') || [];
  out.cosmetic_stock = find('cosmetic_stock','Cosmetics Stock','Cosmetics') || [];
  out.egg_stock = find('egg_stock','Egg Stock','Eggs') || [];
  out.eventshop_stock = find('eventshop_stock','Event Stock','Event') || [];
  out.travelingmerchant_stock = find('travelingmerchant_stock','Merchant Stock','Merchant') || [];

  function normList(arr){
    if(!Array.isArray(arr)){
      if(arr && Array.isArray(arr.stock)) arr = arr.stock;
      else return [];
    }
    return arr.map(it=>{
      const quantity = Number(it.quantity ?? it.stock ?? it.count ?? 0);
      // intentionally ignore returned icon/url from API to ensure we use stock-apis host only
      const icon = '';
      const rawName = it.display_name ?? it.displayName ?? it.name ?? '';
      const item_id = it.item_id ?? it.id ?? safeHostIdFromDisplayName(rawName);
      const display_name = rawName || '';
      const rarity = (it.rarity ?? it.rarity_name ?? it.rarityName ?? 'Common');
      const end_date_unix = it.end_date_unix ?? it.end_time_unix ?? it.ends_at ?? null;
      return { ...it, item_id, display_name, quantity, icon, rarity, end_date_unix };
    });
  }
  out.seed_stock = normList(out.seed_stock);
  out.gear_stock = normList(out.gear_stock);
  out.cosmetic_stock = normList(out.cosmetic_stock);
  out.egg_stock = normList(out.egg_stock);
  out.eventshop_stock = normList(out.eventshop_stock);
  out.travelingmerchant_stock = normList(out.travelingmerchant_stock);
  return out;
}

/* Resolve image URL from stock-apis only (lowercased id). Try base and .png */
async function resolveIconForItem(item){
  const raw = item.item_id || safeHostIdFromDisplayName(item.display_name || '');
  if(!raw) return null;
  const idLower = hostIdLower(raw);
  if(iconResolveCache[idLower] !== undefined) return iconResolveCache[idLower];
  iconResolveCache[idLower] = null; // reserve

  const base = `${STOCK_APIS_IMAGE_BASE}/${encodeURIComponent(idLower)}`;
  const png = `${base}.png`;

  try{
    if(await urlExists(base)){ iconResolveCache[idLower] = base; return base; }
    if(await urlExists(png)){ iconResolveCache[idLower] = png; return png; }
  }catch(e){}
  iconResolveCache[idLower] = null;
  return null;
}

/* Build card HTML and placeholders */
function starSvg(active){
  if(active) return `<svg class="star-icon" viewBox="0 0 24 24" width="20" height="20" fill="#facc15" xmlns="http://www.w3.org/2000/svg"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;
  return `<svg class="star-icon" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" xmlns="http://www.w3.org/2000/svg"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;
}

function itemCardHtml(item){
  const displayName = item.display_name || item.item_id || 'Unknown';
  const qty = Number(item.quantity || 0);
  const inStock = qty > 0;
  const rarity = item.rarity || 'Common';
  const isWatched = watchlist.some(w => w.id === item.item_id);
  const imgPlaceholder = `<div class="flex-grow flex items-center justify-center my-4">
    <div class="image-placeholder" data-img-for="${item.item_id}">Loading image...</div>
    <img data-img-for="${item.item_id}" alt="${displayName}" class="max-h-24" style="display:none" />
  </div>`;

  return `
    <div class="item-card ${!inStock ? 'out-of-stock' : ''}" data-item-id="${item.item_id}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div class="rarity-tag">${rarity}</div>
        <button class="watch-button ${isWatched ? 'active' : ''}" title="Toggle watch" data-id="${item.item_id}" data-name="${displayName}">
          ${starSvg(isWatched)}
        </button>
      </div>
      ${imgPlaceholder}
      <h3 style="text-align:center;font-weight:600">${displayName}</h3>
      <div style="margin-top:10px;border-top:1px solid rgba(255,255,255,0.04);padding-top:8px;font-size:0.95rem">
        <div style="display:flex;justify-content:space-between"><span>Stock:</span><span>${inStock ? qty : 'Out of Stock'}</span></div>
        <div style="display:flex;justify-content:space-between"><span>Restocks:</span><span class="timer" data-end-time="${item.end_date_unix ?? 0}">${timeRemaining(item.end_date_unix)}</span></div>
      </div>
    </div>`;
}

/* Replace placeholder with resolved image (stock-apis only) */
async function ensureItemImageRendered(item){
  const id = item.item_id || safeHostIdFromDisplayName(item.display_name || '');
  if(!id) return;
  const imgEl = document.querySelector(`img[data-img-for="${id}"]`);
  const phEl = document.querySelector(`.image-placeholder[data-img-for="${id}"]`);
  const resolved = await resolveIconForItem(item);
  if(!resolved){
    if(imgEl) imgEl.remove();
    if(phEl) phEl.textContent = 'Image not found';
    return;
  }
  if(imgEl) {
    imgEl.src = resolved;
    imgEl.style.display = '';
    imgEl.onload = ()=>{ if(phEl) phEl.remove(); };
    imgEl.onerror = ()=>{ imgEl.remove(); if(phEl) phEl.textContent = 'Image not found'; };
  } else if(phEl) {
    const img = document.createElement('img');
    img.dataset.imgFor = id;
    img.alt = item.display_name || id;
    img.className = 'max-h-24';
    img.src = resolved;
    img.onload = ()=> phEl.replaceWith(img);
    img.onerror = ()=> phEl.textContent = 'Image not found';
  }
}

/* Build full catalog ordering */
function idsFromList(namesArr){ return (namesArr||[]).map(n=>({ item_id: safeHostIdFromDisplayName(n), display_name: n })); }
const SEED_ORDER = idsFromList(SEEDS);
const GEAR_ORDER = idsFromList(GEARS);
const EGG_ORDER  = idsFromList(EGGS);

function buildFullCatalogForCategory(shopKey){
  const apiList = (currentStockData[shopKey]||[]).slice();
  const apiMap = new Map(apiList.map(it=>[ (it.display_name||it.item_id||'').toLowerCase().replace(/\s+/g,''), it ]));
  let orderArr = [];
  if(shopKey==='seed_stock') orderArr = SEED_ORDER;
  else if(shopKey==='gear_stock') orderArr = GEAR_ORDER;
  else if(shopKey==='egg_stock') orderArr = EGG_ORDER;
  const ordered=[];
  orderArr.forEach(({item_id,display_name})=>{
    const key = display_name.toLowerCase().replace(/\s+/g,'');
    const apiItem = apiMap.get(key);
    if(apiItem){ ordered.push({...apiItem, display_name: apiItem.display_name || display_name}); apiMap.delete(key);}
    else ordered.push({ item_id: item_id || safeHostIdFromDisplayName(display_name), display_name, quantity:0, icon:'', rarity:'Common', shop:shopKey });
  });
  for(const it of apiList) if(!orderArr.find(o=>o.display_name.toLowerCase().replace(/\s+/g,'') === (it.display_name||'').toLowerCase().replace(/\s+/g,''))) ordered.push(it);
  return ordered.map(x=>({...x, shop:shopKey}));
}

/* Rendering */
function renderFullCatalog(shopKey){
  const groups=[];
  if(shopKey==='all'){ groups.push({title:'Seeds', items: buildFullCatalogForCategory('seed_stock')}); groups.push({title:'Gear', items: buildFullCatalogForCategory('gear_stock')}); groups.push({title:'Pets', items: buildFullCatalogForCategory('egg_stock')}); }
  else { const title = shopKey==='seed_stock' ? 'Seeds' : shopKey==='gear_stock' ? 'Gear' : shopKey==='egg_stock' ? 'Pets' : shopKey; groups.push({title, items: buildFullCatalogForCategory(shopKey)}); }
  let out='';
  groups.forEach(g=>{
    out += `<div style="grid-column:1/-1"><h3 style="font-weight:700;margin-bottom:8px">${g.title} — Full Catalog</h3></div>`;
    out += g.items.map(item=> itemCardHtml(item) ).join('');
  });
  $('shops-container').innerHTML = out;
  groups.forEach(g=> g.items.forEach(it => setTimeout(()=>ensureItemImageRendered(it),0)));
}

function renderShops(){
  const hasAny = Object.values(currentStockData||{}).some(a=>Array.isArray(a) && a.length>0);
  if(!hasAny){ $('shops-container').innerHTML = `<p style="grid-column:1/-1;text-align:center;opacity:0.7">Loading shop data...</p>`; return;}
  if(showAllItems && activeFilter !== 'all'){ renderFullCatalog(activeFilter); return; }
  if(showAllItems && activeFilter === 'all'){ renderFullCatalog('all'); return; }

  const order = ['seed_stock','gear_stock','cosmetic_stock','egg_stock','eventshop_stock','travelingmerchant_stock'];
  const all=[];
  order.forEach(k => (currentStockData[k]||[]).forEach(it => all.push({...it, shop:k})));

  let filtered = all.filter(item=>{
    const name = (item.display_name || item.item_id || '').toLowerCase();
    const searchMatch = !searchTerm || name.includes(searchTerm.toLowerCase());
    const stockMatch = showAllItems || (Number(item.quantity||0) > 0);
    const shopMatch = activeFilter === 'all' || item.shop === activeFilter;
    return searchMatch && stockMatch && shopMatch;
  });

  // ordering for categories
  if(activeFilter==='seed_stock' || activeFilter==='gear_stock' || activeFilter==='egg_stock'){
    const orderArr = activeFilter==='seed_stock' ? SEED_ORDER : activeFilter==='gear_stock' ? GEAR_ORDER : EGG_ORDER;
    const idx = new Map(orderArr.map((o,i)=>[ (o.display_name||'').toLowerCase().replace(/\s+/g,''), i ]));
    filtered.sort((a,b)=>{
      const ia = idx.has((a.display_name||'').toLowerCase().replace(/\s+/g,'')) ? idx.get((a.display_name||'').toLowerCase().replace(/\s+/g,'')) : 9999;
      const ib = idx.has((b.display_name||'').toLowerCase().replace(/\s+/g,'')) ? idx.get((b.display_name||'').toLowerCase().replace(/\s+/g,'')) : 9999;
      if(ia!==ib) return ia-ib;
      return (b.quantity||0) - (a.quantity||0);
    });
  } else {
    filtered.sort((a,b)=> (a.shop !== b.shop) ? a.shop.localeCompare(b.shop) : (a.display_name||'').localeCompare(b.display_name||''));
  }

  if(!filtered.length){ $('shops-container').innerHTML = `<p style="grid-column:1/-1;text-align:center;opacity:0.7">No items match your filters.</p>`; return; }
  $('shops-container').innerHTML = filtered.map(it=>itemCardHtml(it)).join('');
  filtered.forEach(it => setTimeout(()=>ensureItemImageRendered(it),0));
}

/* Watchlist & notifications */
function saveWatchlist(){ localStorage.setItem('growagarden_watchlist', JSON.stringify(watchlist)); }
function findItemInStock(itemId){
  for(const k of Object.keys(currentStockData||{})){
    const arr = currentStockData[k] || [];
    const f = arr.find(it => (it.item_id === itemId || hostIdLower(it.item_id) === hostIdLower(itemId)) && Number(it.quantity||0) > 0);
    if(f) return f;
  }
  return null;
}
function toggleWatch(id,name){
  const idx = watchlist.findIndex(w=>w.id===id);
  const added = idx === -1;
  if(idx>-1) watchlist.splice(idx,1); else watchlist.push({ id,name });
  saveWatchlist();
  renderWatchlist();
  renderShops();
  if(added && Notification.permission === 'granted'){
    const inStock = findItemInStock(id);
    try{ new Notification('Watchlist updated', { body: inStock ? `${name} is in stock!` : `${name} added to watchlist.` }); }catch(e){}
  }
}
function renderWatchlist(){
  const out = [];
  out.push(`<h2 style="font-weight:700">Your Watchlist ⭐</h2>`);
  if(!watchlist.length){ out.push(`<p style="opacity:0.7">Click the star on an item to track it here!</p>`); $('watchlist').innerHTML = out.join(''); return; }
  watchlist.forEach(w=>{
    const stockItem = findItemInStock(w.id);
    const inStock = !!stockItem;
    const amount = inStock ? stockItem.quantity : 0;
    out.push(`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)"><div style="display:flex;gap:8px;align-items:center"><div style="width:40px;height:40px;background:rgba(255,255,255,0.03);border-radius:6px"></div><div style="font-weight:600">${w.name}</div></div><div style="${inStock ? 'color:#86efac;font-weight:700' : 'opacity:0.7'}">${inStock ? `IN STOCK (${amount})` : 'Not in stock'}</div></div>`);
  });
  $('watchlist').innerHTML = out.join('');
}
function checkWatchlistNotifications(){
  if(Notification.permission !== 'granted') return;
  const currentInStock = new Set();
  watchlist.forEach(w => { if(findItemInStock(w.id)) currentInStock.add(w.id); });
  currentInStock.forEach(id => {
    if(!window._previouslyNotified) window._previouslyNotified = new Set();
    if(!window._previouslyNotified.has(id)){
      const w = watchlist.find(x=>x.id===id);
      try{ new Notification('Item in Stock!', { body: `${w.name} is now available!` }); }catch(e){}
      window._previouslyNotified.add(id);
    }
  });
}

/* Spotlight & weather (kept similar to before) */
let spotlightItems = [], spotlightIndex = 0, spotlightInterval = null;
function buildSpotlightFromStock(){
  const picks = [];
  const rarityOrder = ['Common','Uncommon','Rare','Legendary','Mythical','Divine','Prismatic'];
  ['seed_stock','gear_stock','cosmetic_stock','egg_stock','eventshop_stock','travelingmerchant_stock'].forEach(k => (currentStockData[k]||[]).forEach(it=>{
    const r = rarityOrder.indexOf(it.rarity || 'Common');
    if(r >= 3) picks.push({...it, shop:k});
  }));
  picks.sort((a,b)=> {
    const ra = ['Common','Uncommon','Rare','Legendary','Mythical','Divine','Prismatic'].indexOf(a.rarity||'Common');
    const rb = ['Common','Uncommon','Rare','Legendary','Mythical','Divine','Prismatic'].indexOf(b.rarity||'Common');
    if(rb !== ra) return rb - ra;
    return (b.quantity || 0) - (a.quantity || 0);
  });
  spotlightItems = picks.slice(0,12);
  spotlightIndex = 0;
  if(spotlightInterval) clearInterval(spotlightInterval);
  if(spotlightItems.length) spotlightInterval = setInterval(()=>nextSpotlight(), 7000);
  nextSpotlight();
}
function nextSpotlight(){
  const el = $('rare-item-spotlight');
  if(!el) return;
  if(!spotlightItems.length){ el.innerHTML = `<h3 style="font-weight:700">Rare Spotlight ✨</h3><p style="opacity:0.7">No recent rare items found.</p>`; return; }
  const item = spotlightItems[spotlightIndex % spotlightItems.length];
  el.innerHTML = `<h3 style="font-weight:700">Rare Spotlight ✨</h3><div style="text-align:center"><div class="image-placeholder">Loading...</div><div style="font-weight:700;margin-top:8px">${item.display_name}</div><div style="margin-top:6px">${item.rarity}</div></div>`;
  setTimeout(()=>ensureItemImageRendered(item),0);
  spotlightIndex++;
}

/* Weather visuals simplified */
let previousWeatherName = null;
function setupWeatherEffects(weatherName){
  if(!weatherName) weatherName = 'clear';
  if(weatherName === previousWeatherName) return;
  previousWeatherName = weatherName;
  const container = $('weather-bg-container');
  container.innerHTML = '';
  const isDark = document.documentElement.classList.contains('dark');
  const createBg = extra => { const d = document.createElement('div'); d.className = 'weather-bg '+extra + (isDark ? ' dark-mode':' light-mode'); container.appendChild(d); setTimeout(()=>d.classList.add('active'),100); return d; };
  const w = String(weatherName).toLowerCase();
  if(w.includes('rain')){ const bg = createBg('rain-bg'); for(let i=0;i<40;i++){ const d=document.createElement('div'); d.className='rain-drop'; d.style.left = (Math.random()*100)+'vw'; d.style.animationDelay = (Math.random()*2)+'s'; bg.appendChild(d);} }
  else if(w.includes('night')) { const bg = createBg('night-bg'); for(let i=0;i<40;i++){ const s=document.createElement('div'); s.className='star'; s.style.left=(Math.random()*100)+'%'; s.style.top=(Math.random()*100)+'%'; bg.appendChild(s);} }
  else createBg('clear-bg');
}

function renderWeather(){
  // simplified: if currentWeatherData has name -> show it
  const w = window._currentWeather;
  if(w){
    const name = w.weather_name ?? w.name ?? 'Unknown';
    $('weather-section')?.remove?.(); // if present, removed earlier - safe no-op
    setupWeatherEffects(name);
  } else setupWeatherEffects('clear');
}

/* Fetch orchestration */
async function fetchAllData(){
  $('connection-status').textContent = 'Fetching latest data...';
  const stockRaw = await fetchWithTimeout(STOCK_URL, { headers: { accept:'application/json' } }, 20000);
  if(stockRaw){
    currentStockData = normalizeStockPayload(stockRaw);
    $('connection-status').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    buildSpotlightFromStock();
  } else {
    $('connection-status').textContent = 'Stock API unavailable (timeout/failure).';
  }
  renderShops();
  renderWatchlist();
  checkWatchlistNotifications();
  hideLoadingOverlay();
}

function hideLoadingOverlay(){ const e = $('loading-overlay'); if(e){ e.style.opacity='0'; setTimeout(()=>e.style.display='none',300);} }

/* UI wiring */
function setupNav(){
  const shops = { 'All': 'all', 'Seeds': 'seed_stock', 'Gear': 'gear_stock', 'Pets': 'egg_stock', 'Cosmetics': 'cosmetic_stock', 'Events': 'eventshop_stock', 'Merchant': 'travelingmerchant_stock' };
  $('shops-navigation').innerHTML = Object.entries(shops).map(([n,k])=>`<button class="market-stall" data-shop-key="${k}" style="padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.03)">${n}</button>`).join('');
  $('shops-navigation').addEventListener('click', e => {
    const btn = e.target.closest('.market-stall'); if(!btn) return;
    document.querySelectorAll('.market-stall').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    activeFilter = btn.dataset.shopKey;
    renderShops();
  });
}

function setupEvents(){
  $('display-instock').addEventListener('click', ()=>{ showAllItems=false; document.querySelectorAll('.display-toggle').forEach(b=>b.classList.remove('active')); $('display-instock').classList.add('active'); renderShops(); });
  $('display-catalog').addEventListener('click', ()=>{ showAllItems=true; document.querySelectorAll('.display-toggle').forEach(b=>b.classList.remove('active')); $('display-catalog').classList.add('active'); renderShops(); });
  $('search-bar').addEventListener('input', e=>{ searchTerm = e.target.value || ''; renderShops(); });
  document.body.addEventListener('click', e=>{
    const btn = e.target.closest('.watch-button');
    if(btn){ toggleWatch(btn.dataset.id, btn.dataset.name); }
  });
  $('notification-bell').addEventListener('click', ()=>{ if(Notification.permission !== 'granted' && Notification.permission !== 'denied') Notification.requestPermission(); else if(Notification.permission==='granted') try{ new Notification('Notifications active') }catch(e){} });
  $('theme-switcher').addEventListener('click', ()=>{ const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark'; document.documentElement.className = newTheme; localStorage.setItem('growagarden_theme', newTheme); });
}

/* Init */
async function init(){
  document.documentElement.className = localStorage.getItem('growagarden_theme') || 'dark';
  setupNav();
  setupEvents();
  renderWatchlist();
  renderShops();
  await fetchAllData();
  setTimeout(hideLoadingOverlay,800);
  setInterval(fetchAllData, 30000);
  setInterval(()=>{ document.querySelectorAll('.timer').forEach(t=>{ t.textContent = timeRemaining(Number(t.dataset.endTime)||0); }); }, 1000);
  setInterval(checkWatchlistNotifications, 4000);
}
init();
</script>
</body>
</html>
