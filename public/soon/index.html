<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Grow a Garden Tracker | Live Stock & Weather</title>
    <meta name="description" content="Live, real-time tracker for the Grow a Garden game. Monitor shop stock, get weather alerts, and never miss a rare item with our personalized watchlist and notification system.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌱</text></svg>">

    <!-- External -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* preserved user styles (small helper added at end for placeholders) */
        :root { --bg-dark-teal: #2E5953; --bg-medium-mint: #8FB3A3; --bg-light-blue-gray: #B6C9CC; --text-pale-peach: #F2D8C9; --accent-soft-orange: #F2A789; --accent-terracotta: #D98361; --dark-bg: #2E5953; --dark-text: #F2D8C9; --light-bg: #fdfbf7; --light-text: #3f3c3a; }
        html.dark body { background-color: var(--dark-bg); color: var(--dark-text); }
        html.light body { background-color: var(--light-bg); color: var(--light-text); }
        body { font-family: 'Nunito', sans-serif; transition: background-color 0.5s ease, color 0.5s ease; overflow-x: hidden; }
        .font-header { font-family: 'Fredoka One', cursive; }
        html.dark .font-header { text-shadow: 1px 1px 0 #3a3a3a, -1px -1px 0 #3a3a3a, 1px -1px 0 #3a3a3a, -1px 1px 0 #3a3a3a, 4px 4px 6px rgba(0,0,0,0.3); }
        html.light .font-header { color: #2E5953; text-shadow: 1px 1px 0px rgba(255,255,255,0.8); }
        .section-container { transition: background-color 0.5s ease, border-color 0.5s ease; }
        html.dark .section-container { background-color: rgba(0,0,0,0.2); backdrop-filter: blur(4px); border-color: rgba(143, 179, 163, 0.3); }
        html.light .section-container { background-color: rgba(255,255,255,0.7); backdrop-filter: blur(4px); border-color: rgba(46, 89, 83, 0.2); }
        .item-card { position: relative; z-index: 1; transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, opacity 0.3s ease, filter 0.3s ease; border: 1px solid transparent; animation: card-fade-in 0.5s ease-out forwards; }
        @keyframes card-fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        html.dark .item-card { background-color: rgba(46, 89, 83, 0.5); }
        html.light .item-card { background-color: #ffffff; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .item-card.out-of-stock { opacity: 0.6; filter: grayscale(80%); }
        html.dark .item-card:hover { transform: translateY(-8px); box-shadow: 0 0 25px 5px var(--rarity-glow-color, rgba(242, 167, 137, 0.4)); border-color: var(--rarity-glow-color, var(--accent-soft-orange)); z-index: 10; }
        html.light .item-card:hover { transform: translateY(-8px); box-shadow: 0 10px 25px -5px var(--rarity-glow-color, rgba(217, 131, 97, 0.4)), 0 8px 10px -6px var(--rarity-glow-color, rgba(217, 131, 97, 0.4)); border-color: var(--rarity-glow-color, var(--accent-soft-orange)); z-index: 10; }
        .item-card.out-of-stock:hover { opacity: 1; filter: grayscale(0); }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; transition: opacity 0.3s ease-out; }
        .rarity-tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
        .rarity-prismatic { background: linear-gradient(90deg, #ec4899, #f59e0b, #84cc16, #14b8a6, #6366f1, #d946ef, #ec4899); background-size: 300% 300%; animation: prismatic-glow 4s linear infinite; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);}
        @keyframes prismatic-glow { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        .sprout-loader .seed { animation: grow-seed 2s ease-out infinite; transform-origin: bottom center; }
        .sprout-loader .sprout { animation: grow-sprout 2s ease-out infinite; transform-origin: bottom center; transform: scale(0); }
        @keyframes grow-seed { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.9); } }
        @keyframes grow-sprout { 0% { transform: scale(0) translateY(10px); } 50% { transform: scale(1) translateY(0); } 100% { transform: scale(1) translateY(0) rotate(10deg); } }
        #weather-bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; pointer-events: none; }
        .weather-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; transition: opacity 1.5s ease; opacity: 0; }
        .weather-bg.active { opacity: 1; }
        .rain-drop { position: absolute; bottom: 100%; width: 2px; height: 80px; background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(182, 201, 204, 0.5)); animation: fall 1s linear infinite; }
        .chocolate-drop { background: linear-gradient(to bottom, rgba(0, 0, 0, 0), #582f0e); }
        @keyframes fall { to { transform: translateY(110vh); } }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 5s infinite ease-in-out; }
        @keyframes twinkle { 0%, 100% { opacity: 0.1; } 50% { opacity: 1; } }
        .bee { position: absolute; width: 10px; height: 10px; background: #facc15; border-radius: 50%; animation: bee-flight 8s linear infinite; opacity: 0.8; }
        .bee::before, .bee::after { content: ''; position: absolute; width: 4px; height: 4px; background: rgba(255,255,255,0.5); border-radius: 50%; top: -2px; }
        .bee::before { left: 1px; animation: flap-left 0.1s linear infinite alternate; }
        .bee::after { right: 1px; animation: flap-right 0.1s linear infinite alternate; }
        @keyframes bee-flight { from { transform: translateX(-10vw) translateY(var(--start-y)); } to { transform: translateX(110vw) translateY(var(--end-y)); } }
        @keyframes flap-left { from { transform: rotate(-30deg); } to { transform: rotate(30deg); } }
        @keyframes flap-right { from { transform: rotate(30deg); } to { transform: rotate(-30deg); } }
        .weather-bg.dark-mode { background: linear-gradient(160deg, #1e1b4b, #2E5953 80%); }
        .weather-bg.light-mode { background: linear-gradient(to bottom, #87CEEB, #f0f9ff); }
        .weather-bg.thunderstorm-bg { animation: lightning-flash 8s infinite steps(1, end); background-color: #111827}
        @keyframes lightning-flash { 80% { background-color: #111827; } 81% { background-color: #e9d5ff; } 82% { background-color: #111827; } 83% { background-color: #e9d5ff; } 84% { background-color: #111827; } }
        .weather-bg.bloodmoon-bg { background: linear-gradient(160deg, #3b0764, #7f1d1d 80%); }
        .weather-bg.frost-bg { background: linear-gradient(to bottom, #e0f2fe, #a5f3fc); }
        .weather-bg.heatwave-bg { background: linear-gradient(to bottom, #ffc107, #ff9800); }
        .weather-bg.heatwave-bg::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%); animation: heat-shimmer 2s linear infinite; }
        @keyframes heat-shimmer { 0% { transform: translateX(-20%); } 100% { transform: translateX(20%); } }
        .wind-streak { position: absolute; top: var(--top-pos); left: -10%; width: 50px; height: 1px; background: rgba(255,255,255,0.7); animation: wind-blow 1s linear infinite; }
        @keyframes wind-blow { from { transform: translateX(0); opacity: 0.7; } to { transform: translateX(120vw) scaleX(2); opacity: 0; } }
        .emoji-particle { position: absolute; font-size: 2rem; animation: fall 5s linear infinite; opacity: 0.8; }
        .tornado { position: absolute; bottom: 0; left: 50%; width: 0; height: 0; border-left: 50px solid transparent; border-right: 50px solid transparent; border-bottom: 200px solid rgba(128,128,128,0.3); animation: tornado-spin 5s linear infinite; transform-origin: bottom center; }
        .tornado::before, .tornado::after { content: ''; position: absolute; width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; }
        .tornado::before { top: 50px; left: -25px; border-bottom: 100px solid rgba(128,128,128,0.4); animation: tornado-spin 1s linear infinite reverse; }
        .tornado::after { top: 100px; left: -25px; border-bottom: 50px solid rgba(128,128,128,0.5); animation: tornado-spin 0.5s linear infinite; }
        @keyframes tornado-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .item-card .icon-button { background: rgba(255,255,255,0.1); border-radius: 9999px; padding: 0.5rem; transition: all 0.2s ease; font-size: 1.25rem; line-height: 1; }
        .item-card .icon-button:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .watch-button.active .star-icon { color: #facc15; text-shadow: 0 0 8px #fde047; }
        #notification-bell { color: #9ca3af; transition: color 0.3s, transform 0.3s; }
        #notification-bell.enabled { color: #facc15; text-shadow: 0 0 8px #fde047; }
        #notification-bell.denied { color: #ef4444; text-decoration: line-through; }
        #notification-bell.ringing { animation: bell-ring 0.5s ease-in-out; }
        @keyframes bell-ring { 0% { transform: rotate(0); } 10% { transform: rotate(14deg); } 20% { transform: rotate(-8deg); } 30% { transform: rotate(14deg); } 40% { transform: rotate(-4deg); } 50% { transform: rotate(10deg); } 60% { transform: rotate(0); } 100% { transform: rotate(0); } }
        .market-stall { transition: all 0.3s ease; border-bottom: 4px solid transparent; }
        .market-stall.active { border-color: var(--accent-terracotta); transform: translateY(-4px); }
        html.light .market-stall.active { border-color: var(--accent-soft-orange); }
        #rare-item-spotlight .spotlight-content { transition: opacity 0.5s ease-in-out; }
        .display-toggle { cursor: pointer; padding: 0.5rem 1rem; border-radius: 9999px; transition: color 0.3s ease; flex: 1; text-align: center; position: relative; z-index: 1; }
        .display-toggle.active { color: white; }
        html.light .display-toggle.active { color: var(--light-text); }
        #display-glider { position: absolute; top: 4px; left: 4px; height: calc(100% - 8px); width: calc(50% - 4px); border-radius: 9999px; background-color: var(--accent-terracotta); transition: transform 0.3s ease-in-out; }
        html.light #display-glider { background-color: var(--accent-soft-orange); }
        .header-item { animation: header-fade-in 0.6s 0.2s backwards; }
        @keyframes header-fade-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .header-icon { animation: header-icon-pop-in 0.5s 0.4s backwards; }
        @keyframes header-icon-pop-in { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        .header-sprout { display: inline-block; animation: header-sprout-grow 0.8s 0.6s cubic-bezier(0.6, -0.28, 0.735, 0.045) backwards, sway 4s ease-in-out infinite alternate; }
        @keyframes header-sprout-grow { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes sway { from { transform: rotate(-8deg); } to { transform: rotate(8deg); } }
        .header-content-wrapper { max-height: 500px; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .header-content-wrapper.header-hidden { max-height: 0; }
        .arrow { transform-origin: center; transition: transform 0.3s ease-in-out; }
        .arrow.rotate { transform: rotate(180deg); }
        .image-placeholder { width:96px; height:96px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.04); border-radius:8px; color:rgba(255,255,255,0.6); font-size:0.85rem; text-align:center; padding:6px; }
    </style>
</head>
<body>
    <div id="weather-bg-container"></div>

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 transition-opacity duration-500">
        <div class="text-center">
            <div class="sprout-loader mx-auto w-24 h-24 flex items-center justify-center">
                <div style="width: 100px; height: 100px; position: relative;">
                    <span class="seed" style="display:inline-block; width:20px; height:30px; background:#a16207; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; position: absolute; bottom: 30px; left: 40px;"></span>
                    <span class="sprout" style="display:inline-block; width:10px; height:40px; background:#84cc16; border-radius: 100% 0% 100% 0% / 100% 100% 0% 0%; position: absolute; bottom: 30px; left: 45px;"></span>
                </div>
            </div>
            <p class="mt-4 text-lg text-gray-300">Planting the seeds of data...</p>
        </div>
    </div>

    <div id="header-container" class="relative sticky top-0 z-30 dark:bg-dark-teal/80 bg-light-bg/80 backdrop-blur-md">
        <div class="header-content-wrapper">
            <header class="text-center px-2 container mx-auto py-4">
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                     <h1 class="text-4xl sm:text-5xl md:text-6xl font-header order-2 sm:order-1 header-item">
                          <span class="header-sprout">🌱</span> Grow a Garden Tracker <span class="header-sprout">🌱</span>
                     </h1>
                     <div class="flex items-center ml-0 sm:ml-6 gap-2 order-1 sm:order-2">
                         <button id="notification-bell" class="icon-button p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-soft-orange header-icon" aria-label="Toggle notifications" title="Enable Watchlist Notifications">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                         </button>
                         <button id="theme-switcher" class="icon-button p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-soft-orange header-icon" aria-label="Toggle theme" title="Toggle theme">
                             <svg class="dark:hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                             <svg class="hidden dark:inline" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                         </button>
                     </div>
                </div>
                <p id="subtitle" class="text-lg opacity-80 header-item" style="animation-delay: 0.3s;">Your enhanced companion for tracking stock, weather, and rarities.</p>
            </header>
        </div>
        <button id="header-toggle-btn" class="absolute left-1/2 bottom-0 translate-y-full -translate-x-1/2 w-10 h-8 rounded-b-full bg-accent-soft-orange dark:bg-accent-terracotta text-white shadow-lg z-40 flex items-center justify-center" aria-label="Toggle Header" aria-expanded="true">
          <svg class="arrow w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5"></path>
          </svg>
        </button>
    </div>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 pt-16 relative z-10">
        <section id="dashboard" class="mb-12 grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 flex flex-col gap-6">
                <div id="weather-section" class="section-container rounded-2xl p-6 shadow-xl border"></div>
                <div id="watchlist" class="section-container rounded-2xl p-6 shadow-xl border"></div>
            </div>
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div id="rare-item-spotlight" class="section-container rounded-2xl p-6 shadow-xl border"></div>
            </div>
        </section>

        <section id="market-street" class="mb-8 p-4 section-container rounded-2xl">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-header text-center sm:text-left mb-4 sm:mb-0">Market Street</h2>
                <div class="flex-grow max-w-lg">
                    <input type="text" id="search-bar" placeholder="Search for items..." class="w-full px-4 py-2 rounded-full bg-white/20 dark:bg-black/20 focus:outline-none focus:ring-2 focus:ring-[var(--accent-terracotta)] transition-shadow">
                </div>
                <div id="display-toggle-container" class="relative flex items-center p-1 rounded-full border border-white/10 bg-gray-700/20">
                    <div id="display-glider" class="absolute top-1 left-1 h-[calc(100%-0.5rem)] w-1/2 rounded-full bg-[var(--accent-terracotta)] transition-all duration-300 ease-in-out"></div>
                    <button id="display-instock" class="display-toggle active">In Stock</button>
                    <button id="display-catalog" class="display-toggle">Full Catalog</button>
                </div>
            </div>
            <div id="shops-navigation" class="flex flex-wrap justify-center gap-4 md:gap-8"></div>
        </section>

        <main id="shops-container" class="mb-12 shop-grid"></main>

        <footer class="text-center mt-16 md:mt-20 py-8 border-t-[1px] dark:border-gray-700/50 border-gray-300/50">
            <p id="connection-status" class="opacity-70">Fetching data...</p>
            <p class="opacity-50 mt-4 text-sm">Data provided by the Grow a Garden stock API. This is an unofficial fan-made tool.</p>
        </footer>
    </div>

<script>
/* ----------
  Image host behavior:
    - Uses HTTP stock-apis images at:
        http://stock-apis.vercel.app/i/growagarden/{item_idLowercase}
      (tries path and .png)
    - Falls back to JoshLei image API when needed
    - Preloads images and swaps them into card placeholders
  ---------- */

/* Provided arrays (kept exactly) */
const SEEDS = ["Carrot","Strawberry","Blueberry","Tomato","Daffodil","Watermelon","Pumpkin","Apple","Bamboo","Coconut","Cactus","Dragon Fruit","Mango","Grape","Mushroom","Pepper","Cacao","Beanstalk","Ember lily","Sugar Apple","Burning Bud","Giant Pinecone","Elder Strawberry","Romanesco"];
const GEARS = ["Watering Can","Trowel","Recall Wrench","Basic Sprinkler","Advanced Sprinkler","Medium Toy","Medium Treat","Godly Sprinkler","Magnifying Glass","Master Sprinkler","Cleaning Spray","Cleansing Pet Shard","Favorite Tool","Harvest Tool","Friendship Pot","Grandmaster Sprinkler","Levelup Lolipop"];
const EGGS = ["Common Egg","Uncommon Egg","Rare Egg","Legendary Egg","Mythical Egg","Bug Egg"];

/* Config */
const STOCK_URL = 'https://stock-apis.vercel.app/api/growagarden/stocks';
const WEATHER_URL = 'https://api.joshlei.com/v2/growagarden/weather';
const JOSHLEI_IMAGE_BASE = 'https://api.joshlei.com/v2/growagarden/image';
const API_KEY = 'js_c5d322d0652bc477f50348450bb2c6fe4f4d767042b2b0facb69b074c3d46f46';

// Use HTTP stock-apis image base with lowercased item_id as requested
const STOCK_APIS_IMAGE_BASE = 'http://stock-apis.vercel.app/i/growagarden';

let currentStockData = {};
let currentWeatherData = {};
let watchlist = JSON.parse(localStorage.getItem('growagarden_watchlist') || '[]');
let activeFilter = 'all';
let showAllItems = false;
let searchTerm = '';
let previouslyNotifiedInStock = new Set();
const iconResolveCache = {}; // cache for resolved image urls

const $ = id => document.getElementById(id);

function safeHostIdFromDisplayName(displayName) {
    if (!displayName) return '';
    // replace spaces with underscores but return original casing for item_id if possible
    return displayName.replace(/\s+/g,'_');
}
function buildJoshleiKey(displayName) {
    if (!displayName) return '';
    return encodeURIComponent(displayName.toLowerCase().replace(/\s+/g,'_'));
}
function canonicalCompare(text) {
    return (text||'').toString().toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9]/g,'');
}
function normalizeRarity(raw) {
    if (!raw) return 'Common';
    const s = String(raw).toLowerCase();
    if (s.includes('prismatic')) return 'Prismatic';
    if (s.includes('divine')) return 'Divine';
    if (s.includes('myth')) return 'Mythical';
    if (s.includes('legend')) return 'Legendary';
    if (s.includes('uncommon')) return 'Uncommon';
    if (s.includes('rare') && !s.includes('uncommon')) return 'Rare';
    if (s.includes('common')) return 'Common';
    if (s.includes('unknown')) return 'Common';
    return raw.charAt(0).toUpperCase() + raw.slice(1);
}
function timeRemaining(unixEnd) {
    if (!unixEnd) return '—';
    const diff = unixEnd - Math.floor(Date.now() / 1000);
    if (diff <= 0) return 'Restocked!';
    const h = Math.floor(diff/3600).toString().padStart(2,'0');
    const m = Math.floor((diff%3600)/60).toString().padStart(2,'0');
    const s = Math.floor(diff%60).toString().padStart(2,'0');
    return `${h}:${m}:${s}`;
}

/* Fetch helpers */
async function fetchWithTimeout(url, opts={}, timeout=15000, asBlob=false) {
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), timeout);
    try {
        const res = await fetch(url, { signal: controller.signal, ...opts });
        clearTimeout(t);
        if (!res.ok) throw new Error('HTTP '+res.status);
        return asBlob ? await res.blob() : await res.json();
    } catch (e) {
        clearTimeout(t);
        return null;
    }
}

function tryImageURLQuick(url, timeout=2500) {
    return new Promise(resolve=>{
        const img = new Image();
        let done=false;
        img.crossOrigin = 'anonymous';
        img.onload = () => { if (!done) { done=true; resolve(true); } };
        img.onerror = () => { if (!done) { done=true; resolve(false); } };
        img.src = url;
        setTimeout(()=>{ if (!done) { done=true; resolve(false); } }, timeout);
    });
}

async function urlExists(url) {
    try {
        const head = await fetch(url, { method: 'HEAD' });
        if (head && head.ok) return true;
    } catch (e) {}
    return tryImageURLQuick(url, 2500);
}

/* Normalize stock payload */
function normalizeStockPayload(raw) {
    if (!raw || typeof raw !== 'object') return {};
    const find = (...cands) => {
        for (const c of cands) if (Object.prototype.hasOwnProperty.call(raw,c)) return raw[c];
        const keys = Object.keys(raw);
        for (const c of cands) {
            const needle = c.toLowerCase().replace(/\s+/g,'');
            const found = keys.find(k => k.toLowerCase().replace(/\s+/g,'') === needle);
            if (found) return raw[found];
        }
        return null;
    };
    const out = {};
    out.seed_stock = find('seed_stock','Seeds Stock','Seeds') || [];
    out.gear_stock = find('gear_stock','Gear Stock','Gear','gears') || [];
    out.cosmetic_stock = find('cosmetic_stock','Cosmetics Stock','Cosmetics') || [];
    out.egg_stock = find('egg_stock','Egg Stock','Eggs') || [];
    out.eventshop_stock = find('eventshop_stock','Event Stock','Event') || [];
    out.travelingmerchant_stock = find('travelingmerchant_stock','Merchant Stock','Merchant') || [];

    function normList(arr){
        if (!Array.isArray(arr)) {
            if (arr && Array.isArray(arr.stock)) arr = arr.stock;
            else return [];
        }
        return arr.map(it=>{
            const quantity = Number(it.quantity ?? it.stock ?? it.count ?? 0);
            const icon = it.icon ?? it.image ?? it.img ?? '';
            const rawName = it.display_name ?? it.displayName ?? it.name ?? '';
            // prefer explicit item_id from API; fall back to safeHost from display name
            const item_id = it.item_id ?? it.id ?? safeHostIdFromDisplayName(rawName);
            const display_name = rawName || '';
            const rarity = normalizeRarity(it.rarity ?? it.rarity_name ?? it.rarityName ?? '');
            const end_date_unix = it.end_date_unix ?? it.end_time_unix ?? it.ends_at ?? null;
            return { ...it, item_id, display_name, quantity, icon, rarity, end_date_unix };
        });
    }

    out.seed_stock = normList(out.seed_stock);
    out.gear_stock = normList(out.gear_stock);
    out.cosmetic_stock = normList(out.cosmetic_stock);
    out.egg_stock = normList(out.egg_stock);
    out.eventshop_stock = normList(out.eventshop_stock);
    out.travelingmerchant_stock = normList(out.travelingmerchant_stock);
    return out;
}

/* Image resolution flow (modified to lowercase host id):
   1) Try stock-apis host: http://stock-apis.vercel.app/i/growagarden/{item_idLowercase}
   2) Try same with .png
   3) Try JoshLei API: https://api.joshlei.com/v2/growagarden/image/{lowercase_underscored}
   4) If JoshLei returns a blob, create object URL
*/
async function resolveIconForItem(item) {
    const displayName = item.display_name || item.item_id || '';
    // prefer explicit item_id from API; fall back to display name
    const rawId = (item.item_id && item.item_id.toString()) || safeHostIdFromDisplayName(displayName);
    if (!rawId) return null;

    // Lowercase the id for the stock-apis host (user requested)
    const hostIdLower = rawId.toLowerCase();

    if (iconResolveCache[hostIdLower] !== undefined) return iconResolveCache[hostIdLower];
    iconResolveCache[hostIdLower] = null; // reserve

    const stockApisBase = `${STOCK_APIS_IMAGE_BASE}/${hostIdLower}`;
    const stockApisPng = `${stockApisBase}.png`;

    try {
        if (await urlExists(stockApisBase)) { iconResolveCache[hostIdLower] = stockApisBase; return stockApisBase; }
        if (await urlExists(stockApisPng)) { iconResolveCache[hostIdLower] = stockApisPng; return stockApisPng; }
    } catch(e){}

    // JoshLei fallback (lowercase_underscored)
    const jlKey = buildJoshleiKey(displayName);
    const joshleiUrl = `${JOSHLEI_IMAGE_BASE}/${jlKey}`;

    try {
        const blob = await fetchWithTimeout(joshleiUrl, {}, 8000, true);
        if (blob instanceof Blob && blob.size > 0) {
            try {
                const obj = URL.createObjectURL(blob);
                iconResolveCache[hostIdLower] = obj;
                return obj;
            } catch (e) {
                iconResolveCache[hostIdLower] = joshleiUrl;
                return joshleiUrl;
            }
        }
    } catch(e){}

    try {
        if (await urlExists(joshleiUrl)) { iconResolveCache[hostIdLower] = joshleiUrl; return joshleiUrl; }
    } catch(e){}
    iconResolveCache[hostIdLower] = null;
    return null;
}

/* Card HTML */
function starSvg(active) {
    if (active) {
        return `<svg class="star-icon w-5 h-5" viewBox="0 0 24 24" fill="#facc15" xmlns="http://www.w3.org/2000/svg"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;
    } else {
        return `<svg class="star-icon w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" xmlns="http://www.w3.org/2000/svg"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`;
    }
}

function itemCardHtml(item) {
    const displayName = item.display_name || item.item_id || 'Unknown';
    const qty = Number(item.quantity || 0);
    const inStock = qty > 0;
    const rarity = item.rarity || 'Common';
    const isWatched = watchlist.some(w => w.id === item.item_id);

    const imgPlaceholder = `<div class="flex-grow flex items-center justify-center my-4">
        <div class="image-placeholder" data-img-for="${item.item_id}">Loading image...</div>
        <img data-img-for="${item.item_id}" alt="${displayName}" class="max-h-24" style="display:none" />
    </div>`;

    return `
    <div class="item-card rounded-xl p-4 flex flex-col ${!inStock ? 'out-of-stock' : ''}" data-item-id="${item.item_id}">
        <div class="flex justify-between items-start mb-2">
            <div class="rarity-tag ${rarity === 'Prismatic' ? 'rarity-prismatic' : ''}" style="${rarity === 'Prismatic' ? '' : 'background:#9ca3af;color:#1f2937'}">${rarity}</div>
            <button class="watch-button icon-button ${isWatched ? 'active' : ''}" title="Toggle watch" data-id="${item.item_id}" data-name="${displayName}" data-icon="${item.icon || ''}">
                ${starSvg(isWatched)}
            </button>
        </div>
        ${imgPlaceholder}
        <h3 class="font-bold text-center text-lg">${displayName}</h3>
        <div class="mt-4 pt-4 border-t dark:border-gray-600/50 border-gray-300/50 text-sm space-y-1">
            <div class="flex justify-between"><span>Stock:</span> <span class="font-semibold stock-amount">${inStock ? qty : 'Out of Stock'}</span></div>
            <div class="flex justify-between"><span>Restocks:</span> <span class="font-semibold timer" data-end-time="${item.end_date_unix ?? 0}">${timeRemaining(item.end_date_unix)}</span></div>
        </div>
    </div>`;
}

/* Full catalog ordering */
function idsFromList(namesArr) {
    return (namesArr || []).map(n => ({ item_id: safeHostIdFromDisplayName(n), display_name: n }));
}
const SEED_ORDER = idsFromList(SEEDS);
const GEAR_ORDER = idsFromList(GEARS);
const EGG_ORDER  = idsFromList(EGGS);

function buildFullCatalogForCategory(shopKey) {
    const apiList = (currentStockData[shopKey] || []).slice();
    const apiMap = new Map(apiList.map(it => [canonicalCompare(it.display_name||it.item_id||''), it]));
    let orderArr = [];
    if (shopKey === 'seed_stock') orderArr = SEED_ORDER;
    else if (shopKey === 'gear_stock') orderArr = GEAR_ORDER;
    else if (shopKey === 'egg_stock') orderArr = EGG_ORDER;
    const ordered = [];
    orderArr.forEach(({item_id, display_name}) => {
        const key = canonicalCompare(display_name);
        const apiItem = apiMap.get(key);
        if (apiItem) {
            ordered.push({...apiItem, display_name: apiItem.display_name || display_name});
            apiMap.delete(key);
        } else {
            ordered.push({ item_id: item_id || safeHostIdFromDisplayName(display_name), display_name, quantity: 0, icon: '', rarity: 'Common', shop: shopKey });
        }
    });
    for (const it of apiList) {
        if (!orderArr.find(o => canonicalCompare(o.display_name) === canonicalCompare(it.display_name))) ordered.push({...it});
    }
    return ordered.map(x => ({...x, shop: shopKey}));
}

/* image rendering for card placeholders */
async function ensureItemImageRendered(item) {
    const displayName = item.display_name || item.item_id || '';
    const id = item.item_id || safeHostIdFromDisplayName(displayName);
    if (!id) return;
    const imgEl = document.querySelector(`img[data-img-for="${id}"]`);
    const phEl = document.querySelector(`.image-placeholder[data-img-for="${id}"]`);
    const resolved = await resolveIconForItem(item);
    if (!resolved) {
        if (imgEl) imgEl.remove();
        if (phEl) phEl.textContent = 'Image not found';
        return;
    }
    if (imgEl) {
        imgEl.src = resolved;
        imgEl.style.display = '';
        imgEl.onload = () => { if (phEl) phEl.remove(); };
        imgEl.onerror = () => { imgEl.remove(); if (phEl) phEl.textContent = 'Image not found'; };
    } else if (phEl) {
        const img = document.createElement('img');
        img.dataset.imgFor = id;
        img.alt = displayName;
        img.className = 'max-h-24';
        img.src = resolved;
        img.onload = () => phEl.replaceWith(img);
        img.onerror = () => phEl.textContent = 'Image not found';
    }
}

/* Render logic */
function renderFullCatalog(shopKey) {
    const groups = [];
    if (shopKey === 'all') {
        groups.push({ title:'Seeds', items: buildFullCatalogForCategory('seed_stock') });
        groups.push({ title:'Gear', items: buildFullCatalogForCategory('gear_stock') });
        groups.push({ title:'Pets', items: buildFullCatalogForCategory('egg_stock') });
    } else {
        const title = shopKey === 'seed_stock' ? 'Seeds' : shopKey === 'gear_stock' ? 'Gear' : shopKey === 'egg_stock' ? 'Pets' : shopKey;
        groups.push({ title, items: buildFullCatalogForCategory(shopKey) });
    }

    let out = '';
    groups.forEach(g=>{
        out += `<div class="col-span-full"><h3 class="font-header text-xl mb-3">${g.title} — Full Catalog</h3></div>`;
        out += g.items.map(item=> itemCardHtml(item) ).join('');
    });
    $('shops-container').innerHTML = out;
    groups.forEach(g => g.items.forEach(it => setTimeout(()=>ensureItemImageRendered(it),0)));
}

function renderShops() {
    const hasAny = Object.values(currentStockData || {}).some(a => Array.isArray(a) && a.length>0);
    if (!hasAny) {
        $('shops-container').innerHTML = `<p class="text-center col-span-full opacity-70">Loading shop data... (this may take a moment)</p>`;
        return;
    }

    if (showAllItems && activeFilter !== 'all') { renderFullCatalog(activeFilter); return; }
    if (showAllItems && activeFilter === 'all') { renderFullCatalog('all'); return; }

    const order = ['seed_stock','gear_stock','cosmetic_stock','egg_stock','eventshop_stock','travelingmerchant_stock'];
    const all = [];
    order.forEach(k => (currentStockData[k]||[]).forEach(it => all.push({...it, shop:k})));

    let filtered = all.filter(item => {
        const name = (item.display_name || item.item_id || '').toLowerCase();
        const searchMatch = !searchTerm || name.includes(searchTerm.toLowerCase());
        const stockMatch = showAllItems || (Number(item.quantity||0) > 0);
        const shopMatch = activeFilter === 'all' || item.shop === activeFilter;
        return searchMatch && stockMatch && shopMatch;
    });

    if (activeFilter === 'seed_stock' || activeFilter === 'gear_stock' || activeFilter === 'egg_stock') {
        const orderArr = activeFilter === 'seed_stock' ? SEED_ORDER : activeFilter === 'gear_stock' ? GEAR_ORDER : EGG_ORDER;
        const idx = new Map(orderArr.map((o,i)=>[canonicalCompare(o.display_name), i]));
        filtered.sort((a,b) => {
            const ia = idx.has(canonicalCompare(a.display_name)) ? idx.get(canonicalCompare(a.display_name)) : 9999;
            const ib = idx.has(canonicalCompare(b.display_name)) ? idx.get(canonicalCompare(b.display_name)) : 9999;
            if (ia !== ib) return ia - ib;
            return (b.quantity||0) - (a.quantity||0);
        });
    } else {
        filtered.sort((a,b) => {
            if (a.shop !== b.shop) return a.shop.localeCompare(b.shop);
            return (a.display_name||'').localeCompare(b.display_name||'');
        });
    }

    if (!filtered.length) {
        $('shops-container').innerHTML = `<p class="text-center col-span-full opacity-70">No items match your filters.</p>`;
        return;
    }
    $('shops-container').innerHTML = filtered.map(it=>itemCardHtml(it)).join('');
    filtered.forEach(it => setTimeout(()=>ensureItemImageRendered(it),0));
}

/* Watchlist & notifications */
function saveWatchlist() { localStorage.setItem('growagarden_watchlist', JSON.stringify(watchlist)); }
function findItemInStock(itemId) {
    for (const k of Object.keys(currentStockData||{})) {
        const arr = currentStockData[k] || [];
        const f = arr.find(it => it.item_id === itemId && Number(it.quantity||0) > 0);
        if (f) return f;
    }
    return null;
}
function toggleWatch(id,name,icon){
    const idx = watchlist.findIndex(w=>w.id===id);
    const added = idx === -1;
    if (idx>-1) watchlist.splice(idx,1); else watchlist.push({ id,name,icon });
    saveWatchlist();
    renderWatchlist();
    renderShops();
    if (added && Notification.permission === 'granted') {
        const inStock = findItemInStock(id);
        try { new Notification('Watchlist updated', { body: inStock ? `${name} is in stock!` : `${name} added to watchlist.` , icon: icon||undefined }); } catch(e){}
    }
}
function renderWatchlist(){
    let html = `<h2 class="text-2xl font-header mb-4">Your Watchlist ⭐</h2>`;
    if (!watchlist.length) { html+=`<p class="opacity-70">Click the star on an item to track it here!</p>`; $('watchlist').innerHTML = html; return; }
    const rows = watchlist.map(w => {
        const stockItem = findItemInStock(w.id);
        const inStock = !!stockItem;
        const amount = inStock ? stockItem.quantity : 0;
        const img = w.icon ? `<img src="${w.icon}" alt="${w.name}" class="w-10 h-10" onerror="this.style.display='none'">` : `<div class="image-placeholder" style="width:40px;height:40px;font-size:0.7rem">Image</div>`;
        return `<div class="flex items-center justify-between py-2 border-b dark:border-gray-700/50 border-gray-300/50">
            <div class="flex items-center gap-4">${img}<span class="font-semibold">${w.name}</span></div>
            <div class="${inStock ? 'text-green-400 font-bold' : 'opacity-60'}">${inStock ? `IN STOCK (${amount})` : 'Not in stock'}</div>
        </div>`;
    }).join('');
    $('watchlist').innerHTML = html + `<div class="space-y-2">${rows}</div>`;
}
function checkWatchlistNotifications(){
    if (Notification.permission !== 'granted') return;
    const cur = new Set();
    watchlist.forEach(w => { if (findItemInStock(w.id)) cur.add(w.id); });
    for (const id of cur) {
        if (!previouslyNotifiedInStock.has(id)) {
            const w = watchlist.find(x=>x.id===id);
            try { new Notification('Item in Stock!', { body: `${w.name} is now available!`, icon: w.icon||undefined }); } catch(e){}
        }
    }
    previouslyNotifiedInStock = cur;
}

/* Spotlight & weather */
let spotlightItems = [], spotlightIndex = 0, spotlightInterval = null;
function buildSpotlightFromStock(){
    const picks = [];
    const keys = ['seed_stock','gear_stock','cosmetic_stock','egg_stock','eventshop_stock','travelingmerchant_stock'];
    const rarityOrder = ['Common','Uncommon','Rare','Legendary','Mythical','Divine','Prismatic'];
    keys.forEach(k => (currentStockData[k]||[]).forEach(it=>{
        const r = rarityOrder.indexOf(it.rarity||'Common');
        if (r >= 3) picks.push({...it, shop:k});
    }));
    picks.sort((a,b)=> {
        const ra = rarityOrder.indexOf(a.rarity||'Common');
        const rb = rarityOrder.indexOf(b.rarity||'Common');
        if (rb !== ra) return rb - ra;
        return (b.quantity||0) - (a.quantity||0);
    });
    spotlightItems = picks.slice(0,12);
    spotlightIndex = 0;
    if (spotlightInterval) clearInterval(spotlightInterval);
    if (spotlightItems.length) spotlightInterval = setInterval(()=>nextSpotlight(), 7000);
    nextSpotlight();
}
function nextSpotlight(){
    const el = $('rare-item-spotlight');
    if (!el) return;
    if (!spotlightItems.length) {
        el.innerHTML = `<h2 class="text-2xl font-header mb-4">Rare Spotlight ✨</h2><div class="spotlight-content"><p class="opacity-70">No recent rare items found.</p></div>`;
        return;
    }
    const item = spotlightItems[spotlightIndex % spotlightItems.length];
    el.innerHTML = `<h2 class="text-2xl font-header mb-4">Rare Spotlight ✨</h2>
        <div class="spotlight-content text-center">
            <div class="image-placeholder">Loading...</div>
            <p class="font-bold text-lg">${item.display_name}</p>
            <div class="inline-block mt-1 rarity-tag ${item.rarity === 'Prismatic' ? 'rarity-prismatic' : ''}" style="background:#ddd;color:#111">${item.rarity}</div>
        </div>`;
    setTimeout(()=>ensureItemImageRendered(item),0);
    spotlightIndex++;
}

/* Weather visuals */
let previousWeatherName = null;
function setupWeatherEffects(weatherName) {
    if (!weatherName) weatherName = 'clear';
    if (weatherName === previousWeatherName) return;
    previousWeatherName = weatherName;
    const container = $('weather-bg-container');
    container.innerHTML = '';
    const isDark = document.documentElement.classList.contains('dark');
    const createBg = (extraClass='') => {
        const bg = document.createElement('div');
        bg.className = `weather-bg ${extraClass} ${isDark ? 'dark-mode' : 'light-mode'}`;
        container.appendChild(bg);
        setTimeout(()=>bg.classList.add('active'), 100);
        return bg;
    };
    const w = weatherName.toLowerCase();
    if (w.includes('clear')) createBg('clear-bg');
    else if (w.includes('rain')) {
        const bg = createBg('rain-bg');
        for (let i=0;i<40;i++){ const d=document.createElement('div'); d.className='rain-drop'; d.style.left=`${Math.random()*100}vw`; d.style.animationDelay=`${Math.random()*2}s`; bg.appendChild(d); }
    } else if (w.includes('night')) {
        const bg = createBg('night-bg');
        for (let i=0;i<50;i++){ const s=document.createElement('div'); s.className='star'; const size=Math.random()*2+1; s.style.width=s.style.height=`${size}px`; s.style.top=`${Math.random()*100}%`; s.style.left=`${Math.random()*100}%`; s.style.animationDelay=`${Math.random()*5}s`; bg.appendChild(s); }
    } else if (w.includes('bee')) {
        const bg = createBg('bee-swarm-bg');
        for (let i=0;i<15;i++){ const b=document.createElement('div'); b.className='bee'; b.style.setProperty('--start-y',`${Math.random()*100}vh`); b.style.setProperty('--end-y',`${Math.random()*100}vh`); b.style.animationDelay=`${Math.random()*8}s`; bg.appendChild(b); }
    } else if (w.includes('thunder')) createBg('thunderstorm-bg');
    else if (w.includes('blood')) createBg('bloodmoon-bg');
    else if (w.includes('frost')) createBg('frost-bg');
    else if (w.includes('heat')) createBg('heatwave-bg');
    else if (w.includes('wind')) { const bg = createBg('windy-bg'); for (let i=0;i<20;i++){ const s=document.createElement('div'); s.className='wind-streak'; s.style.setProperty('--top-pos',`${Math.random()*100}vh`); s.style.animationDelay=`${Math.random()*1}s`; bg.appendChild(s); } }
    else if (w.includes('party')) { const bg=createBg('party-time-bg'); const emojis=['🎉','🎊','🎈','✨','🎁']; for (let i=0;i<30;i++){ const p=document.createElement('div'); p.className='emoji-particle'; p.textContent=emojis[Math.floor(Math.random()*emojis.length)]; p.style.left=`${Math.random()*100}vw`; p.style.animationDelay=`${Math.random()*5}s`; p.style.animationDuration=`${Math.random()*3+3}s`; bg.appendChild(p);} }
    else if (w.includes('tornado')) { const bg=createBg('tornado-bg'); const t=document.createElement('div'); t.className='tornado'; t.style.left=`${Math.random()*60+20}%`; bg.appendChild(t); }
    else createBg('clear-bg');
}

function renderWeather(){
    const weather = currentWeatherData?.weather?.find(w=>w.active) ?? currentWeatherData?.weather?.[0] ?? currentWeatherData;
    if (weather) {
        const name = weather.weather_name ?? weather.name ?? weather.weather ?? 'Unknown';
        const icon = weather.icon ?? '';
        $('weather-section').innerHTML = `<h2 class="text-2xl font-header mb-4">Weather Alert</h2>
            <div class="flex items-center gap-4">
                ${ icon ? `<img src="${icon}" alt="${name}" class="w-16 h-16" onerror="this.style.display='none'">` : '' }
                <div><p class="text-xl font-bold">${name}</p><p class="opacity-80">${weather.weather_id && String(weather.weather_id).toLowerCase().includes('bee') ? 'Spawns bees that create Pollinated mutations.' : (weather.description || 'A weather event may be active.')}</p></div>
            </div>`;
        setupWeatherEffects(String(name));
    } else {
        $('weather-section').innerHTML = `<h2 class="text-2xl font-header mb-4">Weather Alert</h2><p>The skies are clear.</p>`;
        setupWeatherEffects('clear');
    }
}

/* Fetch orchestration */
async function fetchAllData(){
    $('connection-status').textContent = 'Fetching latest data...';
    const stockPromise = fetchWithTimeout(STOCK_URL, { headers: { accept:'application/json' } }, 20000);
    const weatherPromise = fetchWithTimeout(WEATHER_URL, { headers: { 'jstudio-key': API_KEY, accept:'application/json' } }, 10000);

    renderShops();
    renderWatchlist();

    const weatherRaw = await weatherPromise;
    if (weatherRaw) { currentWeatherData = weatherRaw; try { renderWeather(); } catch(e){} }

    const stockRaw = await stockPromise;
    if (stockRaw) {
        currentStockData = normalizeStockPayload(stockRaw);
        $('connection-status').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        buildSpotlightFromStock();
    } else {
        $('connection-status').textContent = 'Stock API unavailable or timed out (will retry).';
    }

    renderShops();
    renderWatchlist();
    checkWatchlistNotifications();
    hideLoadingOverlay();
}

function hideLoadingOverlay() { const e = $('loading-overlay'); if (e) { e.style.opacity='0'; setTimeout(()=>e.style.display='none',400); } }

/* UI wiring */
function setupNav(){
    const shops = { 'All': 'all', 'Seeds': 'seed_stock', 'Gear': 'gear_stock', 'Pets': 'egg_stock', 'Cosmetics': 'cosmetic_stock', 'Events': 'eventshop_stock', 'Merchant': 'travelingmerchant_stock' };
    $('shops-navigation').innerHTML = Object.entries(shops).map(([n,k])=>`<button class="market-stall px-4 py-2 rounded-t-lg font-bold ${k==='all'?'active':''}" data-shop-key="${k}">${n}</button>`).join('');
    $('shops-navigation').addEventListener('click', e=>{
        const btn = e.target.closest('.market-stall'); if (!btn) return;
        document.querySelectorAll('.market-stall').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        activeFilter = btn.dataset.shopKey;
        renderShops();
    });
}

function setupEventListeners(){
    $('display-instock').addEventListener('click', ()=>{ showAllItems=false; $('display-instock').classList.add('active'); $('display-catalog').classList.remove('active'); $('display-glider').style.transform='translateX(0%)'; renderShops(); });
    $('display-catalog').addEventListener('click', ()=>{ showAllItems=true; $('display-catalog').classList.add('active'); $('display-instock').classList.remove('active'); $('display-glider').style.transform='translateX(100%)'; renderShops(); });
    $('search-bar').addEventListener('input', e=>{ searchTerm = e.target.value || ''; renderShops(); });
    $('shops-container').addEventListener('click', e => { const btn = e.target.closest('.watch-button'); if (!btn) return; toggleWatch(btn.dataset.id, btn.dataset.name, btn.dataset.icon); });

    $('notification-bell').addEventListener('click', ()=> {
        if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            Notification.requestPermission().then(()=>{});
        } else if (Notification.permission === 'granted') {
            try { new Notification('Notifications active', { body: 'You will receive watchlist alerts.' }); } catch(e){}
        }
    });

    $('theme-switcher').addEventListener('click', ()=> {
        const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
        document.documentElement.className = newTheme;
        localStorage.setItem('growagarden_theme', newTheme);
        setupWeatherEffects(previousWeatherName);
    });

    $('header-toggle-btn').addEventListener('click', (e) => {
        const wrapper = document.querySelector('.header-content-wrapper');
        const arrow = e.currentTarget.querySelector('.arrow');
        wrapper.classList.toggle('header-hidden');
        arrow.classList.toggle('rotate', wrapper.classList.contains('header-hidden'));
        const expanded = wrapper.classList.contains('header-hidden') ? 'false' : 'true';
        e.currentTarget.setAttribute('aria-expanded', expanded);
    });
}

/* Init */
async function init(){
    document.documentElement.className = localStorage.getItem('growagarden_theme') || 'dark';
    setupNav();
    setupEventListeners();
    renderWatchlist();
    renderShops();
    await fetchAllData().catch(e=>console.error(e));
    setTimeout(hideLoadingOverlay, 900);
    setInterval(fetchAllData, 30000);
    setInterval(()=>{ document.querySelectorAll('.timer').forEach(t=>{ t.textContent = timeRemaining(Number(t.dataset.endTime)||0); }); }, 1000);
    setInterval(checkWatchlistNotifications, 4000);
    window._growagarden = { fetchAllData, renderShops, currentStockData, watchlist };
}
init();
</script>

</body>
</html>
