<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Grow a Garden â€” Stock Monitor</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#1f2330; --muted:#707789;
      --accent:#6b7cff; --accent-2:#50e3c2; --border:#e6e8f0;
      --good:#18a957; --bad:#e24a4a; --shadow:0 6px 20px rgba(0,0,0,.08);
      --glass-bg:rgba(255,255,255,0.6);
      --icon-filter:none;
      --btn-dark-bg:rgba(255,255,255,0.06);
      --hover-ease:cubic-bezier(.2,.9,.2,1);
    }
    html.dark{
      --bg:#0d0f15; --card:#0f1720; --text:#dfe6ff; --muted:#9aa3b2;
      --accent:#8d9bff; --accent-2:#65f2d0; --border:#1e2433;
      --shadow:0 10px 32px rgba(0,0,0,.6);
      --glass-bg:rgba(8,12,18,0.55);
      --icon-filter:invert(1) brightness(2);
      --btn-dark-bg:linear-gradient(90deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));
    }
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:60;backdrop-filter:saturate(120%) blur(8px);}
    .bar{display:flex;align-items:center;gap:10px;padding:12px 18px;max-width:1200px;margin:0 auto;}
    .title{font-weight:800;letter-spacing:.3px;font-size:18px;display:flex;align-items:center;gap:10px}
    .pill{padding:4px 10px;border-radius:999px;background:var(--card);border:1px solid var(--border);color:var(--muted);font-size:12px}
    .spacer{flex:1}
    button.icon{border:none;background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);width:38px;height:38px;border-radius:12px;display:grid;place-items:center;cursor:pointer;transition: transform .14s var(--hover-ease), box-shadow .14s var(--hover-ease), background .12s var(--hover-ease);}
    button.icon:hover{transform:translateY(-4px);box-shadow:0 18px 36px rgba(0,0,0,0.12);}
    button.icon img{width:18px;height:18px;display:block;filter:var(--icon-filter);transition:filter .12s ease}
    html.dark button.icon{ background: var(--btn-dark-bg); border-color:var(--border); }
    main.row{max-width:1200px;margin:0 auto;padding:18px}
    .categories{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:880px){.categories{grid-template-columns:1fr 1fr}}
    @media(min-width:1180px){.categories{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden;transition: transform .14s var(--hover-ease), box-shadow .14s var(--hover-ease);}
    .card:hover{transform:translateY(-6px) scale(1.03);box-shadow:0 24px 72px rgba(107,124,255,0.18);}
    .card-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;cursor:pointer}
    .card-header h2{margin:0;font-size:16px}
    .badge{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;padding:4px 10px;font-size:12px;border-radius:999px;font-weight:700}
    .chev{transition:transform .3s ease;opacity:.85}
    .card.open .chev{transform:rotate(180deg)}
    .card-body{overflow:hidden;max-height:0;transition:max-height .45s cubic-bezier(.2,.8,.2,1), opacity .25s ease;opacity:0;border-top:1px dashed var(--border)}
    .card.open .card-body{opacity:1}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;padding:12px}
    .item{display:flex;gap:12px;align-items:center;padding:10px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg, rgba(0,0,0,.02), transparent);transition: transform .18s var(--hover-ease), box-shadow .18s var(--hover-ease), border-color .15s, background .15s}
    .item:hover{transform:translateY(-8px) scale(1.04);box-shadow:0 20px 48px rgba(107,124,255,0.12);border-color:var(--accent);background:linear-gradient(90deg,#f6f7fb 70%,#e7eaff 100%)}
    .item.dim{opacity:.45;filter:grayscale(.35)}
    .item img{width:44px;height:44px;border-radius:10px;object-fit:cover;background:#00000008}
    .meta{display:flex;flex-direction:column;gap:2px;min-width:0}
    .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .qty{margin-left:auto;font-weight:800;text-align:right}
    .restock{display:block;font-size:12px;color:var(--muted);margin-top:4px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;border:1px solid var(--border);margin:4px;cursor:pointer;background:var(--card);transition: transform .12s var(--hover-ease), box-shadow .12s var(--hover-ease)}
    .chip img{width:20px;height:20px;border-radius:6px;object-fit:cover}
    .chip:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.08);border-color:var(--accent-2);background:linear-gradient(92deg,#e6e8f0,#bdecec 88%)}
    .row-muted{color:var(--muted);font-size:13px}
    .notif-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
    .notif-row img{width:36px;height:36px;border-radius:6px;object-fit:cover}
    .tick{margin-left:auto;padding:6px 10px;border-radius:10px;font-weight:700;color:#fff}
    .tick.good{background:var(--good)}
    .tick.bad{background:var(--bad)}
    #scrim{display:none;position:fixed;inset:0;z-index:60;}
    aside#sidebar{position:fixed;right:0;top:0;height:100%;width:360px;background:var(--card);box-shadow:var(--shadow);padding:12px;transform:translateX(110%);transition:transform .25s var(--hover-ease);z-index:70;display:flex;flex-direction:column}
    aside#sidebar .side-head{display:flex;align-items:center;gap:8px}
    aside#sidebar .side-body{margin-top:10px;overflow:auto;padding-right:8px;flex:1}
    .side-section{border-radius:10px;padding:8px;border:1px solid var(--border);margin-bottom:10px;background:transparent}
    .side-section .sec-head{display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:6px}
    .side-section .sec-body{overflow:hidden;max-height:0;transition:max-height .28s var(--hover-ease);padding-top:6px}
    .side-section.open .sec-body{max-height:420px}
    @media(max-width:720px){aside#sidebar{width:100%}}
    @media(max-width:720px){.list{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}.item img{width:38px;height:38px}}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">ðŸŒ± Grow a Garden <span class="pill" id="statusPill">Connectingâ€¦</span></div>
    <div class="spacer"></div>
    <button id="darkToggle" class="icon" title="Toggle theme" aria-label="Toggle theme"><img id="darkIcon" src="https://img.icons8.com/ios-filled/24/000000/contrast.png" alt="theme"></button>
    <button id="openSidebar" class="icon"><img src="https://img.icons8.com/ios-filled/24/000000/bell.png" alt="Notifications"></button>
  </div>
</header>
<main class="row">
  <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
    <div class="row-muted" id="updatedAt">â€”</div>
    <div id="restockTimers" class="row-muted" style="margin-left:auto;"></div>
  </div>
  <div class="categories" id="categories"></div>
</main>
<div id="scrim"></div>
<aside id="sidebar" aria-hidden="true">
  <div class="side-head">
    <h3 style="margin:0">Notifications</h3>
    <div class="spacer"></div>
    <button id="closeSidebar" class="icon" title="Close" aria-label="Close">âœ•</button>
  </div>
  <div class="side-body" id="sideBody">
    <div style="margin-top:8px;" class="row-muted">Select items to receive notifications when in-stock.</div>
    <div id="sectionsWrap"></div>
    <div style="margin-top:8px;" id="watchlist"></div>
    <div style="margin-top:8px;" class="row-muted">Your selections + theme are saved locally.</div>
  </div>
</aside>
<script>
const SEEDS = ["Carrot","Strawberry","Blueberry","Tomato"];
const GEARS = ["Watering Can","Trowel"];
const EGGS = ["Common Egg","Rare Egg"];
const API_URL = 'https://api.joshlei.com/v2/growagarden/stock';
const API_INFO = id => `https://api.joshlei.com/v2/growagarden/info/${id}`;
const API_KEY = 'js_c5d322d0652bc477f50348450bb2c6fe4f4d767042b2b0facb69b074c3d46f46';
const POLL_MS = 30000;
let infoCache = loadJSON('gg_info_cache', {});
let latestStock = null;
let openCardsSet = new Set();
let sidebarGroupState = loadJSON('gg_sidebar_groups', {});
let watchSet = new Set(loadJSON('gg_watch', []));
/* Helpers */
function loadJSON(k,f){try{return JSON.parse(localStorage.getItem(k)??JSON.stringify(f));}catch(e){return f;}}
function saveJSON(k,v){localStorage.setItem(k,JSON.stringify(v));}
function timeAgo(s){
  if(!s) return 'â€”';
  const now=Math.floor(Date.now()/1000);let diff=Math.max(0,now-Number(s));
  const units=[['y',365*24*3600],['mo',30*24*3600],['w',7*24*3600],['d',24*3600],['h',3600],['m',60],['s',1]];
  for(const [u,sec] of units){if(diff>=sec){const v=Math.floor(diff/sec);return `${v}${u} ago`;}} return 'just now';
}
function imgFor(displayName, apiIcon){return apiIcon||`https://via.placeholder.com/80?text=${encodeURIComponent(displayName.slice(0,2))}`;}
/* Theme toggle */
(function initTheme(){
  const dark = localStorage.getItem('gg_dark')==='true';
  document.documentElement.classList.toggle('dark',dark);
  updateThemeIcon();
})();
document.getElementById('darkToggle').addEventListener('click',()=>{
  const nowDark=!document.documentElement.classList.contains('dark');
  document.documentElement.classList.toggle('dark',nowDark);
  localStorage.setItem('gg_dark',String(nowDark));
  updateThemeIcon();
});
function updateThemeIcon(){
  const el=document.getElementById('darkIcon');if(!el) return;
  el.src=document.documentElement.classList.contains('dark')?'https://img.icons8.com/ios-filled/24/ffffff/moon-symbol.png':'https://img.icons8.com/ios-filled/24/000000/contrast.png';
}
/* Sidebar open/close */
const sidebarEl = document.getElementById('sidebar'), scrim = document.getElementById('scrim');
function openSidebar(){sidebarEl.style.transform='translateX(0)';scrim.style.display='block';sidebarEl.setAttribute('aria-hidden','false');}
function closeSidebar(){sidebarEl.style.transform='translateX(110%)';scrim.style.display='none';sidebarEl.setAttribute('aria-hidden','true');}
document.getElementById('openSidebar').addEventListener('click',openSidebar);
document.getElementById('closeSidebar').addEventListener('click',closeSidebar);
scrim.addEventListener('click',closeSidebar);
/* Live polling */
async function fetchJSON(url, options={}){const res=await fetch(url,options);if(!res.ok)throw new Error(`HTTP ${res.status}`);return res.json();}
let statusPill = document.getElementById('statusPill'), updatedAt = document.getElementById('updatedAt'), categoriesEl = document.getElementById('categories');
async function fetchStock(){
  try{
    statusPill.textContent='Loadingâ€¦';
    const data = await fetchJSON(API_URL,{headers:{'accept':'application/json','jstudio-key':API_KEY}});
    latestStock=data;
    statusPill.textContent='Live';
    updatedAt.textContent = `Updated: ${new Date().toLocaleString()}`;
    renderAll(data);
    if(Notification && Notification.permission!=='denied') Notification.requestPermission().catch(()=>{});
    notifyItemsFromLists();
  }catch(e){console.error(e);statusPill.textContent='Error';}
}
setInterval(fetchStock,POLL_MS);fetchStock();
/* Render Cards and Watch/Notify Logic */
function categorySpec(data){
  return [
    {key:'seed_stock',title:'Seeds',items:SEEDS,live:data.seed_stock||[]},
    {key:'gear_stock',title:'Gears',items:GEARS,live:data.gear_stock||[]},
    {key:'egg_stock',title:'Eggs',items:EGGS,live:data.egg_stock||[]}
  ];
}
function renderAll(data){
  categoriesEl.innerHTML = '';
  for(const cat of categorySpec(data)){
    const card = document.createElement('section');card.className='card';
    const header = document.createElement('div');header.className='card-header';
    header.innerHTML = `<h2>${cat.title}</h2><div style="display:flex;align-items:center;gap:10px"><span class="badge">${cat.live.length}</span><span class="chev">â–¾</span></div>`;
    const body = document.createElement('div');body.className='card-body';
    const list = document.createElement('div');list.className='list';
    body.appendChild(list);card.appendChild(header);card.appendChild(body);categoriesEl.appendChild(card);
    card.classList.add('open');body.style.maxHeight = '2000px';
    header.addEventListener('click',()=>{card.classList.toggle('open');
      body.style.maxHeight=card.classList.contains('open')?'2000px':'0px';
    });
    for(const item of cat.live){
      const el = document.createElement('div');el.className='item';
      if(Number(item.quantity)===0) el.classList.add('dim');
      const iconUrl = imgFor(item.display_name,item.icon);
      el.innerHTML = `
        <img src="${iconUrl}" alt="">
        <div class="meta">
          <div class="name">${item.display_name}</div>
          <div class="sub">Price: ${item.price||'?'}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;">
          <div class="qty" title="Amount in stock">Ã— ${item.quantity}</div>
        </div>
      `;
      list.appendChild(el);
    }
  }
  buildSideSections();
  renderWatchlist();
}
function buildSideSections(){
  const sectionsWrap = document.getElementById('sectionsWrap');
  sectionsWrap.innerHTML='';
  for(const group of [
      {label:'Seeds',live:latestStock?.seed_stock||[],names:SEEDS},
      {label:'Gears',live:latestStock?.gear_stock||[],names:GEARS},
      {label:'Eggs',live:latestStock?.egg_stock||[],names:EGGS}
    ])
  {
    const sec = document.createElement('div');sec.className='side-section open';
    const head = document.createElement('div');head.className='sec-head';
    head.innerHTML = `<div style="font-weight:700">${group.label}</div><div class="row-muted" id="count-${group.label}">${group.live.length} present</div>`;
    const body = document.createElement('div');body.className='sec-body';
    const seen = new Set();
    for(const it of group.live){if(seen.has(it.display_name))continue;seen.add(it.display_name);body.appendChild(makeChipFor(it.display_name,it.icon));}
    for(const name of group.names){if(seen.has(name))continue;seen.add(name);body.appendChild(makeChipFor(name,''));}
    sec.appendChild(head);sec.appendChild(body);sectionsWrap.appendChild(sec);
    head.addEventListener('click',()=>{sec.classList.toggle('open');body.style.maxHeight=sec.classList.contains('open')?'2000px':'0px';});
  }
  function makeChipFor(displayName,icon){
    const lab=document.createElement('label');lab.className='chip';
    lab.innerHTML = `<input type="checkbox" value="${displayName}"><img src="${icon||''}" alt=""><span>${displayName}</span>`;
    const cb=lab.querySelector('input');cb.checked=watchSet.has(displayName);
    cb.addEventListener('change',()=>{if(cb.checked)watchSet.add(displayName);else watchSet.delete(displayName);saveJSON('gg_watch',[...watchSet]);renderWatchlist();});
    return lab;
  }
}
function renderWatchlist(){
  const wrap = document.getElementById('watchlist');
  wrap.innerHTML='';
  const names=[...watchSet].sort((a,b)=>a.localeCompare(b));
  if(names.length===0){wrap.innerHTML=`<div class="row-muted">No items selected yet.</div>`;return;}
  for(const name of names){
    let qty=0,icon='';let found=false;
    ['seed_stock','gear_stock','egg_stock'].forEach(key=>{
      if(latestStock&&latestStock[key]){for(const it of latestStock[key]){if(it.display_name===name){qty=Number(it.quantity)||0;icon=it.icon;found=true;}}}
    });
    wrap.innerHTML += `<div class="notif-row"><img src="${icon||''}" alt=""><div style="min-width:0"><div style="font-weight:700">${name}</div></div><div class="tick ${qty>0?'good':'bad'}">${qty>0?'âœ“':'âœ—'}</div></div>`;
  }
}
/* Only notify about watched items! */
function notifyItemsFromLists(){
  if(!latestStock||!("Notification" in window))return;
  if(!notifyItemsFromLists.seen) notifyItemsFromLists.seen = new Set();
  // Gather all current "stock" items for relevant pools:
  const pools = [latestStock.seed_stock||[],latestStock.gear_stock||[],latestStock.egg_stock||[]].flat();
  // Only notify for watched!
  [...watchSet].forEach(displayName=>{
    const matches = pools.filter(it=>it.display_name===displayName && Number(it.quantity)>0);
    for(const it of matches){
      const key = `${it.display_name}@${it.start_date_unix||''}-${it.end_date_unix||''}`;
      if(!notifyItemsFromLists.seen.has(key)){
        if(Notification.permission==='granted'){
          new Notification(`Item in stock: ${it.display_name}`, { body: `Quantity: ${it.quantity}`, icon: it.icon||'' });
        }
        notifyItemsFromLists.seen.add(key);
      }
    }
  });
}
</script>
</body>
</html>
