<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grow A Garden - Stock</title>
  <link href="https://fonts.googleapis.com/css?family=Luckiest+Guy&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: #6cc45e;
      font-family: 'Luckiest Guy', Arial, sans-serif;
      display: flex;
      align-items: flex-start;
      height: 100vh;
      justify-content: center;
    }
    .window {
      background: #634026;
      border: 4px solid #286c13;
      border-radius: 12px;
      box-shadow: 0 0 8px #372317, 0 4px #372317 inset;
      width: 1200px;
      margin-top: 48px;
      padding: 0 0 20px 0;
      box-sizing: border-box;
    }
    .header {
      background: #459830;
      color: #fff;
      font-size: 1.4em;
      padding: 12px 18px;
      border-radius: 7px 7px 0 0;
      letter-spacing: 1px;
      border-bottom: 4px solid #2e3c26;
      font-family: 'Luckiest Guy', Arial, sans-serif;
      text-shadow: 2px 2px 0 #287428, 1px 1px 0 #2e3c26;
    }
    .stocks-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 24px;
      padding: 22px 22px 0 22px;
    }
    .stock-column {
      flex: 1;
      background: #73512a;
      border-radius: 10px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      max-height: 600px;
      min-width: 0;
      box-shadow: 0 2px #513f24 inset;
      overflow-y: auto;
    }
    .stock-title {
      color: #fff;
      font-size: 1.25em;
      font-family: 'Luckiest Guy', Arial, sans-serif;
      margin-bottom: 8px;
      letter-spacing: .5px;
      text-align: center;
      text-shadow: 2px 2px 0 #503113;
    }
    .restock-timer {
      color: #ffe957;
      font-size: 1.08em;
      font-family: 'Luckiest Guy', Arial, sans-serif;
      text-align: center;
      margin-bottom: 8px;
      margin-top: -3px;
      text-shadow: 1px 1px 0 #2e3c26;
    }
    .item-card {
      display: flex;
      align-items: center;
      gap: 14px;
      background: #835132;
      border: 3px solid #523316;
      border-radius: 10px;
      padding: 12px 14px;
      margin: 16px 0 0 0;
      box-shadow: 0 2px #523316 inset;
      transition: transform 0.08s;
    }
    .item-card:first-of-type { margin-top: 0 }
    .item-card:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 8px #52331666, 0 2px #523316 inset;
      z-index: 2;
    }
    .item-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #af9663;
      border-radius: 8px;
      padding: 8px;
      border: 2px solid #af9663;
      min-width: 48px;
      min-height: 48px;
    }
    .item-icon img {
      width: 42px;
      height: 42px;
      image-rendering: pixelated;
    }
    .item-info {
      flex: 1;
      min-width: 0;
    }
    .item-name {
      font-size: 1.15em;
      color: #fff;
      font-family: 'Luckiest Guy', Arial, sans-serif;
      line-height: 1.1;
      text-shadow: 2px 2px 0 #212121;
      letter-spacing: .5px;
    }
    .item-stock {
      color: #e2daae;
      font-size: 1em;
      margin: 4px 0 4px 0;
      font-weight: bold;
      text-shadow: 1px 1px 0 #513f24;
    }
    @media (max-width: 1100px) {
      .window { width: 100vw; }
      .stocks-row { flex-direction: column; gap: 0;}
      .stock-column { max-height: none; margin-bottom: 24px; }
    }
  </style>
</head>
<body>
  <div class="window">
    <div class="header">Garden Inventory</div>
    <div class="stocks-row">
      <div class="stock-column" id="seedsCol">
        <div class="stock-title">Seeds</div>
        <div class="restock-timer" id="timer-seeds"></div>
      </div>
      <div class="stock-column" id="gearCol">
        <div class="stock-title">Gear</div>
        <div class="restock-timer" id="timer-gear"></div>
      </div>
      <div class="stock-column" id="eggsCol">
        <div class="stock-title">Eggs</div>
        <div class="restock-timer" id="timer-eggs"></div>
      </div>
    </div>
  </div>
  <script>
    const API_URL = 'https://api.joshlei.com/v2/growagarden/stock';
    const JSTUDIO_KEY = 'js_c5d322d0652bc477f50348450bb2c6fe4f4d767042b2b0facb69b074c3d46f46';

    // --- TIMER LOGIC ---
    function formatCountdown(ms) {
      const totalSeconds = Math.max(0, Math.floor(ms / 1000));
      const d = Math.floor(totalSeconds / 86400);
      const h = Math.floor((totalSeconds % 86400) / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      const parts = [];
      if (d) parts.push(`${d}d`);
      if (h) parts.push(`${h}h`);
      if (m) parts.push(`${m}m`);
      if (!parts.length || s) parts.push(`${s}s`);
      return parts.join(" ");
    }

    function calculateRestockTimes() {
      const now = Date.now();
      const dayStart = new Date().setHours(0, 0, 0, 0);
      const next = ms => dayStart + Math.ceil((now - dayStart) / ms) * ms;
      return {
        seeds: next(5 * 60 * 1000),
        gear: next(5 * 60 * 1000),
        egg: next(30 * 60 * 1000)
      };
    }

    function startRestockCountdowns() {
      const timerEls = {
        seeds: document.getElementById('timer-seeds'),
        gear: document.getElementById('timer-gear'),
        egg:  document.getElementById('timer-eggs')
      };

      function updateTimers() {
        const now = Date.now();
        const times = calculateRestockTimes();

        timerEls.seeds.textContent = 'Restocks in: ' + formatCountdown(times.seeds - now);
        timerEls.gear.textContent  = 'Restocks in: ' + formatCountdown(times.gear  - now);
        timerEls.egg.textContent   = 'Restocks in: ' + formatCountdown(times.egg   - now);
      }

      updateTimers();
      setInterval(updateTimers, 1000);
    }

    // --- STOCK LOGIC ---
    function renderStockCards(stockArray, targetElem, typeLabel) {
      // Remove previous loading/error messages only (not timer/title).
      targetElem.querySelectorAll('.stock-card, .empty-msg').forEach(el => el.remove());

      if (!stockArray || !stockArray.length) {
        const msg = document.createElement('div');
        msg.className = 'empty-msg';
        msg.style = 'color:#fff;font-size:1em;margin-top:15px;text-align:center;';
        msg.textContent = `No ${typeLabel.toLowerCase()} in stock.`;
        targetElem.appendChild(msg);
        return;
      }
      stockArray.forEach(item => {
        const card = document.createElement('div');
        card.className = 'item-card';
        card.innerHTML = `
          <div class="item-icon">
            <img src="${item.icon}" alt="${item.display_name} icon" />
          </div>
          <div class="item-info">
            <div class="item-name">${item.display_name}</div>
            <div class="item-stock">Stock: <b>${item.quantity}</b></div>
          </div>
        `;
        targetElem.appendChild(card);
      });
    }

    async function loadStock() {
      const seedsCol = document.getElementById('seedsCol');
      const gearCol  = document.getElementById('gearCol');
      const eggsCol  = document.getElementById('eggsCol');

      // Show loading messages
      [seedsCol, gearCol, eggsCol].forEach(col => {
        col.querySelectorAll('.stock-card, .empty-msg').forEach(el => el.remove());
        col.querySelector('.restock-timer').insertAdjacentHTML("afterend",
          `<div class="loading-msg" style="color:#fff;font-size:1em;text-align:center;margin-top:10px;">Loading...</div>`
        );
      });

      try {
        const res = await fetch(API_URL, { headers: { 'jstudio-key': JSTUDIO_KEY } });
        if (!res.ok) throw new Error("API error: " + res.status);
        const data = await res.json();

        renderStockCards(data.seed_stock || [], seedsCol, "Seeds");
        renderStockCards(data.gear_stock || [], gearCol, "Gear");
        renderStockCards(data.egg_stock || [], eggsCol, "Eggs");

        // Remove loading messages
        document.querySelectorAll('.loading-msg').forEach(el => el.remove());
      } catch (e) {
        [seedsCol, gearCol, eggsCol].forEach((col, i) => {
          const typ = ["Seeds", "Gear", "Eggs"][i];
          col.innerHTML = `<div class="stock-title">${typ}</div>
          <div class="restock-timer" id="timer-${typ.toLowerCase()}"></div>
          <div style="color:#fff;font-size:1em;text-align:center;margin-top:12px;">Error loading data.</div>`;
        });
      }
    }

    window.onload = function() {
      startRestockCountdowns();
      loadStock();
    };
  </script>
</body>
</html>
