<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Grow a Garden — Stock Monitor (updated)</title><style>:root{--bg:#f6f7fb;--card:#fff;--text:#1f2330;--muted:#707789;--accent:#6b7cff;--accent-2:#50e3c2;--border:#e6e8f0;--good:#18a957;--bad:#e24a4a;--shadow:0 6px 20px rgba(0,0,0,.08);--glass-bg:rgba(255,255,255,0.6);--icon-filter:none;--btn-dark-bg:rgba(255,255,255,0.06);--hover-ease:cubic-bezier(.2,.9,.2,1)}html.dark{--bg:#0d0f15;--card:#0f1720;--text:#dfe6ff;--muted:#9aa3b2;--accent:#8d9bff;--accent-2:#65f2d0;--border:#1e2433;--shadow:0 10px 32px rgba(0,0,0,.6);--glass-bg:rgba(8,12,18,0.55);--icon-filter:invert(1) brightness(2);--btn-dark-bg:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02))}*{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}a{color:inherit;text-decoration:none}header{position:sticky;top:0;z-index:60;backdrop-filter:saturate(120%) blur(8px);background:linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,0))}.bar{display:flex;align-items:center;gap:10px;padding:12px 18px;max-width:1200px;margin:0 auto}.title{font-weight:800;letter-spacing:.3px;font-size:18px;display:flex;align-items:center;gap:10px}.pill{padding:4px 10px;border-radius:999px;background:var(--card);border:1px solid var(--border);color:var(--muted);font-size:12px}.spacer{flex:1}button.icon{border:none;background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);width:38px;height:38px;border-radius:12px;display:grid;place-items:center;cursor:pointer;transition:transform .14s var(--hover-ease),box-shadow .14s var(--hover-ease),background .12s var(--hover-ease)}button.icon:hover{transform:translateY(-4px);box-shadow:0 18px 36px rgba(0,0,0,0.12)}button.icon img{width:18px;height:18px;display:block;filter:var(--icon-filter);transition:filter .12s ease}html.dark button.icon{background:var(--btn-dark-bg);border-color:var(--border)}.row{max-width:1200px;margin:0 auto;padding:18px}.categories{display:grid;grid-template-columns:1fr;gap:14px}@media(min-width:880px){.categories{grid-template-columns:1fr 1fr}}@media(min-width:1180px){.categories{grid-template-columns:1fr 1fr}}.card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden;transition:transform .14s var(--hover-ease),box-shadow .14s var(--hover-ease)}.card:hover{transform:translateY(-6px);box-shadow:0 20px 48px rgba(0,0,0,0.12)}.card-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;cursor:pointer}.card-header h2{margin:0;font-size:16px}.badge{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;padding:4px 10px;font-size:12px;border-radius:999px;font-weight:700}.chev{transition:transform .3s ease;opacity:.85}.card.open .chev{transform:rotate(180deg)}.card-body{overflow:hidden;max-height:0;transition:max-height .45s cubic-bezier(.2,.8,.2,1),opacity .25s ease;opacity:0;border-top:1px dashed var(--border)}.card.open .card-body{opacity:1}.list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;padding:12px}.item{display:flex;gap:12px;align-items:center;padding:10px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg, rgba(0,0,0,.02), transparent);transition:transform .12s var(--hover-ease),box-shadow .12s var(--hover-ease),border-color .12s}.item:hover{transform:translateY(-6px);box-shadow:0 14px 36px rgba(0,0,0,0.08);border-color:rgba(0,0,0,0.06)}.item.dim{opacity:.45;filter:grayscale(.35)}.item img{width:44px;height:44px;border-radius:10px;object-fit:cover;background:#00000008}.meta{display:flex;flex-direction:column;gap:2px;min-width:0}.name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.qty{margin-left:auto;font-weight:800;text-align:right}.restock{display:block;font-size:12px;color:var(--muted);margin-top:4px}.chip{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;border:1px solid var(--border);margin:4px;cursor:pointer;background:var(--card);transition:transform .12s var(--hover-ease),box-shadow .12s var(--hover-ease)}.chip img{width:20px;height:20px;border-radius:6px;object-fit:cover}.chip:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.08)}.row-muted{color:var(--muted);font-size:13px}.notif-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}.notif-row img{width:36px;height:36px;border-radius:6px;object-fit:cover}.tick{margin-left:auto;padding:6px 10px;border-radius:10px;font-weight:700;color:#fff}.tick.good{background:var(--good)}.tick.bad{background:var(--bad)}.fade-in{animation:fadeIn .22s var(--hover-ease) both}@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}aside#sidebar{position:fixed;right:0;top:0;height:100%;width:360px;background:var(--card);box-shadow:var(--shadow);padding:12px;transform:translateX(110%);transition:transform .25s var(--hover-ease);z-index:70;display:flex;flex-direction:column}.side-head{display:flex;align-items:center;gap:8px}.side-body{margin-top:10px;overflow:auto;padding-right:8px;flex:1}.side-section{border-radius:10px;padding:8px;border:1px solid var(--border);margin-bottom:10px;background:transparent}.sec-head{display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:6px}.sec-body{overflow:hidden;max-height:0;transition:max-height .28s var(--hover-ease);padding-top:6px}.side-section.open .sec-body{max-height:420px}#modalOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:200;background:rgba(6,8,12,0.48);backdrop-filter:blur(6px) saturate(120%);padding:20px}#modalOverlay.show{display:flex}#modalContent{width:min(1100px,96vw);max-height:88vh;overflow:auto;border-radius:14px;background:var(--card);color:var(--text);border:1px solid var(--border);box-shadow:var(--shadow);padding:18px;position:relative;transform:translateY(12px) scale(.98);opacity:0;transition:transform .28s var(--hover-ease),opacity .2s ease}#modalOverlay.show #modalContent{transform:translateY(0) scale(1);opacity:1}#closeModal{position:absolute;right:12px;top:10px;border-radius:8px;border:none;background:transparent;color:var(--muted);font-size:18px;cursor:pointer}.enc-tabs{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:center;margin-top:10px}.enc-tab{padding:6px 10px;border-radius:8px;border:1px solid transparent;color:var(--muted);cursor:pointer;transition:transform .12s var(--hover-ease),box-shadow .12s var(--hover-ease)}.enc-tab:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.06)}.enc-tab.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;border-color:transparent}.segmented{display:flex;gap:8px;flex-wrap:wrap}.seg-btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);cursor:pointer;transition:transform .12s var(--hover-ease),box-shadow .12s var(--hover-ease),background .12s}.seg-btn:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.08)}.seg-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;border-color:transparent}.mut-chip{padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer;transition:transform .12s var(--hover-ease),box-shadow .12s var(--hover-ease)}.mut-chip:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.08)}.mut-chip.selected{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;border-color:transparent}html.dark .seg-btn,html.dark .mut-chip,html.dark .enc-tab,html.dark button.icon{background:var(--btn-dark-bg);color:#fff;border-color:rgba(255,255,255,0.06)}html.dark .seg-btn:hover,html.dark .mut-chip:hover,html.dark .enc-tab:hover,html.dark button.icon:hover{transform:translateY(-5px);box-shadow:0 18px 40px rgba(0,0,0,0.45)}.enc-table tbody tr:hover{background:linear-gradient(90deg, rgba(0,0,0,0.03), transparent);transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.04)}@media(max-width:720px){aside#sidebar{width:100%}.list{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}.item img{width:38px;height:38px}}</style></head><body><header><div class="bar"><div class="title">🌱 Grow a Garden <span class="pill" id="statusPill">Connecting…</span></div><div class="spacer"></div><button id="darkToggle" class="icon" title="Toggle theme" aria-label="Toggle theme"><img id="darkIcon" src="https://img.icons8.com/ios-filled/24/000000/contrast.png" alt="theme"></button><button id="calculatorBtn" class="icon" title="Calculator" aria-label="Calculator"><img src="https://img.icons8.com/ios-filled/24/000000/calculator.png" alt="Calculator"></button><button id="encyclopediaBtn" class="icon" title="Encyclopedia" aria-label="Encyclopedia"><img src="https://img.icons8.com/ios-filled/24/000000/book.png" alt="Encyclopedia"></button><button id="openSidebar" class="icon" title="Notifications" aria-label="Notifications"><img src="https://img.icons8.com/ios-filled/24/000000/bell.png" alt="Notifications"></button></div></header><main class="row"><div style="display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap;"><div class="row-muted" id="updatedAt">—</div><div id="restockTimers" class="row-muted" style="margin-left:auto;"></div></div><div class="categories" id="categories"></div></div></main><div id="scrim" style="display:none;position:fixed;inset:0;z-index:60;"></div><aside id="sidebar" aria-hidden="true"><div class="side-head"><h3 style="margin:0">Notifications</h3><div class="spacer"></div><button id="closeSidebar" class="icon" title="Close" aria-label="Close">✕</button></div><div class="side-body" id="sideBody"><div style="margin-top:8px;" class="row-muted">Select items to receive notifications when in-stock.</div><div id="sectionsWrap"></div><div style="margin-top:8px;" id="watchlist"></div><div style="margin-top:8px;" class="row-muted">Your selections + theme are saved locally.</div></div></aside><div id="modalOverlay" aria-hidden="true"><div id="modalContent" role="dialog" aria-modal="true" aria-labelledby="modalTitle"><button id="closeModal" title="Close">✕</button><div id="modalTitle" style="font-weight:800;margin-bottom:8px">Loading…</div><div id="modalBody"></div></div></div><script>const SEEDS=["Carrot","Strawberry","Blueberry","Tomato","Daffodil","Watermelon","Pumpkin","Apple","Bamboo","Coconut","Cactus","Dragon Fruit","Mango","Grape","Mushroom","Pepper","Cacao","Beanstalk","Ember lily","Sugar Apple","Burning Bud","Giant Pinecone","Elder Strawberry","Romanesco"],GEARS=["Watering Can","Trowel","Recall Wrench","Basic Sprinkler","Advanced Sprinkler","Medium Toy","Medium Treat","Godly Sprinkler","Magnifying Glass","Tanning Mirror","Master Sprinkler","Cleaning Spray","Favorite Tool","Harvest Tool","Friendship Pot","Levelup Lolipop"],EGGS=["Common Egg","Common Summer Egg","Rare Summer Egg","Mythical Egg","Paradise Egg","Bug Egg"],VARIANTS=[{id:'',label:'None',mult:1},{id:'ripe',label:'🍎 Ripe (x1)',mult:1},{id:'gold',label:'🪙 Gold (x20)',mult:20},{id:'rainbow',label:'🌈 Rainbow (x50)',mult:50}],WEATHER_VARIANTS=[{id:'',label:'None',mult:1},{id:'wet',label:'💧 Wet (x2)',mult:2},{id:'chilled',label:'❄️ Chilled (x2)',mult:2},{id:'drenched',label:'🌧️ Drenched (x5)',mult:5},{id:'frozen',label:'🧊 Frozen (x10)',mult:10}],MUTATIONS=[{id:'windstruck',label:'🌬️ Windstruck',mult:2},{id:'twisted',label:'🌪️ Twisted',mult:5},{id:'tempestous',label:'⛈️ Tempestous',mult:12},{id:'bloodlit',label:'🩸 Bloodlit',mult:4},{id:'aurora',label:'🌌 Aurora',mult:90},{id:'shocked',label:'⚡ Shocked',mult:100},{id:'celestial',label:'🌠 Celestial',mult:120},{id:'pollinated',label:'🐝 Pollinated',mult:3},{id:'burnt',label:'🔥 Burnt',mult:4},{id:'verdant',label:'🌿 Verdant',mult:4},{id:'cloudtouched',label:'☁️ Cloudtouched',mult:5},{id:'honeyglazed',label:'🍯 HoneyGlazed',mult:5},{id:'plasma',label:'🧪 Plasma',mult:5},{id:'heavenly',label:'😇 Heavenly',mult:5},{id:'fried',label:'🍳 Fried',mult:8},{id:'cooked',label:'🍲 Cooked',mult:10},{id:'zombified',label:'🧟 Zombified',mult:25},{id:'molten',label:'🌋 Molten',mult:25},{id:'sundried',label:'☀️ Sundried',mult:85},{id:'paradisal',label:'🏝️ Paradisal',mult:100},{id:'alienlike',label:'👽 Alienlike',mult:100},{id:'galactic',label:'🪐 Galactic',mult:120},{id:'disco',label:'🪩 Disco',mult:125},{id:'voidtouched',label:'🌑 Voidtouched',mult:135},{id:'dawnbound',label:'🌅 Dawnbound',mult:150},{id:'sandy',label:'🏖️ Sandy',mult:3},{id:'clay',label:'🧱 Clay',mult:5},{id:'ceramic',label:'🏺 Ceramic',mult:30},{id:'amber',label:'🟠 Amber',mult:10},{id:'oldamber',label:'🔶 OldAmber',mult:20},{id:'ancientamber',label:'🟤 AncientAmber',mult:50},{id:'friendbound',label:'🤝 Friendbound',mult:70},{id:'infected',label:'🧫 Infected',mult:75},{id:'tranquil',label:'🧘 Tranquil',mult:20},{id:'chakra',label:'🌀 Chakra',mult:15},{id:'toxic',label:'☣️ Toxic',mult:12},{id:'radioactive',label:'☢️ Radioactive',mult:80},{id:'foxfire',label:'🦊 Foxfire',mult:90},{id:'static',label:'⚛️ Static',mult:8},{id:'jackpot',label:'🎰 Jackpot',mult:15},{id:'corrupted',label:'🦠 Corrupted',mult:20},{id:'harm_foxfire',label:'🦊 Harmonised Foxfire',mult:190},{id:'touchdown',label:'🏈 Touchdown',mult:105},{id:'blitzshock',label:'⚡ Blitzshock',mult:50},{id:'subzero',label:'❄️ Subzero',mult:40},{id:'harm_chakra',label:'🌀 Harmonised Chakra',mult:35},{id:'sliced',label:'🔪 Sliced',mult:50},{id:'sauced',label:'🍜 Sauced',mult:3},{id:'pasta',label:'🍝 Pasta',mult:3},{id:'meatballed',label:'🍖 Meatballed',mult:3},{id:'acidic',label:'🧪 Acidic',mult:15},{id:'spaghetti',label:'🍝 Spaghetti',mult:12},{id:'aromatic',label:'🌿 Aromatic',mult:15},{id:'oil',label:'🛢️ Oil',mult:15},{id:'boil',label:'💧 Boil',mult:15},{id:'junkshock',label:'⚡ Junkshock',mult:45},{id:'bloom',label:'🌸 Bloom',mult:8},{id:'eclipse',label:'🌒 Eclipse',mult:25},{id:'fortune',label:'🍀 Fortune',mult:50},{id:'lightcycle',label:'🔄 Lightcycle',mult:50}];const API_URL='https://api.joshlei.com/v2/growagarden/stock',API_INFO=id=>`https://api.joshlei.com/v2/growagarden/info/${id}`,API_KEY='js_c5d322d0652bc477f50348450bb2c6fe4f4d767042b2b0facb69b074c3d46f46',POLL_MS=30000,INFO_TTL_MS=5*60*1000,BIG_PRICE_LIMIT=100000000000000000;let infoCache=loadJSON('gg_info_cache',{}),latestStock=null,firstLoadDone=false,openCardsSet=new Set(),restockTimes=calculateRestockTimes(),sidebarGroupState=loadJSON('gg_sidebar_groups',{}),notifiedSet=new Set(),watchSet=new Set(loadJSON('gg_watch',[]));function loadJSON(k,f){try{return JSON.parse(localStorage.getItem(k)??JSON.stringify(f))}catch(e){return f}}function saveJSON(k,v){localStorage.setItem(k,JSON.stringify(v))}function timeAgo(s){if(!s)return'—';const now=Math.floor(Date.now()/1000);let diff=Math.max(0,now-Number(s));const units=[['y',365*24*3600],['mo',30*24*3600],['w',7*24*3600],['d',24*3600],['h',3600],['m',60],['s',1]];for(const [u,sec]of units)if(diff>=sec){const v=Math.floor(diff/sec);return`${v}${u} ago`}return'just now'}function formatPriceNum(price){if(price==null||price===''||isNaN(Number(price)))return null;const n=parseInt(price);if(n>=BIG_PRICE_LIMIT)return null;return n.toLocaleString()}function formatCountdown(ms){const totalSeconds=Math.max(0,Math.floor(ms/1000));const d=Math.floor(totalSeconds/86400);const h=Math.floor((totalSeconds%86400)/3600);const m=Math.floor((totalSeconds%3600)/60);const s=totalSeconds%60;const parts=[];if(d)parts.push(`${d}d`);if(h)parts.push(`${h}h`);if(m)parts.push(`${m}m`);if(!parts.length||s)parts.push(`${s}s`);return parts.join(' ')}function calculateRestockTimes(){const now=Date.now();const dayStart=new Date().setHours(0,0,0,0);const next=ms=>dayStart+Math.ceil((now-dayStart)/ms)*ms;return{seeds:next(5*60*1000),gear:next(5*60*1000),egg:next(30*60*1000),cosmetics:next(4*60*60*1000),event:next(1*60*60*1000)}}const statusPill=document.getElementById('statusPill'),updatedAt=document.getElementById('updatedAt'),categoriesEl=document.getElementById('categories'),sectionsWrap=document.getElementById('sectionsWrap'),sidebarEl=document.getElementById('sidebar'),scrim=document.getElementById('scrim'),modalOverlay=document.getElementById('modalOverlay'),modalContent=document.getElementById('modalContent'),modalTitle=document.getElementById('modalTitle'),modalBody=document.getElementById('modalBody'),restockTimersEl=document.getElementById('restockTimers');(function initTheme(){const dark=localStorage.getItem('gg_dark')==='true';document.documentElement.classList.toggle('dark',dark);updateThemeIcon()})();document.getElementById('darkToggle')?.addEventListener('click',()=>{const nowDark=!document.documentElement.classList.contains('dark');document.documentElement.classList.toggle('dark',nowDark);localStorage.setItem('gg_dark',String(nowDark));updateThemeIcon()});function updateThemeIcon(){const el=document.getElementById('darkIcon');if(!el)return;el.src=document.documentElement.classList.contains('dark')?'https://img.icons8.com/ios-filled/24/ffffff/moon-symbol.png':'https://img.icons8.com/ios-filled/24/000000/contrast.png'}function openSidebar(){sidebarEl.style.transform='translateX(0)';scrim.style.display='block';sidebarEl.setAttribute('aria-hidden','false');localStorage.setItem('gg_sidebar_open','true')}function closeSidebar(){sidebarEl.style.transform='translateX(110%)';scrim.style.display='none';sidebarEl.setAttribute('aria-hidden','true');localStorage.setItem('gg_sidebar_open','false')}document.getElementById('openSidebar')?.addEventListener('click',openSidebar);document.getElementById('closeSidebar')?.addEventListener('click',closeSidebar);scrim.addEventListener('click',closeSidebar);if(localStorage.getItem('gg_sidebar_open')==='true')openSidebar();async function fetchJSON(url,options={}){const res=await fetch(url,options);if(!res.ok)throw new Error(`HTTP ${res.status}`);return res.json()}async function fetchStock(){try{statusPill.textContent='Loading…';const data=await fetchJSON(API_URL,{headers:{accept:'application/json','jstudio-key':API_KEY}});preserveOpenCards();latestStock=data;statusPill.textContent='Live';updatedAt.textContent=`Updated: ${new Date().toLocaleString()}`;restockTimes=calculateRestockTimes();renderAll(data);if(Notification&&Notification.permission!=='denied')Notification.requestPermission().catch(()=>{});if(!firstLoadDone){firstLoadDone=true;const loader=document.getElementById('loading');if(loader)loader.remove()}notifyItemsOnly();}catch(e){console.error(e);statusPill.textContent='Error'}}setInterval(fetchStock,POLL_MS);fetchStock();function preserveOpenCards(){openCardsSet.clear();const opens=categoriesEl.querySelectorAll('.card.open .card-header h2');for(const h of opens)openCardsSet.add(h.textContent.trim())}function categorySpec(data){return[{key:'seed_stock',title:'Seeds',restKey:'seeds'},{key:'gear_stock',title:'Gears',restKey:'gear'},{key:'egg_stock',title:'Eggs',restKey:'egg'},{key:'cosmetic_stock',title:'Cosmetics',restKey:'cosmetics'},{key:'eventshop_stock',title:'Event Shop',restKey:'event'}].map(k=>({...k,items:(data[k.key]??[])}))}function imgFor(displayName,apiIcon){return apiIcon||`https://via.placeholder.com/80?text=${encodeURIComponent((displayName||'').slice(0,2))}`}function renderAll(data){categoriesEl.innerHTML='';for(const cat of categorySpec(data)){const card=document.createElement('section');card.className='card fade-in';const header=document.createElement('div');header.className='card-header';header.innerHTML=`<h2>${cat.title}</h2><div style="display:flex;align-items:center;gap:10px"><span class="badge">${cat.items.length}</span><span class="chev">▾</span></div>`;const body=document.createElement('div');body.className='card-body';const list=document.createElement('div');list.className='list';body.appendChild(list);card.appendChild(header);card.appendChild(body);categoriesEl.appendChild(card);if(openCardsSet.has(cat.title))card.classList.add('open');ensureAccordion(card,body);header.addEventListener('click',()=>{card.classList.toggle('open');ensureAccordion(card,body);const t=header.querySelector('h2').textContent.trim();if(card.classList.contains('open'))openCardsSet.add(t);else openCardsSet.delete(t)});for(const item of cat.items){const el=document.createElement('div');el.className='item';if(Number(item.quantity)===0)el.classList.add('dim');const iconUrl=imgFor(item.display_name,item.icon);el.innerHTML=`<img src="${iconUrl}" alt="${item.display_name}"><div class="meta"><div class="name">${item.display_name}</div><div class="sub" id="sub-${cat.key}-${item.item_id}">Price: …</div></div><div style="display:flex;flex-direction:column;align-items:flex-end;"><div class="qty" title="Amount in stock" id="qty-${cat.key}-${item.item_id}">× ${item.quantity}</div><div class="restock" id="rest-${cat.key}-${item.item_id}"></div></div>`;list.appendChild(el);fillPriceSub(cat.key,item).catch(()=>{})}}buildSideSections();renderWatchlist();updateRestockUI()}async function fillPriceSub(catKey,item){const sub=document.getElementById(`sub-${catKey}-${item.item_id}`);const info=await getItemInfo(item.item_id);if(sub){let priceText=formatPriceNum(info?.price);sub.textContent=priceText?`Price: ${priceText} ${info?.currency??''}`.trim():''}}async function getItemInfo(item_id){const c=infoCache[item_id];const now=Date.now();if(c&&(now-(c.ts||0))<INFO_TTL_MS)return c.data;try{const data=await fetchJSON(API_INFO(item_id));infoCache[item_id]={data,ts:now};saveJSON('gg_info_cache',infoCache);return data}catch(e){return c?.data??null}}function buildSideSections(){sectionsWrap.innerHTML='';const groups=[{label:'Seeds',live:latestStock?.seed_stock??[],names:SEEDS},{label:'Gears',live:latestStock?.gear_stock??[],names:GEARS},{label:'Eggs',live:latestStock?.egg_stock??[],names:EGGS}];for(const g of groups){const sec=document.createElement('div');sec.className='side-section';const head=document.createElement('div');head.className='sec-head';head.innerHTML=`<div style="font-weight:700">${g.label}</div><div class="row-muted" id="count-${g.label}">${(g.live||[]).length} present</div>`;const body=document.createElement('div');body.className='sec-body';const seen=new Set();for(const it of g.live){if(seen.has(it.display_name))continue;seen.add(it.display_name);body.appendChild(makeChipFor(it.display_name,it.icon))}for(const name of g.names){if(seen.has(name))continue;seen.add(name);body.appendChild(makeChipFor(name,''))}sec.appendChild(head);sec.appendChild(body);sectionsWrap.appendChild(sec);const st=(sidebarGroupState[g.label]===undefined)?true:!!sidebarGroupState[g.label];if(st)sec.classList.add('open'),body.style.maxHeight=body.scrollHeight+'px';head.addEventListener('click',()=>{sec.classList.toggle('open');if(sec.classList.contains('open')){body.style.maxHeight=body.scrollHeight+'px';sidebarGroupState[g.label]=true}else{body.style.maxHeight='0px';sidebarGroupState[g.label]=false}saveJSON('gg_sidebar_groups',sidebarGroupState)})}function makeChipFor(displayName,icon){const lab=document.createElement('label');lab.className='chip';lab.innerHTML=`<input type="checkbox" value="${displayName}"><img src="${icon||''}" alt=""><span>${displayName}</span>`;const cb=lab.querySelector('input');cb.checked=watchSet.has(displayName);cb.addEventListener('change',()=>{if(cb.checked)watchSet.add(displayName);else watchSet.delete(displayName);saveJSON('gg_watch',[...watchSet]);renderWatchlist()});return lab}}function findCurrentQty(displayName){if(!latestStock)return 0;const pools=[latestStock.seed_stock,latestStock.gear_stock,latestStock.egg_stock,latestStock.cosmetic_stock,latestStock.eventshop_stock].filter(Boolean);for(const arr of pools)for(const it of arr)if(it.display_name===displayName)return Number(it.quantity)||0;return 0}function findItemId(displayName){const pools=[latestStock?.seed_stock,latestStock?.gear_stock,latestStock?.egg_stock,latestStock?.cosmetic_stock,latestStock?.eventshop_stock].filter(Boolean);for(const arr of pools)for(const it of arr)if(it.display_name===displayName)return it.item_id;return displayName.toLowerCase().replace(/\s+/g,'_')}async function renderWatchlist(){const watchWrap=document.getElementById('watchlist');if(!watchWrap)return;watchWrap.innerHTML='';const names=[...watchSet].sort((a,b)=>a.localeCompare(b));if(names.length===0){watchWrap.innerHTML=`<div class="row-muted">No items selected yet.</div>`;return}for(const name of names){const qty=findCurrentQty(name);const id=findItemId(name);const info=await getItemInfo(id);const icon=info?.icon||'';const row=document.createElement('div');row.className='notif-row fade-in';row.innerHTML=`<img src="${icon}" alt=""><div style="min-width:0"><div style="font-weight:700">${name}</div><div class="ls row-muted">Last seen: ${timeAgo(info?.last_seen)}</div></div><div class="tick ${qty>0?'good':'bad'}">${qty>0?'✓':'✗'}</div>`;watchWrap.appendChild(row)}}function notifyItemsOnly(){if(!latestStock||!("Notification"in window))return;if(Notification.permission!=='granted')return;const poolsMap={seed_stock:latestStock.seed_stock||[],gear_stock:latestStock.gear_stock||[],egg_stock:latestStock.egg_stock||[]};const notifyItem=(name)=>{const pools=Object.values(poolsMap).flat();for(const it of pools)if(it.display_name===name&&Number(it.quantity)>0){const key=`${it.display_name}@${it.start_date_unix||''}-${it.end_date_unix||''}`;if(!notifiedSet.has(key)){new Notification(`Item in stock: ${it.display_name}`,{body:`Quantity: ${it.quantity}`,icon:it.icon||''});notifiedSet.add(key)}}};[...SEEDS,...GEARS,...EGGS].forEach(n=>notifyItem(n))}function showModal(title,renderFn){modalTitle.textContent=title;modalBody.innerHTML='Loading…';modalOverlay.classList.add('show');modalOverlay.setAttribute('aria-hidden','false');renderFn()}function hideModal(){modalOverlay.classList.remove('show');modalOverlay.setAttribute('aria-hidden','true')}document.getElementById('calculatorBtn')?.addEventListener('click',()=>{showModal('Fruit Price Calculator',renderCalculator)});document.getElementById('encyclopediaBtn')?.addEventListener('click',()=>{showModal('Encyclopedia',renderEncyclopedia)});document.getElementById('closeModal')?.addEventListener('click',hideModal);async function renderCalculator(){let selectedVariant='';let selectedWeather='';let selectedMutations=new Set();modalBody.innerHTML=`<div style="display:flex;flex-direction:column;gap:12px;"><div style="display:flex;gap:12px;align-items:center;"><div style="flex:1"><div style="font-size:13px;font-weight:700;margin-bottom:6px;">Crop Type</div><input id="calcCrop" placeholder="Search for a crop..." style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--glass-bg);color:var(--text)"></div><div style="width:120px"><div style="font-size:13px;font-weight:700;margin-bottom:6px;">Weight (kg)</div><input id="calcWeight" type="number" placeholder="2.25" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--glass-bg);color:var(--text)"></div></div><div><div style="font-weight:700;margin-bottom:6px;">Variant Mutation (Choose One)</div><div class="segmented" id="variantGroup"></div></div><div><div style="font-weight:700;margin-bottom:6px;">Weather Mutation (Choose One)</div><div class="segmented" id="weatherGroup"></div></div><div><div style="font-weight:700;margin-bottom:6px;">Mutations (Multiple Allowed)</div><div id="mutationsGroup" style="display:flex;flex-wrap:wrap;gap:8px;"></div></div><div style="display:flex;gap:12px;align-items:center;"><button id="calculateBtn" style="padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;cursor:pointer;">Calculate</button><div id="calcResult" style="font-weight:700;"></div></div></div>`;const vwrap=document.getElementById('variantGroup'),wwrap=document.getElementById('weatherGroup'),mwrap=document.getElementById('mutationsGroup');VARIANTS.forEach(v=>{const b=document.createElement('button');b.className='seg-btn';b.textContent=v.label;b.dataset.val=v.id;b.addEventListener('click',()=>{vwrap.querySelectorAll('.seg-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');selectedVariant=v.id});vwrap.appendChild(b)});vwrap.querySelector('.seg-btn')?.classList.add('active');WEATHER_VARIANTS.forEach(w=>{const b=document.createElement('button');b.className='seg-btn';b.textContent=w.label;b.dataset.val=w.id;b.addEventListener('click',()=>{wwrap.querySelectorAll('.seg-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');selectedWeather=w.id});wwrap.appendChild(b)});wwrap.querySelector('.seg-btn')?.classList.add('active');MUTATIONS.forEach(m=>{const btn=document.createElement('button');btn.className='mut-chip';btn.textContent=`${m.label}${m.mult?` (x${m.mult})`:''}`;btn.dataset.val=m.id;btn.addEventListener('click',()=>{const id=btn.dataset.val;if(selectedMutations.has(id)){selectedMutations.delete(id);btn.classList.remove('selected')}else{selectedMutations.add(id);btn.classList.add('selected')}});mwrap.appendChild(btn)});document.getElementById('calculateBtn').addEventListener('click',async()=>{const crop=document.getElementById('calcCrop').value.trim();const weight=parseFloat(document.getElementById('calcWeight').value);if(!crop||isNaN(weight)){document.getElementById('calcResult').textContent='Please enter Crop and Weight.';return}let url=`https://api.joshlei.com/v2/growagarden/calculate?Name=${encodeURIComponent(crop)}&Weight=${encodeURIComponent(weight)}`;if(selectedVariant)url+=`&Variant=${encodeURIComponent(selectedVariant)}`;if(selectedWeather)url+=`&Weather=${encodeURIComponent(selectedWeather)}`;if(selectedMutations.size)url+=`&Mutations=${encodeURIComponent([...selectedMutations].join(','))}`;try{const res=await fetch(url,{headers:{accept:'application/json','jstudio-key':API_KEY}});const data=await res.json();document.getElementById('calcResult').textContent=`Estimated value: ${Number(data.value||0).toLocaleString()}`}catch(e){document.getElementById('calcResult').textContent='Error fetching data.'}})}async function renderEncyclopedia(){modalBody.innerHTML=`<div class="encyclopedia"><div class="enc-controls"><div class="enc-search"><input id="encSearch" placeholder="Search items, mutations, weather..." style="padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--glass-bg);color:var(--text);width:100%"></div><div class="spacer"></div><div class="row-muted" id="encCounts">—</div></div><div class="enc-tabs" id="encTabsTop"></div><div style="overflow:auto"><table class="enc-table" id="encTable" style="width:100%;border-collapse:collapse;font-size:13px;"><thead><tr><th>Item</th><th>ID</th><th>Type</th><th>Rarity</th><th>Price</th><th>Currency</th></tr></thead><tbody id="encBody"><tr><td colspan="6" class="row-muted">Loading…</td></tr></tbody></table></div><div class="enc-tabs" id="encTabsBottom" style="margin-top:8px"></div></div>`;try{const res=await fetch('https://api.joshlei.com/v2/growagarden/info',{headers:{accept:'application/json','jstudio-key':API_KEY}});const data=await res.json();const counts={};for(const it of data)counts[it.type]=(counts[it.type]||0)+1;const top=document.getElementById('encTabsTop'),bot=document.getElementById('encTabsBottom');top.innerHTML='';bot.innerHTML='';const allTop=document.createElement('button');allTop.className='enc-tab active';allTop.textContent=`All (${data.length})`;top.appendChild(allTop);bot.appendChild(allTop.cloneNode(true));Object.entries(counts).forEach(([t,c])=>{const bTop=document.createElement('button');bTop.className='enc-tab';bTop.textContent=`${t} (${c})`;top.appendChild(bTop);const bBot=bTop.cloneNode(true);bot.appendChild(bBot);const handler=()=>{Array.from(top.children).forEach(x=>x.classList.remove('active'));Array.from(bot.children).forEach(x=>x.classList.remove('active'));bTop.classList.add('active');bBot.classList.add('active');renderEncRows(data,t)};bTop.addEventListener('click',handler);bBot.addEventListener('click',handler)});allTop.addEventListener('click',()=>{Array.from(top.children).forEach(x=>x.classList.remove('active'));Array.from(bot.children).forEach(x=>x.classList.remove('active'));allTop.classList.add('active');renderEncRows(data)});document.getElementById('encCounts').textContent=`${data.length} results`;document.getElementById('encSearch').addEventListener('input',()=>renderEncRows(data,null,document.getElementById('encSearch').value.trim()));renderEncRows(data)}catch(e){document.getElementById('encBody').innerHTML=`<tr><td colspan="6" class="row-muted">Error loading encyclopedia.</td></tr>`}function renderEncRows(items,filterType=null,q=''){const encBody=document.getElementById('encBody');q=(q||'').toLowerCase();let rows=items.filter(it=>{if(filterType&&it.type!==filterType)return false;if(!q)return true;return(it.display_name||'').toLowerCase().includes(q)||(it.id||'').toLowerCase().includes(q)||(it.description||'').toLowerCase().includes(q)});if(rows.length===0){encBody.innerHTML=`<tr><td colspan="6" class="row-muted">No results.</td></tr>`;return}encBody.innerHTML=rows.map(it=>{const isWeather=(it.type||'').toLowerCase().includes('weather');const isEgg=(it.type||'').toLowerCase().includes('egg');const priceFormatted=isWeather?null:formatPriceNum(it.price);const rarityHtml=it.rarity?`<span style="font-weight:700">${it.rarity}</span>`:'—';const idVal=it.id||it.item_id||'';const desc=isEgg?'':(it.description||'');return`<tr><td style="min-width:220px;display:flex;gap:10px;align-items:center;"><img src="${it.icon||''}" alt="" style="width:34px;height:34px;border-radius:6px;object-fit:cover;background:rgba(0,0,0,0.06)"><div><div style="font-weight:700">${it.display_name}</div><div class="row-muted" style="font-size:12px">${(desc||'').slice(0,80)}</div></div></td><td style="font-family:monospace;color:var(--muted)">${idVal}</td><td style="text-transform:lowercase">${it.type||'-'}</td><td>${rarityHtml}</td><td>${priceFormatted??''}</td><td>${it.currency||''}</td></tr>`}).join('')}}function updateRestockUI(){if(!restockTimes||!Object.keys(restockTimes).length)restockTimes=calculateRestockTimes();function mapKey(catKey){if(catKey==='seed_stock')return'seeds';if(catKey==='gear_stock')return'gear';if(catKey==='egg_stock')return'egg';if(catKey==='cosmetic_stock')return'cosmetics';if(catKey==='eventshop_stock')return'event';return'seeds'}function update(){const now=Date.now();for(const cat of ['seed_stock','gear_stock','egg_stock','cosmetic_stock','eventshop_stock']){const k=mapKey(cat);const next=restockTimes[k]||0;const left=Math.max(0,next-now);const matches=document.querySelectorAll(`[id^="rest-${cat}-"]`);matches.forEach(el=>{el.textContent=`Next restock: ${formatCountdown(left)}`})}const seedsLeft=Math.max(0,(restockTimes.seeds||0)-Date.now());const gearLeft=Math.max(0,(restockTimes.gear||0)-Date.now());const eggLeft=Math.max(0,(restockTimes.egg||0)-Date.now());const cosmeticsLeft=Math.max(0,(restockTimes.cosmetics||0)-Date.now());const eventLeft=Math.max(0,(restockTimes.event||0)-Date.now());restockTimersEl.textContent=`Seeds: ${formatCountdown(seedsLeft)} • Gear: ${formatCountdown(gearLeft)} • Eggs: ${formatCountdown(eggLeft)} • Cosmetics: ${formatCountdown(cosmeticsLeft)} • Event: ${formatCountdown(eventLeft)}`;if(seedsLeft<=0||gearLeft<=0||eggLeft<=0||cosmeticsLeft<=0||eventLeft<=0)restockTimes=calculateRestockTimes()}update();setInterval(update,1000)}function ensureAccordion(card,body){const open=card.classList.contains('open');body.style.maxHeight=open?(body.scrollHeight+'px'):'0px';window.addEventListener('resize',()=>{if(card.classList.contains('open'))body.style.maxHeight=body.scrollHeight+'px'})}(function initUI(){buildSideSections();renderWatchlist();updateRestockUI()})();(function ensureWatchlist(){let w=document.getElementById('watchlist');if(!w){const el=document.createElement('div');el.id='watchlist';document.getElementById('sideBody').appendChild(el)}})();</script></body></html>
