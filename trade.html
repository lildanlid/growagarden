<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Trade App</title>
<!-- Google Fonts for a modern look -->
<link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
<style>
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background-color: #f0f2f5;
    color: #333;
  }
  h2 {
    margin-top: 0;
  }

  /* Container styles */
  #auth-section, #app-section {
    max-width: 400px;
    margin: 50px auto;
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  #auth-section h2, #app-section h2 {
    text-align: center;
    margin-bottom: 20px;
  }
  input[type="email"], input[type="password"], textarea, input[type="text"] {
    width: 100%;
    padding: 12px 15px;
    margin: 8px 0;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 1em;
    box-sizing: border-box;
    transition: border-color 0.2s;
  }
  input[type="email"]:focus, input[type="password"]:focus, textarea:focus, input[type="text"]:focus {
    border-color: #007bff;
    outline: none;
  }
  button {
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  button:hover {
    background-color: #0056b3;
  }

  /* Trades list styles */
  #trades {
    margin-top: 20px;
  }
  .trade {
    background: #fafafa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .trade button {
    margin-top: 10px;
    background-color: #17a2b8;
  }
  .trade button:hover {
    background-color: #138496;
  }

  /* Chat overlay styles */
  #chat-fullscreen {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: #fff;
    display: none;
    flex-direction: column;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
  }
  #chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 20px;
    background-color: #343a40;
    color: #fff;
    border-bottom: 1px solid #ddd;
  }
  #chat-header h3 {
    margin: 0;
  }
  #close-chat {
    background: none;
    border: none;
    color: #fff;
    font-size: 1.3em;
    cursor: pointer;
  }
  #chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background-color: #f8f9fa;
  }
  #chat-messages div {
    margin-bottom: 12px;
    padding: 10px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  }
  #chat-input-container {
    display: flex;
    padding: 10px 20px;
    border-top: 1px solid #ddd;
  }
  #chat-input {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 1em;
    margin-right: 10px;
  }
  #send-btn {
    background-color: #28a745;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 10px 15px;
    cursor: pointer;
  }
  #send-btn:hover {
    background-color: #218838;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
</style>
</head>
<body>

<!-- Authentication UI -->
<div id="auth-section">
  <h2>Create Account</h2>
  <input type="email" id="signup-email" placeholder="Email" />
  <input type="password" id="signup-password" placeholder="Password" />
  <button onclick="handleSignUp()">Sign Up</button>

  <h2>Already have an account?</h2>
  <input type="email" id="signin-email" placeholder="Email" />
  <input type="password" id="signin-password" placeholder="Password" />
  <button onclick="handleSignIn()">Sign In</button>
</div>

<!-- Main App UI -->
<div id="app-section" style="display:none;">
  <h2 style="text-align:center;">Welcome, <span id="user-email"></span></h2>
  <div style="display:flex; justify-content:space-around; margin-top:20px;">
    <button onclick="signOut()">Sign Out</button>
    <button onclick="loadTrades()">Refresh Trades</button>
  </div>
  <h3 style="margin-top:30px;">Post a Trade</h3>
  <textarea id="have-items" rows="3" placeholder="Items you have..."></textarea>
  <textarea id="want-items" rows="3" placeholder="Items you want..."></textarea>
  <button onclick="createTrade()">Post Trade</button>

  <div id="trades"></div>
</div>

<!-- Chat Overlay -->
<div id="chat-fullscreen">
  <div id="chat-header">
    <h3 id="chat-title">Chat</h3>
    <button id="close-chat" onclick="closeChat()">Ã—</button>
  </div>
  <div id="chat-messages"></div>
  <div id="chat-input-container">
    <input type="text" id="chat-input" placeholder="Type a message..." />
    <button id="send-btn" onclick="sendChatMessage()">Send</button>
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase-js.min.js"></script>
<script>
  let supabase;

  // Load config from backend
  async function loadConfig() {
    try {
      const res = await fetch('http://localhost:3000/config'); // Your backend URL
      const config = await res.json();
      supabase = supabase.createClient(config.supabaseUrl, config.supabaseKey);
      initAuthListener();
    } catch (err) {
      alert('Failed to load config: ' + err.message);
    }
  }

  let currentUser = null;
  let currentTradeId = null; // For chat
  let messageSubscription = null;

  // Observe auth state
  async function initAuthListener() {
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (session && session.user) {
        if (session.user.email_confirmed_at) {
          currentUser = session.user;
          document.getElementById('auth-section').style.display = 'none';
          document.getElementById('app-section').style.display = 'block';
          document.getElementById('user-email').innerText = currentUser.email;
          loadTrades();
        } else {
          alert('Please verify your email before accessing the app.');
          await supabase.auth.signOut();
        }
      } else {
        currentUser = null;
        document.getElementById('auth-section').style.display = 'block';
        document.getElementById('app-section').style.display = 'none';
      }
    });
  }

  // Sign-up
  async function handleSignUp() {
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    const { user, error } = await supabase.auth.signUp({ email, password });
    if (error) {
      alert('Error: ' + error.message);
    } else {
      alert('Check your email to verify your account!');
    }
  }

  // Sign-in
  async function handleSignIn() {
    const email = document.getElementById('signin-email').value;
    const password = document.getElementById('signin-password').value;
    const { user, error } = await supabase.auth.signIn({ email, password });
    if (error) {
      alert('Error: ' + error.message);
    }
  }

  // Sign out
  async function signOut() {
    await supabase.auth.signOut();
  }

  // Load trades
  async function loadTrades() {
    const { data: trades, error } = await supabase
      .from('trades')
      .select('*')
      .order('created_at', { ascending: false });
    if (error) {
      console.error(error);
      alert('Error loading trades');
    } else {
      displayTrades(trades);
    }
  }

  function displayTrades(trades) {
    const container = document.getElementById('trades');
    container.innerHTML = '';
    trades.forEach(trade => {
      const div = document.createElement('div');
      div.className = 'trade';
      div.innerHTML = `
        <strong>Trade ID:</strong> ${trade.id}<br />
        <strong>Have:</strong> ${trade.have}<br />
        <strong>Want:</strong> ${trade.want}<br />
        <strong>Posted by:</strong> ${trade.user_id}<br />
        <button onclick="openChat('${trade.id}')">Chat</button>
      `;
      container.appendChild(div);
    });
  }

  // Create trade
  async function createTrade() {
    const haveItems = document.getElementById('have-items').value;
    const wantItems = document.getElementById('want-items').value;
    if (!currentUser) {
      alert('Please sign in first.');
      return;
    }
    const { data, error } = await supabase
      .from('trades')
      .insert({
        user_id: currentUser.id,
        have: haveItems,
        want: wantItems,
        draft: false
      });
    if (error) {
      alert('Error creating trade: ' + error.message);
    } else {
      loadTrades();
    }
  }

  // Chat functions
  async function openChat(tradeId) {
    currentTradeId = tradeId;
    document.getElementById('chat-fullscreen').style.display = 'flex';
    document.getElementById('chat-title').innerText = 'Chat for Trade ' + tradeId;
    await loadChatMessages(tradeId);
    subscribeToMessages(tradeId);
  }

  function closeChat() {
    if (messageSubscription) {
      messageSubscription.unsubscribe();
    }
    document.getElementById('chat-fullscreen').style.display = 'none';
  }

  async function loadChatMessages(tradeId) {
    const { data: messages, error } = await supabase
      .from('messages')
      .select('*')
      .eq('trade_id', tradeId)
      .order('timestamp', { ascending: true });
    if (error) {
      console.error(error);
      alert('Error loading messages');
    } else {
      const container = document.getElementById('chat-messages');
      container.innerHTML = '';
      messages.forEach(msg => {
        appendChatMessage(msg.user_id, msg.message, new Date(msg.timestamp));
      });
    }
  }

  function appendChatMessage(userId, message, timestamp) {
    const container = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.innerHTML = `<strong>${userId}:</strong> ${message} <br /><small>(${timestamp.toLocaleString()})</small>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  async function sendChatMessage() {
    const messageText = document.getElementById('chat-input').value;
    if (!messageText || !currentTradeId || !currentUser) return;
    await supabase
      .from('messages')
      .insert({
        trade_id: currentTradeId,
        user_id: currentUser.email,
        message: messageText,
        timestamp: new Date()
      });
    document.getElementById('chat-input').value = '';
  }

  function subscribeToMessages(tradeId) {
    if (messageSubscription) messageSubscription.unsubscribe();
    messageSubscription = supabase
      .from(`messages:trade_id=eq.${tradeId}`)
      .on('INSERT', payload => {
        const msg = payload.new;
        appendChatMessage(msg.user_id, msg.message, new Date(msg.timestamp));
      })
      .subscribe();
  }

  // Initialize
  loadConfig();
</script>
</body>
</html>
