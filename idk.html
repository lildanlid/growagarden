<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grow A Garden Stock</title>
  <style>
    :root {
      --bg: #121212;
      --card: #1f1f1f;
      --text: #e0e0e0;
      --accent: #4caf50;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: var(--accent);
      border-radius: 0 0 12px 12px;
      padding: 1rem;
      text-align: center;
      margin: 0 1rem;
    }

    .tabs {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
      flex-wrap: wrap;
    }

    .tab {
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      background: var(--card);
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .tab.active {
      background-color: var(--accent);
      color: black;
    }

    .content {
      display: none;
      padding: 1rem;
    }

    .content.active {
      display: block;
    }

    .item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
    }

    .item-card {
      background-color: var(--card);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    .item-card img {
      max-width: 64px;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }

    .countdown {
      text-align: center;
      margin: 0.5rem 0 1rem;
      font-size: 0.9rem;
      color: #aaa;
    }
  </style>
</head>
<body>
  <header>
    <h1>üå± Grow A Garden Stock Viewer</h1>
  </header>

  <div class="tabs" id="tabs"></div>
  <div id="tab-contents"></div>

  <script>
    const API_URL = "https://api.joshlei.com/v2/growagarden/stock";
    const TIMEZONE = "America/New_York";
    const SECTIONS = {
      seed_stock: "Seeds",
      gear_stock: "Gear",
      egg_stock: "Eggs",
      cosmetic_stock: "Cosmetics",
      eventshop_stock: "Event Shop"
    };

    const INTERVALS = {
      egg_stock: 30 * 60 * 1000,
      gear_stock: 5 * 60 * 1000,
      seed_stock: 5 * 60 * 1000,
      cosmetic_stock: 4 * 3600 * 1000,
      eventshop_stock: 3600 * 1000
    };

    function pad(n) {
      return n < 10 ? '0' + n : n;
    }

    function calculateCountdown(interval) {
      const now = new Date();
      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const timeSinceStart = now.getTime() - startOfDay.getTime();
      const nextReset = startOfDay.getTime() + Math.ceil(timeSinceStart / interval) * interval;
      const msLeft = nextReset - now.getTime();
      const h = pad(Math.floor(msLeft / 3600000));
      const m = pad(Math.floor((msLeft % 3600000) / 60000));
      const s = pad(Math.floor((msLeft % 60000) / 1000));
      return `${h}h ${m}m ${s}s`;
    }

    async function fetchStockData() {
      try {
        const response = await fetch(API_URL);
        return await response.json();
      } catch (err) {
        console.error("Fetch error:", err);
        return {};
      }
    }

    function generateItems(items) {
      if (!items || !items.length) return "<p>No items available.</p>";
      return `<div class="item-grid">` + items.map(item => `
        <div class="item-card">
          <img src="${item.icon}" alt="${item.display_name}" />
          <div>${item.display_name}</div>
          <div>x${item.quantity}</div>
        </div>`).join("") + `</div>`;
    }

    function createTabs(data) {
      const tabsContainer = document.getElementById("tabs");
      const contentsContainer = document.getElementById("tab-contents");

      if (tabsContainer.children.length === 0) {
        for (const [key, label] of Object.entries(SECTIONS)) {
          const tab = document.createElement("div");
          tab.className = "tab";
          tab.textContent = label;
          tab.dataset.tab = key;
          tab.onclick = () => switchTab(key);
          tabsContainer.appendChild(tab);

          const content = document.createElement("div");
          content.id = `tab-${key}`;
          content.className = "content";
          const countdown = document.createElement("div");
          countdown.className = "countdown";
          countdown.id = `timer-${key}`;
          countdown.textContent = "Loading timer...";
          content.appendChild(countdown);

          const itemContainer = document.createElement("div");
          itemContainer.className = "item-container";
          itemContainer.id = `items-${key}`;
          content.appendChild(itemContainer);

          contentsContainer.appendChild(content);
        }
        tabsContainer.firstChild.classList.add("active");
        contentsContainer.firstChild.classList.add("active");
      }

      for (const [key] of Object.entries(SECTIONS)) {
        const container = document.getElementById(`items-${key}`);
        container.innerHTML = generateItems(data[key]);
      }
    }

    function switchTab(tabKey) {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".content").forEach(c => c.classList.remove("active"));
      document.querySelector(`.tab[data-tab="${tabKey}"]`).classList.add("active");
      document.getElementById(`tab-${tabKey}`).classList.add("active");
    }

    function updateCountdowns() {
      for (const key of Object.keys(SECTIONS)) {
        const interval = INTERVALS[key];
        const countdown = calculateCountdown(interval);
        const el = document.getElementById(`timer-${key}`);
        if (el) el.textContent = `‚è≥ Restocks in ${countdown}`;
      }
    }

    async function updateStock() {
      const data = await fetchStockData();
      createTabs(data);
    }

    async function init() {
      await updateStock();
      updateCountdowns();
      setInterval(updateStock, 3000);    
      setInterval(updateCountdowns, 1000);
    }

    init();
  </script>
</body>
</html>
