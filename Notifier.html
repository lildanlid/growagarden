<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grow a Garden ‚Äî Stock Monitor</title>
<style>
  :root{
    --bg: #f6f7fb;
    --card: #ffffff;
    --text: #1f2330;
    --muted: #707789;
    --accent: #6b7cff;
    --accent-2:#50e3c2;
    --border:#e6e8f0;
    --good:#18a957;
    --bad:#e24a4a;
    --shadow: 0 6px 20px rgba(0,0,0,.08);
  }
  html.dark{
    --bg:#0d0f15;
    --card:#121622;
    --text:#dfe6ff;
    --muted:#9aa3b2;
    --accent:#8d9bff;
    --accent-2:#65f2d0;
    --border:#1e2433;
    --shadow: 0 8px 24px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background:var(--bg); color:var(--text);
  }
  /* Header */
  header{
    position:sticky; top:0; z-index:30; backdrop-filter:saturate(120%) blur(8px);
    background:linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,0)) ;
  }
  .bar{
    display:flex; align-items:center; gap:10px; padding:14px 20px;
  }
  .title{font-weight:800; letter-spacing:.3px; font-size:18px; display:flex; align-items:center; gap:10px}
  .pill{
    padding:4px 10px; border-radius:999px; background:var(--card); border:1px solid var(--border); color:var(--muted); font-size:12px
  }
  .spacer{flex:1}
  button.icon{
    border:none; background:var(--card); border:1px solid var(--border); box-shadow:var(--shadow);
    width:38px; height:38px; border-radius:12px; display:grid; place-items:center; cursor:pointer; transition:transform .15s ease, opacity .15s;
  }
  button.icon:hover{transform:translateY(-1px)}
  button.icon:active{transform:translateY(0)}
  .row{max-width:1200px; margin:0 auto; padding:18px}

  /* Grid + cards */
  .categories{display:grid; grid-template-columns:1fr; gap:14px}
  @media (min-width: 880px){ .categories{grid-template-columns:1fr 1fr} }
  @media (min-width: 1180px){ .categories{grid-template-columns:1fr 1fr} }

  .card{
    background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); overflow:hidden;
    transition: background .2s ease, border-color .2s ease;
  }
  .card-header{
    display:flex; align-items:center; justify-content:space-between; padding:12px 16px; cursor:pointer; user-select:none;
  }
  .card-header h2{margin:0; font-size:16px}
  .badge{
    background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#fff; padding:2px 10px; font-size:12px; border-radius:999px; font-weight:700
  }
  .chev{transition: transform .3s ease; opacity:.7}
  .card.open .chev{transform:rotate(180deg)}
  .card-body{
    overflow:hidden; max-height:0; transition:max-height .45s cubic-bezier(.2,.8,.2,1), opacity .25s ease;
    opacity:0; border-top:1px dashed var(--border);
  }
  .card.open .card-body{opacity:1}
  .list{
    display:grid; grid-template-columns:repeat(auto-fill, minmax(240px,1fr)); gap:12px; padding:14px;
  }
  .item{
    display:flex; gap:12px; align-items:center; padding:10px; border:1px solid var(--border); border-radius:14px; transition: transform .12s ease, background .2s;
    background:linear-gradient(180deg, rgba(0,0,0,.02), transparent);
  }
  .item:hover{transform:translateY(-1px)}
  .item.dim{opacity:.45; filter:grayscale(.35)}
  .item img{width:44px; height:44px; border-radius:10px; object-fit:cover; background:#00000008}
  .meta{display:flex; flex-direction:column; gap:2px}
  .name{font-weight:700}
  .sub{font-size:12px; color:var(--muted)}
  .qty{margin-left:auto; font-weight:800}

  /* Sidebar (notifications) */
  .scrim{
    position:fixed; inset:0; background:rgba(0,0,0,.28); opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:40;
  }
  .scrim.show{opacity:1; pointer-events:auto}
  .sidebar{
    position:fixed; top:0; right:0; width:min(380px, 92vw); height:100vh; background:var(--card); border-left:1px solid var(--border);
    box-shadow: -12px 0 40px rgba(0,0,0,.25); transform:translateX(100%); transition: transform .35s cubic-bezier(.2,.8,.2,1);
    z-index:41; display:flex; flex-direction:column;
  }
  .sidebar.open{transform:translateX(0)}
  .side-head{display:flex; align-items:center; gap:10px; padding:14px 16px; border-bottom:1px solid var(--border)}
  .side-head h3{margin:0; font-size:16px}
  .side-body{padding:10px 14px; overflow:auto; display:flex; flex-direction:column; gap:16px}
  .chip{display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; cursor:pointer; user-select:none}
  .chip input{accent-color:var(--accent)}
  .group h4{margin:6px 0 8px; color:var(--muted); font-size:12px; letter-spacing:.4px; text-transform:uppercase}
  .notif-row{
    display:grid; grid-template-columns:36px 1fr 22px; gap:8px; align-items:center;
    padding:8px 10px; border:1px dashed var(--border); border-radius:12px;
  }
  .notif-row img{width:36px; height:36px; border-radius:8px; object-fit:cover}
  .tick{font-weight:900; font-size:16px}
  .tick.good{color:var(--good)} .tick.bad{color:var(--bad)}
  .ls{font-size:12px; color:var(--muted)}

  /* Loading screen */
  .loading{
    position:fixed; inset:0; display:grid; place-items:center; background:var(--bg); z-index:50;
    animation: fadeOut .6s ease .2s forwards; pointer-events:none;
  }
  .spinner{
    width:56px; height:56px; border-radius:50%; border:4px solid transparent; border-top-color:var(--accent); border-right-color:var(--accent-2);
    animation: spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes fadeOut{to{opacity:0; visibility:hidden}}

  /* Small helpers */
  .row-muted{color:var(--muted); font-size:12px}
  .fade-in{animation: fadeIn .4s ease both}
  @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
</style>
</head>
<body>
  <!-- LOADING -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="bar row">
      <div class="title">
        üå± Grow a Garden
        <span class="pill" id="statusPill">Connecting‚Ä¶</span>
      </div>
      <div class="spacer"></div>
      <button id="darkToggle" class="icon" title="Toggle dark mode" aria-label="Toggle dark mode">üåì</button>
      <button id="openSidebar" class="icon" title="Notifications" aria-label="Notifications">üîî</button>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="row">
    <div class="row-muted" id="updatedAt">‚Äî</div>
    <div class="categories" id="categories"></div>
  </main>

  <!-- SIDEBAR + SCRIM -->
  <div id="scrim" class="scrim"></div>
  <aside id="sidebar" class="sidebar" aria-label="Notifications sidebar" aria-hidden="true">
    <div class="side-head">
      <h3>Notifications</h3>
      <div class="spacer"></div>
      <button id="closeSidebar" class="icon" title="Close" aria-label="Close">‚úï</button>
    </div>
    <div class="side-body" id="sideBody">
      <div class="group">
        <h4>Select items</h4>
        <div id="chips"></div>
      </div>
      <div class="group">
        <h4>Watchlist Status</h4>
        <div id="watchlist"></div>
      </div>
      <div class="group">
        <h4>Tips</h4>
        <div class="row-muted">
          ‚Ä¢ Enable browser notifications when prompted.<br>
          ‚Ä¢ ‚ÄúLast seen‚Äù comes from the item info endpoint.<br>
          ‚Ä¢ Your selections + theme are saved locally.
        </div>
      </div>
    </div>
  </aside>

<script>
/* =======================
   CONFIG / CONSTANTS
======================= */
const API_URL = 'https://api.joshlei.com/v2/growagarden/stock';
const API_INFO = (id) => `https://api.joshlei.com/v2/growagarden/info/${id}`;
const API_KEY = 'js_c5d322d0652bc477f50348450bb2c6fe4f4d767042b2b0facb69b074c3d46f46';

const POLL_MS = 30000; // 30 seconds
const INFO_TTL_MS = 5 * 60 * 1000; // cache info for 5 minutes

// Item lists
const SEEDS = ["Carrot","Strawberry","Blueberry","Tomato","Daffodil","Watermelon","Pumpkin","Apple","Bamboo","Coconut","Cactus","Dragon Fruit","Mango","Grape","Mushroom","Pepper","Cacao","Beanstalk","Ember lily","Sugar Apple","Burning Bud","Giant Pinecone","Elder Strawberry","Romanesco"];
const GEARS = ["Watering Can","Trowel","Recall Wrench","Basic Sprinkler","Advanced Sprinkler","Medium Toy","Medium Treat","Godly Sprinkler","Magnifying Glass","Tanning Mirror","Master Sprinkler","Cleaning Spray","Favorite Tool","Harvest Tool","Friendship Pot","Levelup Lolipop"];
const EGGS  = ["Common Egg","Common Summer Egg","Rare Summer Egg","Mythical Egg","Paradise Egg","Bug Egg"];

// Image data (assumed to be complete, omitted here for brevity, keep your existing object)
const imageData = {
  /* Your image data here, unchanged for brevity */
  /* ... */
};

/* =======================
   STATE / LOCALSTORAGE
======================= */
const LS = {
  DARK: 'gg_dark',
  WATCH: 'gg_watch', // array of display names
  SIDEBAR: 'gg_sidebar_open',
  INFO_CACHE: 'gg_info_cache' // map of item_id -> {data, ts}
};

let watchSet = new Set(loadJSON(LS.WATCH, []));
let infoCache = loadJSON(LS.INFO_CACHE, {});
let latestStock = null; // store last stock payload
let firstLoadDone = false;

/* =======================
   UTILITIES
======================= */
function loadJSON(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key) ?? JSON.stringify(fallback)); }
  catch(e){ return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function timeAgo(sEpoch){
  if(!sEpoch) return '‚Äî';
  const now = Math.floor(Date.now()/1000);
  let diff = Math.max(0, now - Number(sEpoch));
  const units = [
    ['y', 365*24*3600],
    ['mo', 30*24*3600],
    ['w', 7*24*3600],
    ['d', 24*3600],
    ['h', 3600],
    ['m', 60],
    ['s', 1],
  ];
  for(const [u,sec] of units){
    if(diff >= sec) {
      const v = Math.floor(diff/sec);
      return `${v}${u} ago`;
    }
  }
  return 'just now';
}
function fmtPrice(p){ return (p==null || p==="") ? "‚Äî" : `${p}`; }

/* =======================
   THEME
======================= */
(function initTheme(){
  const dark = localStorage.getItem(LS.DARK) === 'true';
  document.documentElement.classList.toggle('dark', dark);
})();

document.getElementById('darkToggle').addEventListener('click', ()=>{
  const nowDark = !document.documentElement.classList.contains('dark');
  document.documentElement.classList.toggle('dark', nowDark);
  localStorage.setItem(LS.DARK, String(nowDark));
});

/* =======================
   SIDEBAR
======================= */
const sidebar = document.getElementById('sidebar');
const scrim = document.getElementById('scrim');

function openSidebar(){
  sidebar.classList.add('open');
  scrim.classList.add('show');
  sidebar.setAttribute('aria-hidden','false');
  localStorage.setItem(LS.SIDEBAR, 'true');
}
function closeSidebar(){
  sidebar.classList.remove('open');
  scrim.classList.remove('show');
  sidebar.setAttribute('aria-hidden','true');
  localStorage.setItem(LS.SIDEBAR, 'false');
}
document.getElementById('openSidebar').addEventListener('click', openSidebar);
document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
scrim.addEventListener('click', closeSidebar);

if(localStorage.getItem(LS.SIDEBAR)==='true'){ openSidebar(); }

/* =======================
   STOCK FETCH / RENDER
======================= */
const statusPill = document.getElementById('statusPill');
const updatedAt = document.getElementById('updatedAt');
const categoriesEl = document.getElementById('categories');

async function fetchJSON(url){
  const res = await fetch(url, { headers: { 'accept':'application/json', 'jstudio-key': API_KEY }});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function fetchStock(){
  try{
    statusPill.textContent = 'Loading‚Ä¶';
    const data = await fetchJSON(API_URL);
    latestStock = data;
    statusPill.textContent = 'Live';
    updatedAt.textContent = `Updated: ${new Date().toLocaleString()}`;
    renderAll(data);
    if(Notification.permission !== 'denied'){ Notification.requestPermission().catch(()=>{}); }
    if(!firstLoadDone){
      firstLoadDone = true;
      setTimeout(()=> document.getElementById('loading').remove(), 650); // fade out loading
    }
  }catch(err){
    console.error(err);
    statusPill.textContent = 'Error';
  }
}

// Call fetch periodically
setInterval(fetchStock, POLL_MS);
fetchStock(); // initial load

function categorySpec(data){
  return [
    { key:'seed_stock',   title:'Seeds'     },
    { key:'gear_stock',   title:'Gears'     },
    { key:'egg_stock',    title:'Eggs'      },
    { key:'cosmetic_stock', title:'Cosmetics' },
    { key:'eventshop_stock', title:'Event Shop' },
  ].map(k => ({...k, items: (data[k.key] || [])}));
}

function ensureAccordion(card, body){
  // Smooth max-height animation
  const open = card.classList.contains('open');
  body.style.maxHeight = open ? (body.scrollHeight + 'px') : '0px';
}

function imgFor(displayName, apiIcon){
  return imageData[displayName] || apiIcon || '';
}

function renderAll(data){
  // Build category cards (accordion)
  categoriesEl.innerHTML = '';
  for(const cat of categorySpec(data)){
    const card = document.createElement('section');
    card.className = 'card fade-in';
    const header = document.createElement('div');
    header.className = 'card-header';
    header.innerHTML = `
      <h2>${cat.title}</h2>
      <div style="display:flex;align-items:center;gap:10px">
        <span class="badge">${cat.items.length}</span>
        <span class="chev">‚ñæ</span>
      </div>
    `;
    const body = document.createElement('div');
    body.className = 'card-body';
    const list = document.createElement('div');
    list.className = 'list';
    body.appendChild(list);
    card.appendChild(header);
    card.appendChild(body);
    categoriesEl.appendChild(card);

    // Start closed on small screens, open on desktop for first two sections
    if(window.innerWidth > 900 && ['Seeds','Gears'].includes(cat.title)) card.classList.add('open');
    ensureAccordion(card, body);

    header.addEventListener('click', ()=>{
      card.classList.toggle('open');
      ensureAccordion(card, body);
      if(card.classList.contains('open')){ // recalc height after images load
        setTimeout(()=> ensureAccordion(card, body), 60);
      }
    });

    // Render items
    for(const item of cat.items){
      const el = document.createElement('div');
      el.className = 'item';
      if(Number(item.quantity) === 0) el.classList.add('dim');

      const iconUrl = imgFor(item.display_name, item.icon);
      el.innerHTML = `
        <img src="${iconUrl}" alt="${item.display_name}">
        <div class="meta">
          <div class="name">${item.display_name}</div>
          <div class="sub" id="sub-${cat.key}-${item.item_id}">Price: ‚Ä¶</div>
        </div>
        <div class="qty" title="Amount in stock">√ó ${item.quantity}</div>
      `;
      list.appendChild(el);

      // Fill price asynchronously from /info/{id}
      fillPriceSub(cat.key, item).catch(()=>{});
    }
  }

  // Update sidebar chips + watchlist
  buildChips();
  renderWatchlist();
  // Trigger notifications for watched items
  notifyForWatched();
}

/* =======================
   Fill item info
======================= */
async function fillPriceSub(catKey, item){
  const sub = document.getElementById(`sub-${catKey}-${item.item_id}`);
  const info = await getItemInfo(item.item_id);
  sub.textContent = `Price: ${fmtPrice(info?.price)} ${info?.currency ?? ''}`.trim();
}

/* =======================
   ITEM INFO CACHE
======================= */
async function getItemInfo(item_id){
  const c = infoCache[item_id];
  const now = Date.now();
  if(c && (now - (c.ts||0)) < INFO_TTL_MS) return c.data;
  try{
    const data = await fetchJSON(API_INFO(item_id));
    infoCache[item_id] = { data, ts: now };
    saveJSON(LS.INFO_CACHE, infoCache);
    return data;
  }catch(e){
    return c?.data ?? null;
  }
}

/* =======================
   WATCHLIST (NOTIFICATIONS)
======================= */
const chipsWrap = document.getElementById('chips');
const watchlistWrap = document.getElementById('watchlist');

function buildChips(){
  // Build once per render, grouped by type
  chipsWrap.innerHTML = '';
  const groups = [
    {label:'Seeds', data: latestStock?.seed_stock ?? []},
    {label:'Gears', data: latestStock?.gear_stock ?? []},
    {label:'Eggs',  data: latestStock?.egg_stock ?? []},
  ];
  for(const g of groups){
    const h = document.createElement('div');
    h.style.margin = '8px 0 6px';
    h.innerHTML = `<div class="row-muted" style="font-weight:700">${g.label}</div>`;
    chipsWrap.appendChild(h);

    const seen = new Set();
    for(const it of g.data){
      if(seen.has(it.display_name)) continue;
      seen.add(it.display_name);

      const chip = document.createElement('label');
      chip.className = 'chip';
      chip.innerHTML = `
        <input type="checkbox" value="${it.display_name}">
        <img src="${imgFor(it.display_name, it.icon)}" alt="" width="20" height="20" style="border-radius:6px;object-fit:cover">
        <span>${it.display_name}</span>
      `;
      const cb = chip.querySelector('input');
      cb.checked = watchSet.has(it.display_name);
      cb.addEventListener('change', ()=>{
        if(cb.checked) watchSet.add(it.display_name); else watchSet.delete(it.display_name);
        saveJSON(LS.WATCH, [...watchSet]);
        renderWatchlist();
      });
      chipsWrap.appendChild(chip);
    }
  }
}

function findCurrentQty(displayName){
  if(!latestStock) return 0;
  const pools = [latestStock.seed_stock, latestStock.gear_stock, latestStock.egg_stock, latestStock.cosmetic_stock, latestStock.eventshop_stock]
    .filter(Boolean);
  for(const arr of pools){
    for(const it of arr){
      if(it.display_name === displayName) return Number(it.quantity) || 0;
    }
  }
  return 0;
}

function findItemId(displayName){
  const pools = [latestStock?.seed_stock, latestStock?.gear_stock, latestStock?.egg_stock, latestStock?.cosmetic_stock, latestStock?.eventshop_stock].filter(Boolean);
  for(const arr of pools){
    for(const it of arr){
      if(it.display_name === displayName) return it.item_id;
    }
  }
  // fallback guess: snake_case from name
  return displayName.toLowerCase().replace(/\s+/g,'_');
}

async function renderWatchlist(){
  watchlistWrap.innerHTML = '';
  const names = [...watchSet].sort((a,b)=>a.localeCompare(b));
  if(names.length === 0){
    watchlistWrap.innerHTML = `<div class="row-muted">No items selected yet.</div>`;
    return;
  }
  for(const name of names){
    const qty = findCurrentQty(name);
    const id = findItemId(name);
    const info = await getItemInfo(id);
    const icon = imgFor(name, info?.icon);

    const row = document.createElement('div');
    row.className = 'notif-row fade-in';
    row.innerHTML = `
      <img src="${icon}" alt="">
      <div>
        <div style="font-weight:700">${name}</div>
        <div class="ls">Last seen: ${timeAgo(info?.last_seen)}</div>
      </div>
      <div class="tick ${qty>0?'good':'bad'}" title="${qty>0?'In stock':'Not in stock'}">
        ${qty>0?'‚úì':'‚úó'}
      </div>
    `;
    watchlistWrap.appendChild(row);
  }
}

function canNotify(){
  return "Notification" in window && Notification.permission === "granted";
}

function notifyForWatched(){
  if(!latestStock || !("Notification" in window)) return;
  const now = Date.now();
  if(!notifyForWatched.seen){ notifyForWatched.seen = new Set(); }
  const seen = notifyForWatched.seen;

  const pools = [latestStock.seed_stock, latestStock.gear_stock, latestStock.egg_stock].filter(Boolean);
  for(const arr of pools){
    for(const it of arr){
      if(watchSet.has(it.display_name) && Number(it.quantity)>0){
        const key = `${it.display_name}@${it.start_date_unix || ''}-${it.end_date_unix || ''}`;
        if(!seen.has(key)){
          // Notify
          if(canNotify()){
            new Notification(`Item in stock: ${it.display_name}`, {
              body: `Quantity: ${it.quantity}`,
              icon: imgFor(it.display_name, it.icon)
            });
          }
          seen.add(key);
        }
      }
    }
  }
}

// Call notifications periodically
setInterval(notifyForWatched, 15000); // every 15 seconds

</script>
</body>
</html>
