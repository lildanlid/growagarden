<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Grow a Garden Stock Monitor</title>
<style>
:root {
  --bg: #f0f0f0;
  --panel: #fff;
  --fg: #222;
  --accent: #8dcf91;
  --header: #474951;
  --transition-duration: 0.4s;
}

body {
  font-family: Arial, sans-serif;
  background: var(--bg);
  margin: 0;
  padding-top: 60px;
  color: var(--fg);
  opacity: 0;
  animation: fadeInBody 1s forwards;
  transition: background var(--transition-duration), color var(--transition-duration);
}

/* Fade in the entire body */
@keyframes fadeInBody {
  to { opacity: 1; }
}

/* Remove loader overlay for immediate load */

h1 {
  text-align: center;
  margin: 0 0 10px 0;
}
.topbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  background: var(--header);
  color: #fff;
  z-index: 9999;
  transition: background var(--transition-duration);
}
#toggleNotifSidebar {
  background: var(--panel);
  border: none;
  border-radius: 6px;
  font-size: 1.1em;
  cursor: pointer;
  padding: 8px 14px;
  transition: background 0.3s;
}
#darkBtn {
  background: var(--panel);
  border: none;
  border-radius: 6px;
  font-size: 1.1em;
  cursor: pointer;
  padding: 8px 14px;
  transition: background 0.3s;
}
#notifSidebar {
  position: fixed;
  top: 60px; /* below top bar */
  right: 0;
  width: 300px;
  height: calc(100% - 60px);
  background: var(--panel);
  box-shadow: -2px 0 12px #0004;
  overflow-y: auto;
  transition: transform 0.4s cubic-bezier(.24,.69,.27,1.01);
  transform: translateX(100%);
  z-index: 9998;
}
#notifSidebar.open {
  transform: translateX(0);
}
#notifHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: var(--header);
  color: #fff;
  font-weight: 600;
}
#notifContent {
  padding: 8px 16px;
}
#notifContent .notif-entry {
  display: flex;
  align-items: center;
  margin: 8px 0;
  cursor: pointer;
  padding: 6px 8px;
  border-radius: 4px;
  transition: background 0.2s;
}
#notifContent .notif-entry:hover {
  background: #eee;
}
#notifContent .notif-entry.selected {
  background: #cce;
}
#notifContent .notif-entry img {
  width: 40px; height: 40px; object-fit: contain; margin-right: 10px;
}
#notifContent span {
  display: flex;
  flex-direction: column;
}
#notifContent span strong {
  font-weight: 600;
}
#notifContent span small {
  font-size: 0.8em;
  opacity: 0.7;
}

.category {
  margin: 10px 0;
  border-radius: 8px;
  background: var(--panel);
  box-shadow: 0 0 7px #0001;
  overflow: hidden;
  transition: max-height 0.4s cubic-bezier(.75,0,.32,1);
}
.category-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 20px;
  background: var(--header);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  user-select: none;
}
.category-header i {
  transition: transform 0.3s;
}
.category.open .category-header i {
  transform: rotate(180deg);
}
.category-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s cubic-bezier(.75,0,.32,1);
}
.category.open .category-body {
  max-height: 1000px; /* large enough for content */
}
.item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 8px;
  transition: background 0.3s, opacity 0.3s, transform 0.2s;
  cursor: default;
}
.item:hover {
  transform: scale(1.02);
}
.item img {
  width: 74px;
  height: 74px;
  object-fit: contain;
  margin-bottom: 4px;
}
.item .name {
  font-weight: bold;
  font-size: 0.95em;
}
.item .qty {
  font-size: 0.85em;
  margin-top: 2px;
}
.out-of-stock {
  opacity: 0.4;
}

/* Responsive adjustments */
@media(max-width: 800px) {
  #notifSidebar {
    width: 250px;
  }
}
</style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <button id="toggleNotifSidebar" title="Toggle Notifications Sidebar">🔔</button>
  <h1 style="margin:0;font-size:1.2em;">Grow a Garden Stock Monitor</h1>
  <button id="darkBtn" title="Dark Mode">🌙</button>
</div>

<!-- Notifications Sidebar -->
<div id="notifSidebar">
  <div id="notifHeader">
    <span style="font-weight:600;">Notifications</span>
    <button style="border:none; background:none; font-size:1.2em; cursor:pointer;" onclick="toggleNotifSidebar()">✖</button>
  </div>
  <div id="notifContent"></div>
</div>

<!-- Main Content -->
<div style="max-width: 1000px; margin: 0 auto; padding: 10px;">
  <!-- Collapsible Categories -->
  <div id="categoriesContainer"></div>
</div>

<script>
const API_STOCK_URL = 'https://growagarden.gg/api/stock';
const API_INFO_URL = 'https://api.joshlei.com/v2/growagarden/info/';
const API_KEY = 'js_c5d322d0652bc477f50348450bb2c6fe4f4d767042b2b0facb69b074c3d46f46';

// Image data for items
const IMAGE_DATA = {
  "Carrot": "https://i.postimg.cc/sgCqpP6L/image.png",
  "Strawberry": "https://i.postimg.cc/XYv0kNG/image2.png",
  "Blueberry": "https://i.postimg.cc/8zV0pQX/image3.png",
  "Tomato": "https://i.postimg.cc/XYZ123/tomato.png",
  "Daffodil": "https://i.postimg.cc/abc123/daffodil.png",
  "Watermelon": "https://i.postimg.cc/wxYZ123/watermelon.png",
  "Pumpkin": "https://i.postimg.cc/xyz789/pumpkin.png",
  "Apple": "https://i.postimg.cc/apple.png",
  "Bamboo": "https://i.postimg.cc/bamboo.png",
  "Coconut": "https://i.postimg.cc/coconut.png",
  "Cactus": "https://i.postimg.cc/cactus.png",
  "Dragon Fruit": "https://i.postimg.cc/dragonfruit.png",
  "Mango": "https://i.postimg.cc/mango.png",
  "Grape": "https://i.postimg.cc/grape.png",
  "Mushroom": "https://i.postimg.cc/mushroom.png",
  "Pepper": "https://i.postimg.cc/pepper.png",
  "Cacao": "https://i.postimg.cc/cacao.png",
  "Beanstalk": "https://i.postimg.cc/beanstalk.png",
  "Ember lily": "https://i.postimg.cc/emberlily.png",
  "Sugar Apple": "https://i.postimg.cc/sugarapple.png",
  "Burning Bud": "https://i.postimg.cc/burningbud.png",
  "Giant Pinecone": "https://i.postimg.cc/pinecone.png",
  "Elder Strawberry": "https://i.postimg.cc/elderstrawberry.png",
  "Romanesco": "https://i.postimg.cc/romanesco.png"
  // Add more images as needed
};

// Notification item names
const SEEDS = ["Carrot", "Strawberry", "Blueberry", "Tomato", "Daffodil", "Watermelon", "Pumpkin", "Apple", "Bamboo", "Coconut", "Cactus", "Dragon Fruit", "Mango", "Grape", "Mushroom", "Pepper", "Cacao", "Beanstalk", "Ember lily", "Sugar Apple", "Burning Bud", "Giant Pinecone", "Elder Strawberry","Romanesco"];
const GEARS = ["Watering Can", "Trowel", "Recall Wrench", "Basic Sprinkler", "Advanced Sprinkler", "Medium Toy", "Medium Treat", "Godly Sprinkler", "Magnifying Glass", "Tanning Mirror", "Master Sprinkler", "Cleaning Spray", "Favorite Tool", "Harvest Tool", "Friendship Pot", "Levelup Lolipop"];
const EGGS = ["Common Egg", "Common Summer Egg", "Rare Summer Egg", "Mythical Egg", "Paradise Egg", "Bug Egg"];

// Local storage helpers
function save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
function load(key, def) { try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; } }

// Load saved state
let selectedNotifs = load('selectedNotifs', { seeds: [], gears: [], eggs: [] });
let openCats = load('openCats', {});
let darkMode = load('dark', '1') === '1';

// Dark mode toggle
function setDark(on) {
  if (on) document.body.classList.add('dark');
  else document.body.classList.remove('dark');
  document.getElementById('darkBtn').textContent = on ? "☀️" : "🌙";
  save('dark', on ? '1' : '0');
}
const isDark = darkMode;
setDark(isDark);
document.getElementById('darkBtn').onclick = () => { setDark(!document.body.classList.contains('dark')); };

// Sidebar toggle
const sidebar = document.getElementById('notifSidebar');
const toggleSidebarBtn = document.getElementById('toggleNotifSidebar');
toggleSidebarBtn.onclick = () => {
  sidebar.classList.toggle('open');
};
function toggleNotifSidebar() {
  sidebar.classList.toggle('open');
}

// Create notification checkboxes
function createNotifCheckboxes(divId, items, key) {
  const container = document.getElementById(divId);
  container.innerHTML = '';
  items.forEach(name => {
    const label = document.createElement('label');
    label.style.display='block';
    const chk = document.createElement('input');
    chk.type='checkbox';
    chk.value = name;
    chk.checked= selectedNotifs[key]?.includes(name);
    chk.onchange= () => {
      if (chk.checked) {
        if (!selectedNotifs[key]?.includes(name))
          selectedNotifs[key]?.push(name);
      } else {
        selectedNotifs[key] = selectedNotifs[key]?.filter(n => n !== name);
      }
      save('selectedNotifs', selectedNotifs);
      if (lastStockData) renderNotificationPanel(lastStockData);
    };
    label.appendChild(chk);
    label.appendChild(document.createTextNode(' ' + name));
    container.appendChild(label);
  });
}
createNotifCheckboxes('seed-notifications', SEEDS, 'seeds');
createNotifCheckboxes('gear-notifications', GEARS, 'gears');
createNotifCheckboxes('egg-notifications', EGGS, 'eggs');

// Utility for time ago
function timeAgo(epochStr) {
  if (!epochStr) return '';
  const epoch = parseInt(epochStr);
  const now = Math.floor(Date.now() / 1000);
  const diff = now - epoch;
  if (diff < 60) return `${diff}s ago`;
  if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
  return `${Math.floor(diff/86400)}d ago`;
}

// Fetch stock data
let lastStockData = null;
async function fetchStock() {
  try {
    const res = await fetch(API_STOCK_URL, {
      headers: {
        'accept': 'application/json',
        'jstudio-key': API_KEY
      }
    });
    const data = await res.json();
    lastStockData = data;
    renderStock(data);
    renderNotificationPanel(data);
  } catch(e) {
    console.error("Fetch error", e);
  }
}
fetchStock();
setInterval(fetchStock, 12000);

// Render stock categories
function renderStock(data) {
  const container = document.getElementById('categoriesContainer');
  container.innerHTML = '';
  const categories = [
    { name:'Seeds', items: data.seed_stock, key: 'seeds' },
    { name:'Gears', items: data.gear_stock, key: 'gears' },
    { name:'Eggs', items: data.egg_stock, key: 'eggs' },
    { name:'Cosmetics', items: data.cosmetic_stock },
    { name:'Event Shop', items: data.eventshop_stock }
  ];

  categories.forEach(cat => {
    if (!cat.items?.length) return;
    const catId = cat.name.toLowerCase().replace(/\s+/g, '');
    const isOpen = !!openCats[catId];
    const categoryDiv = document.createElement('div');
    categoryDiv.className='category'+(isOpen?' open':'');
    categoryDiv.innerHTML= `
      <div class="category-header" onclick="toggleCategory('${catId}')">
        ${cat.name} <i>${isOpen?'▲':'▼'}</i>
      </div>
      <div class="category-body"></div>
    `;
    const bodyDiv = categoryDiv.querySelector('.category-body');
    if (isOpen) {
      bodyDiv.innerHTML= cat.items.map(item => {
        const name= item.display_name;
        const icon= IMAGE_DATA[name] || item.icon || '';
        return `<div class="item ${item.quantity===0?'out-of-stock':''}">
          <img src="${icon}" alt="${name}">
          <div class="name">${name}</div>
          <div class="qty">Qty: ${item.quantity}</div>
        </div>`;
      }).join('');
    }

    container.appendChild(categoryDiv);
  });
}
function toggleCategory(catId) {
  openCats[catId]=!openCats[catId];
  save('openCats', openCats);
  if (lastStockData) renderStock(lastStockData);
}

// Render notification list in sidebar
async function renderNotificationPanel(data) {
  const container= document.getElementById('notifContent');
  container.innerHTML= '';
  if (!data) return;

  const itemsToNotify= [
    ...(data.seed_stock||[]).filter(i=> selectedNotifs.seeds?.includes(i.display_name)),
    ...(data.gear_stock||[]).filter(i=> selectedNotifs.gears?.includes(i.display_name)),
    ...(data.egg_stock||[]).filter(i=> selectedNotifs.eggs?.includes(i.display_name))
  ];

  for(const item of itemsToNotify) {
    const name= item.display_name;
    const icon= IMAGE_DATA[name] || item.icon || '';
    // Fetch last seen info
    let lastSeenStr= '';
    try {
      const res= await fetch(`${API_INFO_URL}${encodeURIComponent(name.toLowerCase().replace(/ /g, '_'))}`,
        { headers: { 'accept':'application/json', 'jstudio-key':API_KEY } });
      if (res.ok) {
        const info= await res.json();
        if (info.last_seen) lastSeenStr= timeAgo(info.last_seen);
      }
    } catch(e) { console.error(e); }
    const isSelected= false; // Optional: add selection logic if needed
    const entryDiv= document.createElement('div');
    entryDiv.className='notif-entry';
    // Mark selected
    if (false) entryDiv.classList.add('selected');
    entryDiv.innerHTML= `
      <img src="${icon}" alt="${name}">
      <div>
        <strong>${name}</strong>
        <small>Status: ${item.quantity>0 ? '✔️':'❌'}</small>
        <small>${lastSeenStr}</small>
      </div>
    `;
    container.appendChild(entryDiv);
  }
}

// Initialize
// Load saved open categories
// No need to do anything as default is empty object
// The stock and notification panel will load automatically
</script>
</body>
</html>
