<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grow a Garden ‚Äî Stock Monitor</title>
<style>
  :root{
    --bg: #f6f7fb;
    --card: #ffffff;
    --text: #1f2330;
    --muted: #707789;
    --accent: #6b7cff;
    --accent-2:#50e3c2;
    --border:#e6e8f0;
    --good:#18a957;
    --bad:#e24a4a;
    --shadow: 0 6px 20px rgba(0,0,0,.08);
  }
  html.dark{
    --bg:#0d0f15;
    --card:#121622;
    --text:#dfe6ff;
    --muted:#9aa3b2;
    --accent:#8d9bff;
    --accent-2:#65f2d0;
    --border:#1e2433;
    --shadow: 0 8px 24px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background:var(--bg); color:var(--text);
  }
  /* Header */
  header{
    position:sticky; top:0; z-index:30; backdrop-filter:saturate(120%) blur(8px);
    background:linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,0)) ;
  }
  .bar{
    display:flex; align-items:center; gap:10px; padding:14px 20px;
  }
  .title{font-weight:800; letter-spacing:.3px; font-size:18px; display:flex; align-items:center; gap:10px}
  .pill{
    padding:4px 10px; border-radius:999px; background:var(--card); border:1px solid var(--border); color:var(--muted); font-size:12px
  }
  .spacer{flex:1}
  button.icon{
    border:none; background:var(--card); border:1px solid var(--border); box-shadow:var(--shadow);
    width:38px; height:38px; border-radius:12px; display:grid; place-items:center; cursor:pointer; transition:transform .15s ease, opacity .15s;
  }
  button.icon:hover{transform:translateY(-1px)}
  button.icon:active{transform:translateY(0)}
  .row{max-width:1200px; margin:0 auto; padding:18px}

  /* Grid + cards */
  .categories{display:grid; grid-template-columns:1fr; gap:14px}
  @media (min-width: 880px){ .categories{grid-template-columns:1fr 1fr} }
  @media (min-width: 1180px){ .categories{grid-template-columns:1fr 1fr} }

  .card{
    background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); overflow:hidden;
    transition: background .2s ease, border-color .2s ease;
  }
  .card-header{
    display:flex; align-items:center; justify-content:space-between; padding:12px 16px; cursor:pointer; user-select:none;
  }
  .card-header h2{margin:0; font-size:16px}
  .badge{
    background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#fff; padding:2px 10px; font-size:12px; border-radius:999px; font-weight:700
  }
  .chev{transition: transform .3s ease; opacity:.7}
  .card.open .chev{transform:rotate(180deg)}
  .card-body{
    overflow:hidden; max-height:0; transition:max-height .45s cubic-bezier(.2,.8,.2,1), opacity .25s ease;
    opacity:0; border-top:1px dashed var(--border);
  }
  .card.open .card-body{opacity:1}
  .list{
    display:grid; grid-template-columns:repeat(auto-fill, minmax(240px,1fr)); gap:12px; padding:14px;
  }
  .item{
    display:flex; gap:12px; align-items:center; padding:10px; border:1px solid var(--border); border-radius:14px; transition: transform .12s ease, background .2s;
    background:linear-gradient(180deg, rgba(0,0,0,.02), transparent);
  }
  .item:hover{transform:translateY(-1px)}
  .item.dim{opacity:.45; filter:grayscale(.35)}
  .item img{width:44px; height:44px; border-radius:10px; object-fit:cover; background:#00000008}
  .meta{display:flex; flex-direction:column; gap:2px}
  .name{font-weight:700}
  .sub{font-size:12px; color:var(--muted)}
  .qty{margin-left:auto; font-weight:800}

  /* Sidebar (notifications) */
  .scrim{
    position:fixed; inset:0; background:rgba(0,0,0,.28); opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:40;
  }
  .scrim.show{opacity:1; pointer-events:auto}
  .sidebar{
    position:fixed; top:0; right:0; width:min(380px, 92vw); height:100dvh; background:var(--card); border-left:1px solid var(--border);
    box-shadow: -12px 0 40px rgba(0,0,0,.25); transform:translateX(100%); transition: transform .35s cubic-bezier(.2,.8,.2,1);
    z-index:41; display:flex; flex-direction:column;
  }
  .sidebar.open{transform:translateX(0)}
  .side-head{display:flex; align-items:center; gap:10px; padding:14px 16px; border-bottom:1px solid var(--border)}
  .side-head h3{margin:0; font-size:16px}
  .side-body{padding:10px 14px; overflow:auto; display:flex; flex-direction:column; gap:16px}
  .chip{display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; cursor:pointer; user-select:none}
  .chip input{accent-color:var(--accent)}
  .group h4{margin:6px 0 8px; color:var(--muted); font-size:12px; letter-spacing:.4px; text-transform:uppercase}
  .notif-row{
    display:grid; grid-template-columns:36px 1fr 22px; gap:8px; align-items:center;
    padding:8px 10px; border:1px dashed var(--border); border-radius:12px;
  }
  .notif-row img{width:36px; height:36px; border-radius:8px; object-fit:cover}
  .tick{font-weight:900; font-size:16px}
  .tick.good{color:var(--good)} .tick.bad{color:var(--bad)}
  .ls{font-size:12px; color:var(--muted)}

  /* Loading screen */
  .loading{
    position:fixed; inset:0; display:grid; place-items:center; background:var(--bg); z-index:50;
    animation: fadeOut .6s ease .2s forwards; pointer-events:none;
  }
  .spinner{
    width:56px; height:56px; border-radius:50%; border:4px solid transparent; border-top-color:var(--accent); border-right-color:var(--accent-2);
    animation: spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes fadeOut{to{opacity:0; visibility:hidden}}

  /* Small helpers */
  .row-muted{color:var(--muted); font-size:12px}
  .fade-in{animation: fadeIn .4s ease both}
  @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
</style>
</head>
<body>
  <!-- LOADING -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="bar row">
      <div class="title">
        üå± Grow a Garden
        <span class="pill" id="statusPill">Connecting‚Ä¶</span>
      </div>
      <div class="spacer"></div>
      <button id="darkToggle" class="icon" title="Toggle dark mode" aria-label="Toggle dark mode">üåì</button>
      <button id="openSidebar" class="icon" title="Notifications" aria-label="Notifications">üîî</button>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="row">
    <div class="row-muted" id="updatedAt">‚Äî</div>
    <div class="categories" id="categories"></div>
  </main>

  <!-- SIDEBAR + SCRIM -->
  <div id="scrim" class="scrim"></div>
  <aside id="sidebar" class="sidebar" aria-label="Notifications sidebar" aria-hidden="true">
    <div class="side-head">
      <h3>Notifications</h3>
      <div class="spacer"></div>
      <button id="closeSidebar" class="icon" title="Close" aria-label="Close">‚úï</button>
    </div>
    <div class="side-body" id="sideBody">
      <div class="group">
        <h4>Select items</h4>
        <div id="chips"></div>
      </div>
      <div class="group">
        <h4>Watchlist Status</h4>
        <div id="watchlist"></div>
      </div>
      <div class="group">
        <h4>Tips</h4>
        <div class="row-muted">
          ‚Ä¢ Enable browser notifications when prompted.<br>
          ‚Ä¢ ‚ÄúLast seen‚Äù comes from the item info endpoint.<br>
          ‚Ä¢ Your selections + theme are saved locally.
        </div>
      </div>
    </div>
  </aside>

<script>
/* =======================
   CONFIG / CONSTANTS
======================= */
const API_URL = 'https://api.joshlei.com/v2/growagarden/stock';
const API_INFO = (id) => `https://api.joshlei.com/v2/growagarden/info/${id}`;
const API_KEY = 'js_c5d322d0652bc477f50348450bb2c6fe4f4d767042b2b0facb69b074c3d46f46';

const POLL_MS = 30_000;
const INFO_TTL_MS = 5 * 60_000; // cache info for 5 minutes

// Item lists (display names)
const SEEDS = ["Carrot","Strawberry","Blueberry","Tomato","Daffodil","Watermelon","Pumpkin","Apple","Bamboo","Coconut","Cactus","Dragon Fruit","Mango","Grape","Mushroom","Pepper","Cacao","Beanstalk","Ember lily","Sugar Apple","Burning Bud","Giant Pinecone","Elder Strawberry","Romanesco"];
const GEARS = ["Watering Can","Trowel","Recall Wrench","Basic Sprinkler","Advanced Sprinkler","Medium Toy","Medium Treat","Godly Sprinkler","Magnifying Glass","Tanning Mirror","Master Sprinkler","Cleaning Spray","Favorite Tool","Harvest Tool","Friendship Pot","Levelup Lolipop"];
const EGGS  = ["Common Egg","Common Summer Egg","Rare Summer Egg","Mythical Egg","Paradise Egg","Bug Egg"];

// Image data (preferred over API icons). Add more mappings as needed.
const imageData = {
  "Carrot": "https://i.postimg.cc/sgCqpP6L/image.png",
    "Strawberry": "https://i.postimg.cc/FFymdsZr/Strawberry.png",
    "Blueberry": "https://i.postimg.cc/RV9SXZ7h/image.png",
    "Orange Tulip": "https://i.postimg.cc/BQ3SM16P/Orange-Tulip.png",
    "Tomato": "https://i.postimg.cc/MGhxR6ZW/image.png",
    "Corn": "https://i.postimg.cc/0QG3Qrqh/Corn.png",
    "Daffodil": "https://i.postimg.cc/Z57Jb7L6/Daffodil.png",
    "Watermelon": "https://i.postimg.cc/kXsB3bsL/image.png",
    "Pumpkin": "https://i.postimg.cc/3xWPBKgD/Pumpkin.png",
    "Apple": "https://i.postimg.cc/d1MP3zZZ/Apple.png",
    "Bamboo": "https://i.postimg.cc/5NshLHFV/Bamboo.png",
    "Coconut": "https://i.postimg.cc/90JndS0p/Coconut.png",
    "Cactus": "https://i.postimg.cc/0jssWL81/Cactus.png",
    "Dragon Fruit": "https://i.postimg.cc/7Yq4g8sg/Dragon-Fruit.png",
    "Mango": "https://i.postimg.cc/MGgxRnNT/Mango.png",
    "Grape": "https://i.postimg.cc/0y3hXLfX/Grape.png",
    "Mushroom": "https://i.postimg.cc/cHW9VZ8h/Mushroom.png",
    "Pepper": "https://i.postimg.cc/59gq262W/image.png",
    "Cacao": "https://i.postimg.cc/KvY7kx1k/image.png",
    "Lemon": "https://i.postimg.cc/pdhTF1vt/image.png",
    "Pineapple": "https://i.postimg.cc/ZnzZCWgt/Pineapple-Fruit-Icon.png",
    "Peach": "https://i.postimg.cc/NFY37m4g/Peach.png",
    "Pear": "https://i.postimg.cc/FFk86F63/image.png",
    "Papaya": "https://i.postimg.cc/5N2G4xKk/Papaya.png",
    "Banana": "https://i.postimg.cc/Df1nRcJ2/Banana-Pic.png",
    "Passion Fruit": "https://i.postimg.cc/sfPyQCkr/image.png",
    "Soul Fruit": "https://i.postimg.cc/fRyhrtJz/image.png",
    "Cursed Fruit": "https://i.postimg.cc/26vYxzNx/Cursed-Fruit.png",
    "Chocolate Carrot": "https://i.postimg.cc/zGB1cw1v/Chocolate-Carrot.png",
    "Red Lollipop": "https://i.postimg.cc/6QvgkYbW/Red-Lollipop.png",
    "Candy Sunflower": "https://i.postimg.cc/zvj9dvtT/Candy-Sunflower.png",
    "Easter Egg": "https://i.postimg.cc/MGfJWWH8/Easter-Egg.png",
    "Candy Blossom": "https://i.postimg.cc/HW9DWvYj/Candy-Blossom.png",
    "Raspberry": "https://i.postimg.cc/m2VsjXJK/Raspberry.png",
    "Cranberry": "https://i.postimg.cc/tTtdPgdP/image.png",
    "Durian": "https://i.postimg.cc/Z57Jb7L6/Durian.png",
    "Eggplant": "https://i.postimg.cc/9FLFNjFh/image.png",
    "Venus Fly Trap": "https://i.postimg.cc/7L0tsbbb/Venus-Fly-Trap.png",
    "Lotus": "https://i.postimg.cc/PJr654y8/Lotus.png",
    "Glowshroom": "https://i.postimg.cc/RZMkn3c1/image.png",
    "Mint": "https://i.postimg.cc/pTn4tKHv/image.png",
    "Moonflower": "https://i.postimg.cc/T2gF7j0q/image.png",
    "Starfruit": "https://i.postimg.cc/kgXHg0mf/image.png",
    "Moonglow": "https://i.postimg.cc/wB1bhD3N/image.png",
    "Moon Blossom": "https://i.postimg.cc/L6mCxcn2/image.png",
    "Cherry Blossom": "https://i.postimg.cc/1XCvnq77/Cherry-Blossom.png",
    "Moon Melon": "https://i.postimg.cc/wTWvxTsT/image.png",
    "Beanstalk": "https://i.postimg.cc/dVL0hP8R/image.png",
    "Blood Banana": "https://i.postimg.cc/hGmP0LZf/image.png",
    "Moon Mango": "https://i.postimg.cc/cHv3fmt7/image.png",
    "Celestiberry": "https://i.postimg.cc/Zqhs7Wxy/image.png",
    "Rose": "https://i.postimg.cc/TY9zMtJx/image.png",
    "Foxglove": "https://i.postimg.cc/yd4QSRyn/image.png",
    "Lilac": "https://i.postimg.cc/1XRKprn0/image.png",
    "Pink Lily": "https://i.postimg.cc/NGN63T2V/image.png",
    "Purple Dahila": "https://i.postimg.cc/tCkms7fG/image.png",
    "Nectarine": "https://i.postimg.cc/15q8vNGD/image.png",
    "Hive Fruit": "https://i.postimg.cc/8CKv2gjv/image.png",
    "Sunflower": "https://i.postimg.cc/2jvqwZFh/image.png",
    "Honeysuckle": "https://i.postimg.cc/s28WQ2yt/image.png",
    "Lavender": "https://i.postimg.cc/gchVh3x4/image.png",
    "Manuka Flower": "https://i.postimg.cc/MpmtQVrg/image.png",
    "Nectarshade": "https://i.postimg.cc/26KZWSDs/image.png",
    "Dandelion": "https://i.postimg.cc/MZL7MdZn/image.png",
    "Lumira": "https://i.postimg.cc/J7Yq3Rx4/image.png",
    "Ember Lily": "https://i.postimg.cc/4db04jRH/image.png",
    "Feijoa": "https://i.postimg.cc/3xYRtct5/Feijoa-Produce.png",
    "Loquat": "https://i.postimg.cc/GpSmhhdd/Loquat-Produce.png",
    "Prickly Pear": "https://i.postimg.cc/d1bQrHhf/Prickly-Pear.png",
    "Bell Pepper": "https://i.postimg.cc/P5St2rLY/Bell-Pepper1.png",
    "Kiwi": "https://i.postimg.cc/J4PbzThb/image.png",
    "Avocado": "https://i.postimg.cc/pLLvhb0T/Avocadocrop2.png",
    "Green Apple": "https://i.postimg.cc/5tHMg5WW/Green-apple-produce.png",
    "Cauliflower": "https://i.postimg.cc/xCMVD0ds/Cauliflower-Produce.png",
    "Elephant Ears": "https://i.postimg.cc/QdFfFfr5/image.png",
    "Rosy Delight": "https://i.postimg.cc/662F642j/image.png",
    "Parasol Flower": "https://i.postimg.cc/fyv4yBmm/Parasol-Flower.png",
    "Cantaloupe": "https://i.postimg.cc/Px33R9W6/image.png",
    "Wild Carrot": "https://i.postimg.cc/QdFfFfr5/image.png",
    "Pitcher Plant": "https://i.postimg.cc/qqJ6CfkF/Pitcherproduce.png",
    "Traveler's Fruit": "https://i.postimg.cc/J0pDNT0z/Travelers-Fruit-Plant.png",
    "Guanabana": "https://i.postimg.cc/Prq8XkVp/Guanabana-Produce-By-Nonoloing14.png",
    "Lily Of The Valley": "https://i.postimg.cc/Nj3yk2sm/Lily-Of-The-Valley-Crop.png",
    "Aloe Vera": "https://i.postimg.cc/76DfpvTL/Aloe-Vera-Plant.png",
    "Rafflesia": "https://i.postimg.cc/5y2j2wgd/Rafflesia-Icon.png",
    "Peace Lily": "https://i.postimg.cc/44WmFS4J/Peace-Lily-removebg-preview.png",
    "Delphinium": "https://i.postimg.cc/L67hmgZw/Delphinium-Produce.png",
    "Firework Flower": "https://i.postimg.cc/HWwLKSck/image.png",
    "Liberty Lily": "https://i.postimg.cc/m2VgZtSx/image.png",
    "Sugar Apple": "https://i.postimg.cc/jjLmLYgX/image.png",
    "Bone Blossom": "https://i.postimg.cc/J0g1g523/image.png",
    "Burning Bud": "https://i.postimg.cc/2Syt3f35/image.png",
    "Fossilight": "https://i.postimg.cc/hvGLMckz/image.png",
    "Giant Pinecone": "https://i.postimg.cc/YqWhcDS9/image.png",
    "Grand Volcania": "https://i.postimg.cc/2SN3Cdqx/image.png",
    "Amber Spine": "https://i.postimg.cc/fR7yy3mQ/image.png",
    "Lingonberry": "https://i.postimg.cc/Gpc2ycx8/image.png",
    "Horsetail": "https://i.postimg.cc/JhPh39pT/image.png",
    "Firefly Fern": "https://i.postimg.cc/gknyZcy1/image.png",
    "Boneboo": "https://i.postimg.cc/KvwPrXJj/image.png",
    "Horned Dinoshroom": "https://i.postimg.cc/nrMmBTmq/image.png",
    "Paradise Petal": "https://i.postimg.cc/MGxjdzR6/image.png",
    "Stonebite": "https://i.postimg.cc/pybdrBJW/image.png",
    "Maple Apple": "https://i.postimg.cc/2Shd6ryy/image.png",
    "Spiked Mango": "https://i.postimg.cc/W4VGqCqn/image.png",
    "Hinomai": "https://i.postimg.cc/V6LXDtR0/image.png",
    "Soft Sunshine": "https://i.postimg.cc/tTSWfgSS/image.png",
    "Zen Rocks": "https://i.postimg.cc/nVWqGCQM/image.png",
    "Zenflare": "https://i.postimg.cc/fT0m2DxC/image.png",
    "Taro Flower": "https://i.postimg.cc/4x6tGP2h/image.png",
    "Serenity": "https://i.postimg.cc/JhRXzXSY/image.png",
    "Monoblooma": "https://i.postimg.cc/vmXVgBsY/image.png",
    "Elder Strawberry": "https://i.postimg.cc/zXYvyScs/image.png",
    "Tranquil Bloom": "https://i.postimg.cc/rsNk0WdT/image.png",
    "Enkaku": "https://i.postimg.cc/fbVD2JP7/image.png",
    "Sakura Bush": "https://i.postimg.cc/c1RZbqFz/image.png",
    "Lucky Bamboo": "https://i.postimg.cc/7Z6kh5qv/image.png",
    "Dezen": "https://i.postimg.cc/9M35L1ZV/image.png",
    "Grand Tomato": "https://i.postimg.cc/yYYt0GWN/Grand-Tomato-Produce.png",
    "Tall Asparagus": "https://i.postimg.cc/dtHX69Tj/Tall-Asparagus-Produce.png",
    "Taco Fern": "https://i.postimg.cc/BnPhgf3J/image.png",
    "Sugarglaze": "https://i.postimg.cc/fR1PnTC3/Sugarglaze-Produce.png",
    "Veinpetal": "https://i.postimg.cc/d0dxqPN5/Veinpetal-Produce.png",
    "Twisted Tangle": "https://i.postimg.cc/RFBbhsj4/Twisted-Tangle-Produce.png",
    "Crown Melon": "https://i.postimg.cc/Hx9vy0g5/Crown-Melon-Crop.png",
    "Jalapeno": "https://i.postimg.cc/fyW2j3zP/Jalapeno-Crop.png",
    "Artichoke": "https://i.postimg.cc/br666zdw/Artichoke-Produce.png",
    "Onion": "https://i.postimg.cc/Df5Yfc53/Onion-Crop.png",
    "King Cabbage": "https://i.postimg.cc/1XXvnjDR/image.png",
    "Badlands Pepper": "https://i.postimg.cc/9f21tMyn/image.png",
    "Bitter Melon": "https://i.postimg.cc/DwkcnZpw/image.png",
    "Pricklefruit": "https://i.postimg.cc/dDMGsHBx/image.png",
    "Butternut Squash": "https://i.postimg.cc/8PW0hxqs/image.png",
    "Spring Onion": "https://i.postimg.cc/52VkpnVg/image.png",
    "Rhubarb": "https://i.postimg.cc/NjkCnmGc/image.png",
    "Romanesco": "https://i.postimg.cc/vT8FVj2z/image.png",
    "Amberheart": "https://i.postimg.cc/FzPtgZ2Q/image.png",
    "Princess Thorn": "https://i.postimg.cc/WpSPvNtf/image.png",
    "Gleamroot": "https://i.postimg.cc/8P0Q7ZRR/image.png",
    "Poseidon Plant": "https://i.postimg.cc/Vk0ynXg3/image.png",
    "Canary Melon": "https://i.postimg.cc/zfT9P597/image.png",
    "Mandrake": "https://i.postimg.cc/k49L0zCm/image.png",
    "Duskpuff": "https://i.postimg.cc/1tHbsBRN/image.png",
    "Flare Daisy": "https://i.postimg.cc/RhZyFtqp/image.png",
    "Golden Egg": "https://i.postimg.cc/qqDYC73J/image.png",
    "Magnifying Glass": "https://i.postimg.cc/28Jdg6j8/image.png",
    "Watering Can": "https://i.postimg.cc/3JPcnJgS/image.png",
    "Trowel": "https://i.postimg.cc/43RjNNy7/image.png",
    "Basic Sprinkler": "https://i.postimg.cc/zBjtN7c9/image.png",
    "Advanced Sprinkler": "https://i.postimg.cc/ZKkcQ1nC/image.png",
    "Godly Sprinkler": "https://i.postimg.cc/g0r8jDjC/image.png",
    "Lightning Rod": "https://i.postimg.cc/K8p36MfJ/image.png",
    "Master Sprinkler": "https://i.postimg.cc/SKMSs2LS/image.png",
    "Grandmaster Sprinkler": "https://i.postimg.cc/yYmhY67g/image.png",
    "Chocolate Sprinkler": "https://i.postimg.cc/0N6KPyHx/image.png",
    "Honey Sprinkler": "https://i.postimg.cc/mkKZCR8Q/image.png",
    "Recall Wrench": "https://i.postimg.cc/wvPFZrxm/image.png",
    "Favorite Tool": "https://i.postimg.cc/ZK7qnhNq/image.png",
    "Harvest Tool": "https://i.postimg.cc/pVD2DNKm/image.png",
    "Star Caller": "https://i.postimg.cc/3wsYMCB9/image.png",
    "Pollen Radar": "https://i.postimg.cc/pV9m5v6H/image.png",
    "Nectar Staff": "https://i.postimg.cc/138CLfWd/image.png",
    "Friendship Pot": "https://i.postimg.cc/g2bLP74P/image.png",
    "Tanning Mirror": "https://i.postimg.cc/g2bfS70c/image.png",
    "Cleaning Spray": "https://i.postimg.cc/c4wzncBp/image.png",
    "Trading Ticket": "https://i.postimg.cc/yNkS97CT/image.png",
    "Starfish": "https://i.postimg.cc/D06jqK14/image.png",
    "Crab": "https://i.postimg.cc/CMsQyb9M/image.png",
    "Seagull": "https://i.postimg.cc/BQZwJXGT/image.png",
    "Golden Lab": "https://i.postimg.cc/nVs3ZHJ2/Golden-Lab-Pet.png",
    "Dog": "https://i.postimg.cc/FRzJysZB/DogPet.png",
    "Bunny": "https://i.postimg.cc/nLHmL1QZ/BunnyPet.png",
    "Black Bunny": "https://i.postimg.cc/SQwDxwQh/Black-bunny-icon.png",
    "Chicken": "https://i.postimg.cc/pLKQrTGQ/Chicken-Pet-V2.png",
    "Cat": "https://i.postimg.cc/VN1qC8px/Catpet.png",
    "Deer": "https://i.postimg.cc/tCxWvJj0/Deer.png",
    "Orange Tabby": "https://i.postimg.cc/qqChFbWc/Orange-tabby-icon.png",
    "Spotted Deer": "https://i.postimg.cc/RZTRGh7S/Spotteddeer.png",
    "Pig": "https://i.postimg.cc/B6mB3Vhd/Pig-no-back.png",
    "Rooster": "https://i.postimg.cc/d0B8RfKL/Rooster.png",
    "Monkey": "https://i.postimg.cc/Fzf34skL/Monkey-Pet-V2.png",
    "Cow": "https://i.postimg.cc/8zgW2Gp7/Cow.png",
    "Silver Monkey": "https://i.postimg.cc/PJBZrs1F/Silvermonkey.png",
    "Sea Otter": "https://i.postimg.cc/G2gGVstR/Sea-Otter.png",
    "Turtle": "https://i.postimg.cc/3Rq0n5fJ/Turtle-icon.png",
    "Polar Bear": "https://i.postimg.cc/yxWX8ytW/Polarbear.png",
    "Snail": "https://i.postimg.cc/5028smxp/Snail-Pet.png",
    "Giant Ant": "https://i.postimg.cc/Qx9JLScy/Giantantv2.png",
    "Caterpillar": "https://i.postimg.cc/KcVt5LCr/Caterpillar-no-back.png",
    "Praying Mantis": "https://i.postimg.cc/cJMc9Hf1/Mantis-NBG.png",
    "Dragonfly": "https://i.postimg.cc/cJNmBYg5/Dragonfly-Icon.png",
    "Panda": "https://i.postimg.cc/JhPkHBbX/PandaPet.png",
    "Hedgehog": "https://i.postimg.cc/HjDc10Cq/Hedgehog-Pet.png",
    "Mole": "https://i.postimg.cc/Mp0RxLHd/Mole.png",
    "Frog": "https://i.postimg.cc/XJjkTbgf/FrogV2.png",
    "Echo Frog": "https://i.postimg.cc/bYDfMcFc/image-removebg-preview.png",
    "Night Owl": "https://i.postimg.cc/9FZ1RJzq/Night-Owl-Pic.png",
    "Cooked Owl": "https://i.postimg.cc/6pxsYbRX/image.png",
    "Raccoon": "https://i.postimg.cc/FHvpj3JC/Racoon.png",
    "Hamster": "https://i.postimg.cc/TwD8CcKs/image.png",
    "Owl": "https://i.postimg.cc/SRVzjsmy/image.png",
    "Chicken Zombie": "https://i.postimg.cc/MZf2f64p/image.png",
    "Blood Owl": "https://i.postimg.cc/KzV6pwKb/image.png",
    "Blood Hedgehog": "https://i.postimg.cc/438kVmsm/image.png",
    "Blood Kiwi": "https://i.postimg.cc/d3b5GKh7/image.png",
    "Grey Mouse": "https://i.postimg.cc/vBhpSqtG/image.png",
    "Brown Mouse": "https://i.postimg.cc/x8dWrv6M/image.png",
    "Moon Cat": "https://i.postimg.cc/T3jJPCnp/image.png",
    "Squirrel": "https://i.postimg.cc/28VP2xbf/image.png",
    "Red Giant Ant": "https://i.postimg.cc/YCFTwqzn/image.png",
    "Red Fox": "https://i.postimg.cc/3wC6dS62/image.png",
    "Bee": "https://i.postimg.cc/52w6ttG7/image.png",
    "Honey Bee": "https://i.postimg.cc/HxLx39LR/image.png",
    "Bear Bee": "https://i.postimg.cc/y8P3PdPJ/image.png",
    "Petal Bee": "https://i.postimg.cc/RZXqtYSK/image.png",
    "Queen Bee": "https://i.postimg.cc/05fLwtM4/image.png",
    "Wasp": "https://i.postimg.cc/4yk6Y3ZW/image.png",
    "Tarantula Hawk": "https://i.postimg.cc/PfwKTgh6/image.png",
    "Moth": "https://i.postimg.cc/gjZg75cT/image.png",
    "Butterfly": "https://i.postimg.cc/g0gRYJL9/image.png",
    "Disco Bee": "https://i.postimg.cc/T16FV9SF/Disco-Bee-Icon.gif",
    "Meerkat": "https://i.postimg.cc/rFCcPdN5/Meerkat.png",
    "Sand Snake": "https://i.postimg.cc/GmXRbZN2/Sand-Snake-Icon.png",
    "Axolotl": "https://i.postimg.cc/0NrsjVRC/Axolotl-Icon.png",
    "Hyacinth Macaw": "https://i.postimg.cc/Xvh0C9n6/Hyacinth-Macaw-Icon.png",
    "Fennec Fox": "https://i.postimg.cc/mDHWNhrz/Fennec-Fox-Icon.png",
    "Ostrich": "https://i.postimg.cc/8kbfhCfn/image.png",
    "Peacock": "https://i.postimg.cc/DwRS2JRm/image.png",
    "Capybara": "https://i.postimg.cc/1XRtWpV7/image.png",
    "Scarlet Macaw": "https://i.postimg.cc/13RnYN8d/image.png",
    "Mimic Octopus": "https://i.postimg.cc/LX26XzD4/image.png",
    "Bald Eagle": "https://i.postimg.cc/mDMrTjmV/image.png",
    "Flamingo": "https://i.postimg.cc/zXtpMBV5/image.png",
    "Toucan": "https://i.postimg.cc/HkFzYhwh/image.png",
    "Sea Turtle": "https://i.postimg.cc/CKDNzsJL/image.png",
    "Orangutan": "https://i.postimg.cc/XvxRWG8Y/image.png",
    "Seal": "https://i.postimg.cc/gJWKRLBy/image.png",
    "Raptor": "https://i.postimg.cc/8CC0Jg55/Raptor.png",
    "Triceratops": "https://i.postimg.cc/9MRgbPyH/Triceratops.png",
    "Stegosaurus": "https://i.postimg.cc/sD96TgGx/Stegosaurus.png",
    "Pterodactyl": "https://i.postimg.cc/Z5wfhsch/Pterodactyl.png",
    "Brontosaurus": "https://i.postimg.cc/NMHbmswg/Brontosaurus.png",
    "T-Rex": "https://i.postimg.cc/6qxchk9C/T-Rex.png",
    "Parasaurolophus": "https://i.postimg.cc/fRjmVMqv/image.png",
    "Iguanodon": "https://i.postimg.cc/kXBW2yg3/Iguanodon.png",
    "Pachycephalosaurus": "https://i.postimg.cc/3JVmmDky/Pachycephalosaurus.png",
    "Dilophosaurus": "https://i.postimg.cc/Cx8DNL8c/Dilophosaurus.png",
    "Ankylosaurus": "https://i.postimg.cc/25fWXRFr/Ankylosaurus.png",
    "Spinosaurus": "https://i.postimg.cc/MT6Qq7FL/Spinosaurus.png",
    "Shiba Inu": "https://i.postimg.cc/T1N0r0vP/Shiba-Inu.png",
    "Nihonzaru": "https://i.postimg.cc/QNffG8Kr/Nihonzaru.png",
    "Tanuki": "https://i.postimg.cc/NfLpQ3R2/Tanuki.png",
    "Tanchozuru": "https://i.postimg.cc/X7hxqsgH/Tanchozuru.png",
    "Kappa": "https://i.postimg.cc/FHLpL0W9/Kappa.png",
    "Kitsune": "https://i.postimg.cc/6Qx0LTgC/Kitsune.png",
    "Raiju": "https://i.postimg.cc/BQvDgG3T/image.png",
    "Koi": "https://i.postimg.cc/pdPPfPbx/image.png",
    "Maneki-neko": "https://i.postimg.cc/XYjVFV0W/image.png",
    "Kodama": "https://i.postimg.cc/2S6sr3D1/image.png",
    "Corrupted Kitsune": "https://i.postimg.cc/C1HPjV0y/image.png",
    "Corrupted Kodama": "https://i.postimg.cc/C55GzyLs/image.png",
    "Bagel Bunny": "https://i.postimg.cc/G2gYV9PV/Bagel-Bunny.png",
    "Pancake Mole": "https://i.postimg.cc/1Xg6QPJt/Pancake-Mole.png",
    "Sushi Bear": "https://i.postimg.cc/vTpn8jNv/Sushi-Bear.png",
    "Spaghetti Sloth": "https://i.postimg.cc/h4wT0zt7/Spaghetti-Sloth.png",
    "French Fry Ferret": "https://i.postimg.cc/L61fQ9JQ/French-Fry-Ferret.png",
    "Lobster Thermidor": "https://i.postimg.cc/BbKm8tzv/image.png",
    "Gorilla Chef": "https://i.postimg.cc/9XR8gNfj/image.png",
    "Sunny Side Chicken": "https://i.postimg.cc/sD5nsQS6/image.png",
    "Hotdog Daschund": "https://i.postimg.cc/pLxsTWJ2/image.png",
    "Bacon Pig": "https://i.postimg.cc/rpwg1fH3/image.png",
    "Mochi Mouse": "https://i.postimg.cc/59CgSYP4/image.png",
    "Dairy Cow": "https://i.postimg.cc/bJzFCn0Y/image.png",
    "Jackalope": "https://i.postimg.cc/hjpZHGML/image.png",
    "Seedling": "https://i.postimg.cc/90k8QN6z/image.png",
    "Golem": "https://i.postimg.cc/bYVFgsZ8/image.png",
    "Golden Goose": "https://i.postimg.cc/QxBYyh77/image.png",
    "Common Egg": "https://i.postimg.cc/x81BptYT/image.png",
    "Uncommon Egg": "https://i.postimg.cc/qq4gbmkF/image.png",
    "Rare Egg": "https://i.postimg.cc/kGsGkxGg/image.png",
    "Legendary Egg": "https://i.postimg.cc/pL4rbVWz/image.png",
    "Mythical Egg": "https://i.postimg.cc/j2gYCgDM/image.png",
    "Bug Egg": "https://i.postimg.cc/zB1fvdRf/image.png",
    "Night Egg": "https://i.postimg.cc/HnF302kN/image.png",
    "Bee Egg": "https://i.postimg.cc/jSdqfwSH/image.png",
    "Anti Bee Egg": "https://i.postimg.cc/SxH8jsmH/image.png",
    "Paradise Egg": "https://i.postimg.cc/T1wRP4bv/image.png",
    "Rare Summer Egg": "https://i.postimg.cc/JnYq7XdK/image.png",
    "Common Summer Egg": "https://i.postimg.cc/NjxPqKYC/image.png",
    "Oasis Egg": "https://i.postimg.cc/ydtYswD9/image.png",
    "Dinosaur Egg": "https://i.postimg.cc/ZnqtJvdf/image.png",
    "Primal Egg": "https://i.postimg.cc/PfKMpxbZ/image.png",
    "Zen Egg": "https://i.postimg.cc/C1msg714/image.png",
    "Gourment Egg": "https://i.postimg.cc/13KKMmTh/image.png",
    "Sprout Egg": "https://i.postimg.cc/13qTfs5S/image.png",
    "Night Seed Pack": "https://i.postimg.cc/153xjjSs/image.png",
    "Flower Seed Pack": "https://i.postimg.cc/kMvysGm1/image.png",
    "Ancient Seed Pack": "https://i.postimg.cc/zf6v45HH/image.png",
    "Dino Crate": "https://i.postimg.cc/XYBTQbWz/image.png",
    "Beach Crate": "https://i.postimg.cc/qvZ2BPC4/image.png",
    "Twilight Crate": "https://i.postimg.cc/tJ0T5Gwq/image.png",
    "Frog Fountain": "https://i.postimg.cc/PJSTpGWr/Frog-Fountain.png",
    "Wheelbarrow": "https://i.postimg.cc/kXh77mMT/Wheelbarrow.png",
    "Small Wood Table": "https://i.postimg.cc/t4KyVNxP/Small-Wood-Table.png",
    "Beta Gnome": "https://i.postimg.cc/MG1w0f7L/Beta-Gnome.png",
    "Green Female Gnome": "https://i.postimg.cc/xCRShrFy/Green-Female-Gnome.png",
    "Blue Gnome": "https://i.postimg.cc/3NxHHLsM/Blue-Gnome.png",
    "Axe Stump": "https://i.postimg.cc/Gtgn3FR4/Axe-Stump.png",
    "Bamboo Wind Chimes": "https://i.postimg.cc/hPwRH1Mw/Bamboo-Wind-Chimes.png",
    "Bird Bath": "https://i.postimg.cc/YCWBkLsS/Bird-Bath.png",
    "Blue Well": "https://i.postimg.cc/vmwFm8Jt/Blue-Well.png",
    "Brown Stone Pillar": "https://i.postimg.cc/j5vGvHLM/Brown-Stone-Pillar.png",
    "Brown Bench": "https://i.postimg.cc/8c0xgTdW/Brown-Bench.png",
    "Brick Stack": "https://i.postimg.cc/5NDDPN2W/Brick-Stack.png",
    "Bookshelf": "https://i.postimg.cc/KzcWK1JB/Book-Shelf.png",
    "Brown Well": "https://i.postimg.cc/7hdtQmDn/Brown-Well.png",
    "Classic Gnome Crate": "https://i.postimg.cc/FHjCDy60/Classic-Gnome-Crate.png",
    "Campfire": "https://i.postimg.cc/rpjnL8Mm/Campfire.png",
    "Clothesline": "https://i.postimg.cc/SQnhVPf8/Clothesline.png",
    "Common Gnome Crate": "https://i.postimg.cc/DysK3bDw/Common-Gnome-Crate.png",
    "Compost Bin": "https://i.postimg.cc/7ZkrHZ8M/Compost-Bin.png",
    "Cooking Pot": "https://i.postimg.cc/fRfnJQM4/Cooking-Pot.png",
    "Dark Stone Pillar": "https://i.postimg.cc/XvNM51vr/Dark-Stone-Pillar.png",
    "Curved Canopy": "https://i.postimg.cc/hjhHyJTg/Curved-Canopy.png",
    "Farmers Gnome Crate": "https://i.postimg.cc/2yZgYP0K/Farmers-Gnome-Crate.png",
    "Flat Canopy": "https://i.postimg.cc/dQkbGyJj/Flat-Canopy.png",
    "Fun Crate": "https://i.postimg.cc/tRKLk4TQ/Fun-Crate.png",
    "Red Tractor": "https://i.postimg.cc/fRZ14qm8/Red-Tractor.png",
    "Green Tractor": "https://i.postimg.cc/8Cz3cFyW/Green-Tractor.png",
    "Grey Stone Pillar": "https://i.postimg.cc/HLvNypKN/Grey-Stone-Pillar.png",
    "Hay Bale": "https://i.postimg.cc/d1zS55Jm/Hay-Bale.png",
    "Lamp Post": "https://i.postimg.cc/65xmRbjB/Lamp-Post.png",
    "Large Path Tile": "https://i.postimg.cc/HkBZqYpL/Large-Path-Tile.png",
    "Large Stone Pad": "https://i.postimg.cc/jj2gKp54/Large-Stone-Pad.png",
    "Large Wood Arbour": "https://i.postimg.cc/tgcrgBnQ/Large-Wood-Arbour.png",
    "Large Wood Flooring": "https://i.postimg.cc/DZbx411W/Large-Wood-Flooring.png",
    "Large Wood Table": "https://i.postimg.cc/1XhJG4Kv/Large-Wood-Table.png",
    "Log": "https://i.postimg.cc/wxLW6c6Z/Log.png",
    "Log Bench": "https://i.postimg.cc/cL4TMpQG/Log-Bench.png",
    "Sign Crate": "https://i.postimg.cc/W1W895nF/Sign-Crate.png",
    "Bloodmoon Crate": "https://i.postimg.cc/3NxHHLsM/Bloodmoon-Crate.png",
    "Red Well": "https://i.postimg.cc/QC3JBwXP/Red-Well.png",
    "Medium Circle Tile": "https://i.postimg.cc/sx495mx2/Medium-Circle-Tile.png",
    "Torch": "https://i.postimg.cc/hPK0ckZQ/Torch.png",
    "Small Circle Tile": "https://i.postimg.cc/rwmCtSk8/Small-Circle-Tile.png",
    "Wood Fence": "https://i.postimg.cc/4xSvvmfp/Wood-Fence.png",
    "Small Path Tile": "https://i.postimg.cc/6Q4rMtqg/Small-Path-Tile.png",
    "Small Wood Flooring": "https://i.postimg.cc/JnbbWxbQ/Small-Wood-Flooring.png",
    "Mini TV": "https://i.postimg.cc/cC0f13hG/Mini-TV.png",
    "Rock Pile": "https://i.postimg.cc/VvgnJNZr/Rock-Pile.png",
    "Light On Ground": "https://i.postimg.cc/15WDPfNb/Light-On-Ground.png",
    "Rake": "https://i.postimg.cc/6QZZdc1N/Rake.png",
    "Orange Umbrella": "https://i.postimg.cc/LXM1vPrg/Orange-Umbrella.png",
    "Medium Wood Flooring": "https://i.postimg.cc/ZnbyzSYT/Medium-Wood-Flooring.png",
    "Water Trough": "https://i.postimg.cc/d35ZqxDG/Water-Trough.png",
    "Shovel Grave": "https://i.postimg.cc/9Xb7tr1z/Shovel-Grave.png",
    "White Pottery": "https://i.postimg.cc/xTdbsnF5/White-Pottery.png",
    "White Bench": "https://i.postimg.cc/Qd9K3SDW/White-Bench.png",
    "Small Stone Pad": "https://i.postimg.cc/g03wwJnz/Small-Stone-Pad.png",
    "Small Stone Table": "https://i.postimg.cc/T13hHJQ1/Small-Wood-Arbour.png",
    "Small Wood Arbour": "https://i.postimg.cc/tCRFLh7h/Viney-Beam.png",
    "Viney Beam": "https://i.postimg.cc/7htbvJQV/Viney-Ring-Walkway.png",
    "Viney Ring Walkway": "https://i.postimg.cc/L4xJgG61/Square-Metal-Arbour.png",
    "Square Metal Arbour": "https://i.postimg.cc/Qd9K3SDW/White-Bench.png",
    "Small Stone Lantern": "https://i.postimg.cc/TYShCmb2/Small-Stone-Lantern.png",
    "Classic Trowel": "https://i.postimg.cc/SQnhVPf8/Classic-Trowel.png",
    "Hay Bail": "https://i.postimg.cc/d1zS55Jm/Hay-Bale.png",
    "Long Stone Table": "https://i.postimg.cc/FKXzQ4G2/Long-Stone-Table.png",
    "Medium Stone Table": "https://i.postimg.cc/FKbRrBB1/Medium-Stone-Table.png",
    "Metal Wind Chime": "https://i.postimg.cc/rm8pKNBj/Metal-Wind-Chime.png",
    "Mysterious Crate": "https://i.postimg.cc/vB3Z96Ms/Mysterious-Crate.png",
    "Red Pottery": "https://i.postimg.cc/sxLfHdvH/Red-Pottery.png",
    "Ring Walkway": "https://i.postimg.cc/BQ8nL6Vr/Ring-Walkway.png",
    "Wood Pile": "https://i.postimg.cc/xTWTKQrc/Wood-Pile.png",
    "Yellow Umbrella": "https://i.postimg.cc/JzZ7xFmK/Yellow-Umbrella.png",
    "Honey Comb": "https://i.postimg.cc/XqJxFktM/image.png",
    "Bee Chair": "https://i.postimg.cc/HWZ6mF7T/image.png",
    "Honey Torch": "https://i.postimg.cc/0Qt08JjV/image.png",
    "Honey walkway": "https://i.postimg.cc/76XmfWsM/image.png",
    "Bee Crate": "https://i.postimg.cc/t4hdsc7Z/image.png",
    "Honey Crafters Crate": "https://i.postimg.cc/2yvvQNT2/image.png",
    "Oasis Crate": "https://i.postimg.cc/c1zXGTXS/image.png",
    "Boat Painting": "https://i.postimg.cc/bY52wB7m/Sailboat-Painting.png",
    "Palm Tree Painting": "https://i.postimg.cc/SxBBQkdm/image.png",
    "Sun Painting": "https://i.postimg.cc/vZr1XHcK/Sun-apinting.png",
    "Sun Carpet": "https://i.postimg.cc/SxBBQkdm/image.png",
    "Sun Throne": "https://i.postimg.cc/hGMXWy8b/Sun-Throne.png",
    "Surfer Statue": "https://i.postimg.cc/cCtC3dpX/Surfer-Statue.png",
    "Sun Gate": "https://i.postimg.cc/MTFXXnFn/Sun-Gate.png",
    "Iconic Gnome Crate": "https://i.postimg.cc/dtdXWzvX/image.png",
    "Summer Seed Pack": "https://i.postimg.cc/bv1z2bx5/image.png"
};

/* =======================
   STATE / LOCALSTORAGE
======================= */
const LS = {
  DARK: 'gg_dark',
  WATCH: 'gg_watch', // array of display names
  SIDEBAR: 'gg_sidebar_open',
  INFO_CACHE: 'gg_info_cache' // map of item_id -> {data, ts}
};

let watchSet = new Set(loadJSON(LS.WATCH, []));
let infoCache = loadJSON(LS.INFO_CACHE, {});
let latestStock = null; // store last stock payload
let firstLoadDone = false;

/* =======================
   UTILITIES
======================= */
function loadJSON(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key) ?? JSON.stringify(fallback)); }
  catch{ return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function timeAgo(sEpoch){
  if(!sEpoch) return '‚Äî';
  const now = Math.floor(Date.now()/1000);
  let diff = Math.max(0, now - Number(sEpoch));
  const units = [
    ['y', 365*24*3600],
    ['mo', 30*24*3600],
    ['w', 7*24*3600],
    ['d', 24*3600],
    ['h', 3600],
    ['m', 60],
    ['s', 1],
  ];
  for(const [u,sec] of units){
    if(diff >= sec) {
      const v = Math.floor(diff/sec);
      return `${v}${u} ago`;
    }
  }
  return 'just now';
}
function fmtPrice(p){ return (p==null || p==="") ? "‚Äî" : `${p}`; }

/* =======================
   THEME
======================= */
(function initTheme(){
  const dark = localStorage.getItem(LS.DARK) === 'true';
  document.documentElement.classList.toggle('dark', dark);
})();

document.getElementById('darkToggle').addEventListener('click', ()=>{
  const nowDark = !document.documentElement.classList.contains('dark');
  document.documentElement.classList.toggle('dark', nowDark);
  localStorage.setItem(LS.DARK, String(nowDark));
});

/* =======================
   SIDEBAR
======================= */
const sidebar = document.getElementById('sidebar');
const scrim = document.getElementById('scrim');

function openSidebar(){
  sidebar.classList.add('open');
  scrim.classList.add('show');
  sidebar.setAttribute('aria-hidden','false');
  localStorage.setItem(LS.SIDEBAR, 'true');
}
function closeSidebar(){
  sidebar.classList.remove('open');
  scrim.classList.remove('show');
  sidebar.setAttribute('aria-hidden','true');
  localStorage.setItem(LS.SIDEBAR, 'false');
}
document.getElementById('openSidebar').addEventListener('click', openSidebar);
document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
scrim.addEventListener('click', closeSidebar);

if(localStorage.getItem(LS.SIDEBAR)==='true'){ openSidebar(); }

/* =======================
   STOCK FETCH / RENDER
======================= */
const statusPill = document.getElementById('statusPill');
const updatedAt = document.getElementById('updatedAt');
const categoriesEl = document.getElementById('categories');

async function fetchJSON(url){
  const res = await fetch(url, { headers: { 'accept':'application/json', 'jstudio-key': API_KEY }});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function fetchStock(){
  try{
    statusPill.textContent = 'Loading‚Ä¶';
    const data = await fetchJSON(API_URL);
    latestStock = data;
    statusPill.textContent = 'Live';
    updatedAt.textContent = `Updated: ${new Date().toLocaleString()}`;
    renderAll(data);
    if(Notification.permission !== 'denied'){ Notification.requestPermission().catch(()=>{}); }
    if(!firstLoadDone){
      firstLoadDone = true;
      setTimeout(()=> document.getElementById('loading').remove(), 650); // fade out loading
    }
  }catch(err){
    console.error(err);
    statusPill.textContent = 'Error';
  }
}

function categorySpec(data){
  return [
    { key:'seed_stock',   title:'Seeds'     },
    { key:'gear_stock',   title:'Gears'     },
    { key:'egg_stock',    title:'Eggs'      },
    { key:'cosmetic_stock', title:'Cosmetics' },
    { key:'eventshop_stock', title:'Event Shop' },
  ].map(k => ({...k, items: (data[k.key] || [])}));
}

function ensureAccordion(card, body){
  // Smooth max-height animation
  const open = card.classList.contains('open');
  body.style.maxHeight = open ? (body.scrollHeight + 'px') : '0px';
}

function imgFor(displayName, apiIcon){
  return imageData[displayName] || apiIcon || '';
}

function renderAll(data){
  // Build category cards (accordion)
  categoriesEl.innerHTML = '';
  for(const cat of categorySpec(data)){
    const card = document.createElement('section');
    card.className = 'card fade-in';
    const header = document.createElement('div');
    header.className = 'card-header';
    header.innerHTML = `
      <h2>${cat.title}</h2>
      <div style="display:flex;align-items:center;gap:10px">
        <span class="badge">${cat.items.length}</span>
        <span class="chev">‚ñæ</span>
      </div>
    `;
    const body = document.createElement('div');
    body.className = 'card-body';
    const list = document.createElement('div');
    list.className = 'list';
    body.appendChild(list);
    card.appendChild(header);
    card.appendChild(body);
    categoriesEl.appendChild(card);

    // Start closed on small screens, open on desktop for first two sections
    if(window.innerWidth > 900 && ['Seeds','Gears'].includes(cat.title)) card.classList.add('open');
    ensureAccordion(card, body);

    header.addEventListener('click', ()=>{
      card.classList.toggle('open');
      ensureAccordion(card, body);
      if(card.classList.contains('open')){ // recalc height after images load
        setTimeout(()=> ensureAccordion(card, body), 60);
      }
    });

    // Render items
    for(const item of cat.items){
      const el = document.createElement('div');
      el.className = 'item';
      if(Number(item.quantity) === 0) el.classList.add('dim');

      const iconUrl = imgFor(item.display_name, item.icon);
      el.innerHTML = `
        <img src="${iconUrl}" alt="${item.display_name}">
        <div class="meta">
          <div class="name">${item.display_name}</div>
          <div class="sub" id="sub-${cat.key}-${item.item_id}">Price: ‚Ä¶</div>
        </div>
        <div class="qty" title="Amount in stock">√ó ${item.quantity}</div>
      `;
      list.appendChild(el);

      // Fill price asynchronously from /info/{id}
      fillPriceSub(cat.key, item).catch(()=>{});
    }
  }

  // Update sidebar chips + watchlist
  buildChips();
  renderWatchlist();
  // Trigger notifications for watched items
  notifyForWatched();
}

async function fillPriceSub(catKey, item){
  const sub = document.getElementById(`sub-${catKey}-${item.item_id}`);
  const info = await getItemInfo(item.item_id);
  sub.textContent = `Price: ${fmtPrice(info?.price)} ${info?.currency ?? ''}`.trim();
}

/* =======================
   ITEM INFO CACHE
======================= */
async function getItemInfo(item_id){
  const c = infoCache[item_id];
  const now = Date.now();
  if(c && (now - (c.ts||0)) < INFO_TTL_MS) return c.data;
  try{
    const data = await fetchJSON(API_INFO(item_id));
    infoCache[item_id] = { data, ts: now };
    saveJSON(LS.INFO_CACHE, infoCache);
    return data;
  }catch(e){
    return c?.data ?? null;
  }
}

/* =======================
   WATCHLIST (NOTIFICATIONS)
======================= */
const chipsWrap = document.getElementById('chips');
const watchlistWrap = document.getElementById('watchlist');

function buildChips(){
  // Build once per render, grouped by type
  chipsWrap.innerHTML = '';
  const groups = [
    {label:'Seeds', data: latestStock?.seed_stock ?? []},
    {label:'Gears', data: latestStock?.gear_stock ?? []},
    {label:'Eggs',  data: latestStock?.egg_stock ?? []},
  ];
  for(const g of groups){
    const h = document.createElement('div');
    h.style.margin = '8px 0 6px';
    h.innerHTML = `<div class="row-muted" style="font-weight:700">${g.label}</div>`;
    chipsWrap.appendChild(h);

    // unique by display_name (in case of dup entries)
    const seen = new Set();
    for(const it of g.data){
      if(seen.has(it.display_name)) continue;
      seen.add(it.display_name);

      const chip = document.createElement('label');
      chip.className = 'chip';
      chip.innerHTML = `
        <input type="checkbox" value="${it.display_name}">
        <img src="${imgFor(it.display_name, it.icon)}" alt="" width="20" height="20" style="border-radius:6px;object-fit:cover">
        <span>${it.display_name}</span>
      `;
      const cb = chip.querySelector('input');
      cb.checked = watchSet.has(it.display_name);
      cb.addEventListener('change', ()=>{
        if(cb.checked) watchSet.add(it.display_name); else watchSet.delete(it.display_name);
        saveJSON(LS.WATCH, [...watchSet]);
        renderWatchlist();
      });
      chipsWrap.appendChild(chip);
    }
  }
}

function findCurrentQty(displayName){
  if(!latestStock) return 0;
  const pools = [latestStock.seed_stock, latestStock.gear_stock, latestStock.egg_stock, latestStock.cosmetic_stock, latestStock.eventshop_stock]
    .filter(Boolean);
  for(const arr of pools){
    for(const it of arr){
      if(it.display_name === displayName) return Number(it.quantity) || 0;
    }
  }
  return 0;
}

function findItemId(displayName){
  const pools = [latestStock?.seed_stock, latestStock?.gear_stock, latestStock?.egg_stock, latestStock?.cosmetic_stock, latestStock?.eventshop_stock].filter(Boolean);
  for(const arr of pools){
    for(const it of arr){
      if(it.display_name === displayName) return it.item_id;
    }
  }
  // fallback guess: snake_case from name
  return displayName.toLowerCase().replace(/\s+/g,'_');
}

async function renderWatchlist(){
  watchlistWrap.innerHTML = '';
  const names = [...watchSet].sort((a,b)=>a.localeCompare(b));
  if(names.length === 0){
    watchlistWrap.innerHTML = `<div class="row-muted">No items selected yet.</div>`;
    return;
  }
  for(const name of names){
    const qty = findCurrentQty(name);
    const id = findItemId(name);
    const info = await getItemInfo(id);
    const icon = imgFor(name, info?.icon);

    const row = document.createElement('div');
    row.className = 'notif-row fade-in';
    row.innerHTML = `
      <img src="${icon}" alt="">
      <div>
        <div style="font-weight:700">${name}</div>
        <div class="ls">Last seen: ${timeAgo(info?.last_seen)}</div>
      </div>
      <div class="tick ${qty>0?'good':'bad'}" title="${qty>0?'In stock':'Not in stock'}">
        ${qty>0?'‚úì':'‚úó'}
      </div>
    `;
    watchlistWrap.appendChild(row);
  }
}

function canNotify(){
  return "Notification" in window && Notification.permission === "granted";
}

function notifyForWatched(){
  if(!latestStock || !("Notification" in window)) return;
  const now = Date.now();
  // Debounce by remembering what we already notified for in this cycle
  if(!notifyForWatched.seen){ notifyForWatched.seen = new Set(); }
  const seen = notifyForWatched.seen;

  const pools = [latestStock.seed_stock, latestStock.gear_stock, latestStock.egg_stock].filter(Boolean);
  for(const arr of pools){
    for(const it of arr){
      if(watchSet.has(it.display_name) && Number(it.quantity)>0){
        const key = `${it.display_name}@${it.start_date_unix||''}-${it.end_date_unix||''}-_
